{"entries":{"0":{"uid":0,"key":[],"keysecondary":[],"comment":"格式強化","content":"<RULE>\n在你的回答中，当你需要调用工具来执行操作时，你必须遵循以下严格的格式规则：\n\n1.  函数调用位置: 所有函数调用必须放置在 `<FuncCall>` 标签内\n2.  内部语法: `<FuncCall>` 内部必须使用 `<%% ... %%>` 格式包裹JavaScript函数调用语法。\n3.  字符串参数: JavaScript 调用中的所有字符串参数都必须使用单引号 `'` 包裹 (例如：`<%% some_tool('parameter_value', 123) %%>`)。\n4.  禁止空调用: 严禁出现空的 `<%%>` 或 `<%%%%>` 这样的空白调用，以及非法格式，如`<@ ... @>`、`<: ... :>`、`<| ... |>`、`<* ... *>`、`<$ ... $>`、`<-- ... -->`等。\n5.  禁止XML格式: 绝对不允许使用XML格式的调用 (例如：`<tool_name parameter=\"value\" />`)。\n6.  变量域限定: 此函数调用格式仅适用于 'bs' 变量域的函数，包括所有以 'bs' 开头的函数（如 bsPassedTime、bsUpdateCharacterStatus 等）。\n\n示例场景:\n如果用户问：\"北京今天天气怎么样？\"\n你的回答必须包含：\n\"好的，我来帮您查询北京的天气。\"\n<FuncCall>\n<%% get_weather('beijing') %%>\n</FuncCall>\n\"以上是北京的天气信息。\"\n\n</RULE>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":101,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":1,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"displayIndex":1,"triggers":[],"ignoreBudget":false,"outletName":"","characterFilter":{"isExclude":false,"names":[],"tags":[]}},"1":{"uid":1,"key":[],"keysecondary":[],"comment":"函数声明_首","content":"<BSTool>\n以下是可供调用的函数，它们能帮助你模拟和控制角色在故事情节中的背景设定、生理状态和时间流逝：\n\n优先级说明：\n- P0 (最高优先级): 时间流逝函数 - 必须准确使用，避免计时错误\n- P1 (高优先级): 核心状态函数 - 角色基础状态管理\n- P2 (中优先级): 特殊功能函数 - 特定场景使用\n- P3 (低优先级): 高级配置函数 - 背景设定使用\n- P4 (最低优先级): 特殊场景函数\n\n重要提示：\n所有函数调用必须放置在 `<FuncCall>` 标签内，不得出现在其他位置，且该标签必须位于 `<statustext>` 标签的开始位置。\n所有函数调用必须严格遵守 `<%%_ function(arg1, arg2, ...) _%%>` 格式，一对标签内只能调用一个函数，多次调用需要创建多对标签。\n不允许在函数调用时使用任何形式的注释，仅能直接调用。\n不允许输出任何单独的`<%%`或者`%%>`标签，不允许出现`<%%>`、`<%%%%>`、`<: ... :>`、`<@ ... @>`、<bsAddSperm female=...>等异形标签。\n通常來說，`{{char_name}}` 代表当前的主要女性角色，`{{user_name}}` 代表用户控制的男性角色。请根据上下文替换为实际的角色名称。\n---\n**函数定义：**","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":103,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":1,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"characterFilterNames":[],"characterFilterTags":[],"characterFilterExclude":false,"displayIndex":5,"triggers":[],"ignoreBudget":false,"outletName":"","characterFilter":{"isExclude":false,"names":[],"tags":[]}},"2":{"uid":2,"key":[],"keysecondary":[],"comment":"輸出規範(可依需求增減欄位，但不可移除標籤對)","content":"<%\nconst pregnancyStages = ['孕早期','孕中期','孕晚期','临产期','逾期'];\nconst laborStages = ['第一产程','第二产程','第三产程'];\nconst pregnantChars = [];\nconst nonPregnantChars = [];\nif (this.variables?.bs) {\n    for (let char in this.variables.bs) {\n        if (char && char !== 'global' && this.variables.bs[char] && this.variables.bs[char] !== null) {\n            const stage = this.variables.bs[char].stage;\n            const fetuses = this.variables.bs[char].fetuses || 0;\n            const isPregnant = pregnancyStages.includes(stage) || stage === '产前阵痛' || laborStages.includes(stage) || stage === '已受精';\n            if (isPregnant && fetuses > 0) { pregnantChars.push(char); } \n            else { nonPregnantChars.push(char); }\n        }\n    }\n}\n-%>\n<status_format_example>\n绝对规则:\n- statustext是最後必定輸出的文本，若上下文有其他的狀態欄規則，也必須遵守並輸出\n- 其输出必须严格遵循XML格式，以<statustext>开始，以</statustext>结束\n- 所有函数调用必须放置在<FuncCall>标签内，且该标签必须位于</statustextThink>标签的之後的位置\n- 每个女性角色必须包含完整的标签对\n- 身高和體重輸出數字+單位; 腰臀圍是數字，而胸圍是數字(罩杯)，禁止輸出文字形容詞\n- 懷孕後須反映出體重與三圍的增幅，數值隨孕期逐漸增加，分娩時當胎兒們出生後腰圍瞬間降低\n- <character>仅在該角色在場景时输出\n- 描述性文本(含{description})必须基于角色的实际生理状态，嚴禁輸出N/A\n<% if (pregnantChars.length > 0 || nonPregnantChars.length > 0) { -%>\n- <REP>下的欄位項目用於妊娠與分娩，<% if (pregnantChars.length > 0) { %>已怀孕角色: <%- pregnantChars.join('、') %> 必须输出详细内容<% } %><% if (pregnantChars.length > 0 && nonPregnantChars.length > 0) { %>; <% } %><% if (nonPregnantChars.length > 0) { %>未怀孕角色: <%- nonPregnantChars.join('、') %> 输出N/A<% } %>\n<% } -%>\n- 使用前文所提及的時間格式，若無默認yyyy-MM-dd HH:mm\n- 使用前文所提及的地點格式，若無默認大場所 - 小區域\n- 若故事發生在現代寫實，种族只輸出人類\n- 若主控角色是女性，也需輸出其<character>文本，不能輸出未知\n- 可閱讀<BS_EmoPrompt>、<BS_StatusPrompt>標籤對裡的內文，了解角色狀態\n格式模板：\n<statustext>\n<statustextThink>\n1.輸出在場角色的月經/妊娠/分娩階段\n2.輸出當前場景所經過的時間\n3.輸出準備調用的函數名與原因\n4.輸出符合當前妊娠/分娩階段的内容\n5.輸出符合當前<BS_EmoPrompt>的内容\n</statustextThink>\n<FuncCall>\n// 在这里放置所有函数调用\n</FuncCall>\n  <time>{time}</time>\n  <location>{location}</location>\n  <character>\n  <namestr>{char}</namestr>\n    <APP>\n      种族|{race}\n      年龄|{age}\n      身高|{height}\n      体重|{weight} \n      三围|{bust}/{waist}/{hip}\n    </APP>\n    <PHY>\n      状态|{角色的总体状态，基于活力/性欲/情压/宫压等综合描述}\n      意图|{角色當前想要做的事}\n      胸部|{description，可含行動的晃動幅度; 孕後包含泌乳敘述}\n      腹部|{description，可含傳出的聲音; 孕後包含胎動}\n      臀部|{description，可含腿部; 孕後可含行動受限}\n      小穴|{description}\n      菊穴|{description}\n      症状|{月经、妊娠、分娩于角色上的影响}\n      特质|{非典型身體性質}\n    </PHY>\n    <REP>\n      空間|{子宫、羊膜、羊水的综合状态描述}\n      供养|{胎盘、卵黄或其他供养源的状态描述}\n      胎況|{胎位、体型大小、健康状况等}\n      动作|{宫内位置 + 动作种类 + 胎动情况 + 多胎互动}\n      反应|{对外界刺激反应 + 心情(可使用emoji象徵) + 空间感知 + 对母体行为反应與亲和度}\n    </REP>\n  </character>\n</statustext>\n\n</status_format_example>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":400,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"displayIndex":8,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"triggers":[],"ignoreBudget":false,"outletName":"","characterFilter":{"isExclude":false,"names":[],"tags":[]}},"3":{"uid":3,"key":[],"keysecondary":[],"comment":"函数声明_尾","content":"---\n使用建议：\n优先使用时间流逝函数：任何状态变化都应该通过 `bsPassedTime()` 来推进\n避免手动设置时间相关状态：除非是初始设定，否则让系统自动计算\n检查函数优先级：P0 > P1 > P2 > P3 > P4，优先使用高优先级函数\n组合使用：时间流逝 + 状态更新(不限於一種)是最佳实践\n\n</BSTool> ","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":106,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":1,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"characterFilterNames":[],"characterFilterTags":[],"characterFilterExclude":false,"displayIndex":2,"ignoreBudget":false,"outletName":"","characterFilter":{"isExclude":false,"names":[],"tags":[]}},"4":{"uid":4,"key":[],"keysecondary":[],"comment":"主系統代碼","content":"@@always_enabled\n@@only_preload\n@@generate_before\n<%_\n// 全局叙事选项初始化函数\ndefine('bsInitGlobalSettings', function() {\n    this.setvar('bs.global.enableMonsterOBGYN', true, { flags: 'nx' });\n    this.setvar('bs.global.enableChildRecord', true, { flags: 'nx' });\n    this.setvar('bs.global.enableSexExperience', true, { flags: 'nx' });\n    this.setvar('bs.global.enablePregnantEmotion', true, { flags: 'nx' });\n    this.setvar('bs.global.activeRaces', [], { flags: 'nx' });\n    this.setvar('bs.global.activeZygoteTypes', [], { flags: 'nx' });\n    this.setvar('bs.global.activeEmbryoTypes', [], { flags: 'nx' });\n});\n\ndefine('bsMenstrualStage', ['卵泡期','排卵期','黄体期','月经期']);\ndefine('bsPregnancyStage', ['孕早期','孕中期','孕晚期','临产期','逾期']);\ndefine('bsLaborStage', ['第一产程','第二产程','第三产程']);\n\n// 辅助函数：检查是否应该重置orgasmOvulationUsed\ndefine('bsShouldResetOrgasmOvulation', function(stage) {\n    // 只在月经期、孕早期、产后恢复时重置\n    return stage === '月经期' || stage === '孕早期' || stage === '产后恢复';\n});\n\n// 辅助函数：智能设置orgasmOvulationUsed\ndefine('bsSetStageWithOrgasmOvulation', function(char, stage, options = {}) {\n    const shouldReset = this.bsShouldResetOrgasmOvulation(stage);\n    const orgasmOvulationUsed = shouldReset ? false : this.getvar(`bs.${char}.orgasmOvulationUsed`, { defaults: false });\n    \n    this.setvar(`bs.${char}`, { \n        stage, \n        orgasmOvulationUsed,\n        ...options \n    }, { merge: true });\n});\n\nconst pregnancyStageDays = {\n    '孕早期': 84,\n    '孕中期': 105,\n    '孕晚期': 63,\n    '临产期': 28\n};\nconst menstrualStageDays = {\n    '卵泡期': 9,\n    '排卵期': 2,\n    '黄体期': 12,\n    '月经期': 5\n};\nconst laborStageBaseHours={\n    '第一产程': 12,\n    '第二产程': 2,\n    '第三产程': 0.5\n};\nconst laborStageIncrement={\n    '第一产程': 1.5,\n    '第二产程': 2,\n    '第三产程': 0.5\n};\n\ndefine('bsNotifyCycle', function(female, forced = false) {\n    if(this.variables?.bs?.[female] === null) return;\n    const stage = this.getvar(`bs.${female}.stage`);\n    const days = this.getvar(`bs.${female}.days`, { defaults: 1 });\n    const notifySecondary = this.getvar(`bs.${female}.notifySecondary`);\n    // 检查是否有notifySecondary，如果有则移动到notify\n    if(notifySecondary) {\n        this.setvar(`bs.${female}.notify`, notifySecondary);\n        this.setvar(`bs.${female}.notifySecondary`, null);\n        return;\n    }\n    \n    if(stage === '产前阵痛') {\n        this.setvar(`bs.${female}.notify`, `${female}马上就要生了`);\n    } else if(forced || days === 1) {\n        if(bsMenstrualStage.includes(stage) || bsPregnancyStage.includes(stage) || bsLaborStage.includes(stage)) {\n            this.setvar(`bs.${female}.notify`, `${female}进入了${stage}`);\n        }\n    } else {\n        this.setvar(`bs.${female}.notify`, null);\n    }\n});\n\ndefine('bsInitFemale', function(female) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    \n    // 初始化全局设置（只在第一次调用时生效）\n    this.bsInitGlobalSettings();\n    \n    // 随机选择阶段\n    const randomStage = _.sample(bsMenstrualStage);\n    \n    // 根据阶段随机生成天数，但不超过该阶段的最大天数\n    const maxDays = menstrualStageDays[randomStage];\n    const randomDays = _.random(1, maxDays);\n    \n    // 生理状态参数\n    this.setvar(`bs.${female}.days`, randomDays, { flags: 'nx' });\n    this.setvar(`bs.${female}.stage`, randomStage, { flags: 'nx' });\n    this.setvar(`bs.${female}.isHere`, true, { flags: 'nx' });\n    this.setvar(`bs.${female}.race`, null, { flags: 'nx' });\n    this.setvar(`bs.${female}.derivedType`, null, { flags: 'nx' });\n    this.setvar(`bs.${female}.sperms`, [], { flags: 'nx' });\n    this.setvar(`bs.${female}.eggs`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.libido`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.vitality`, 100, { flags: 'nx' });\n    this.setvar(`bs.${female}.uterinePressure`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.psyStress`, 50, { flags: 'nx' });\n    // 冷卻\n    this.setvar(`bs.${female}.orgasmOvulationUsed`, false, { flags: 'nx' });\n    this.setvar(`bs.${female}.affinityAdjustmentUsed`, false, { flags: 'nx' });\n    this.setvar(`bs.${female}.emotionalUpdateUsed`, false, { flags: 'nx' });\n    // 妊娠状态参数\n    this.setvar(`bs.${female}.pregnantDays`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.laborHours`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.fetalEnergyDrain`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.pregnant`, [], { flags: 'nx' });\n    this.setvar(`bs.${female}.twinCounter`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.fetuses`, 0, { flags: 'nx' });\n    // 生理隐藏参数\n    this.setvar(`bs.${female}.menstrualFluctuationDays`, 1, { flags: 'nx' });\n    this.setvar(`bs.${female}.menstrualLengthRatio`, 1.0, { flags: 'nx' });\n    this.setvar(`bs.${female}.gestationSpeed`, 1.0, { flags: 'nx' });\n    this.setvar(`bs.${female}.birthDifficulty`, 1.0, { flags: 'nx' });\n    this.setvar(`bs.${female}.breedTolerance`, 1.0, { flags: 'nx' });\n    this.setvar(`bs.${female}.recoveryDays`, 56, { flags: 'nx' });\n    this.setvar(`bs.${female}.impregnationDifficulty`, 1.0, { flags: 'nx' });\n    this.setvar(`bs.${female}.orgasmOvulationAmount`, 1, { flags: 'nx' });\n    this.setvar(`bs.${female}.identicalProbability`, 5, { flags: 'nx' });\n    this.setvar(`bs.${female}.semiIdenticalProbability`, 15, { flags: 'nx' });\n    this.setvar(`bs.${female}.earlyFusionProbability`, 15, { flags: 'nx' });\n    this.setvar(`bs.${female}.sharedMembraneProbability`, 25, { flags: 'nx' });\n    this.setvar(`bs.${female}.superfetationProbability`, 1, { flags: 'nx' });\n    this.setvar(`bs.${female}.polyploidyProbability`, 0, { flags: 'nx' });\n    // 情感与性经验\n    this.setvar(`bs.${female}.virginity`, null, { flags: 'nx' });\n    this.setvar(`bs.${female}.mate`, null, { flags: 'nx' });\n    this.setvar(`bs.${female}.latestSexPartner`, null, { flags: 'nx' });\n    this.setvar(`bs.${female}.relationshipExperience`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.pregnantExperience`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.birthExperience`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.miscarriageExperience`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.child`, [], { flags: 'nx' });\n    // 妊娠心情指标\n    this.setvar(`bs.${female}.pregnancyAwareness`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.pregnancyAcceptance`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.pregnancyDisplay`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.pregnancyConfidence`, 0, { flags: 'nx' });\n    // 代謝物\n    this.setvar(`bs.${female}.urine`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.stool`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.hunger`, 0, { flags: 'nx' });\n    this.setvar(`bs.${female}.sleep`, 0, { flags: 'nx' });\n    // 免疫状态\n    this.setvar(`bs.${female}.abortionImmune`, false, { flags: 'nx' });\n    this.setvar(`bs.${female}.drainImmune`, false, { flags: 'nx' });\n    this.setvar(`bs.${female}.pseudopregnancyImmune`, false, { flags: 'nx' });\n    this.setvar(`bs.${female}.metabolismImmune`, false, { flags: 'nx' });\n\n    this.setvar(`bs.${female}.notify`, null, { flags: 'nx' });\n    this.setvar(`bs.${female}.notifySecondary`, null, { flags: 'nx' });\n    this.setvar(`bs.${female}.notifyTertiary`, null, { flags: 'nx' }); // 用于代谢物系统\n\n    console.log(`runID: ${runID}`);\n    console.log(`locals.runID: ${locals.runID}`);\n    console.log(`this.runID: ${this.runID}`);\n});\n\ndefine('bsUpdateExperience', function(female, options = {}) {\n    if (!female || this.variables?.bs?.[female] == null) return;\n    this.bsInitFemale(female);\n    // 只允许这些字段被更新\n    const allowed = [\n        'virginity',\n        'mate',\n        'latestSexPartner',\n        'relationshipExperience',\n        'pregnantExperience',\n        'birthExperience',\n        'miscarriageExperience'\n    ];\n  \n    for (const key of allowed) {\n        if (options[key] !== undefined) {\n            this.setvar(`bs.${female}.${key}`, options[key]);\n        }\n    }\n});\n\ndefine('bsUpdatePhysiologyProfile', function(female, options = {}) {\n    if (!female || this.variables?.bs?.[female] == null) return;\n    this.bsInitFemale(female);\n  \n    const allowed = [\n        'menstrualFluctuationDays',\n        'menstrualLengthRatio',\n        'gestationSpeed',\n        'birthDifficulty',\n        'orgasmOvulationAmount',\n        'impregnationDifficulty',\n        'identicalProbability',\n        'semiIdenticalProbability',\n        'earlyFusionProbability',\n        'sharedMembraneProbability',\n        'superfetationProbability',\n        'polyploidyProbability',\n        'breedTolerance',\n        'recoveryDays',\n\n    ];\n  \n    for (const key of allowed) {\n        if (options[key] !== undefined) {\n            this.setvar(`bs.${female}.${key}`, options[key]);\n        }\n    }\n});\n\n// 設置角色種族生理參數\ndefine('bsSetRacePhysiologyProfile', function(female, race) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n\n    // 處理後天種族標籤，格式：[後天]先天\n    let actualRace = race;\n    let derivedType = null;\n    \n    // 檢查是否包含後天標籤\n    const derivedMatch = race.match(/^\\[([^\\]]+)\\](.+)$/);\n    if(derivedMatch) {\n        derivedType = derivedMatch[1];  // 後天類型\n        actualRace = derivedMatch[2];    // 先天種族\n        console.log(`Detected derived race: ${derivedType} -> ${actualRace}`);\n    }\n    \n    // 處理子類物種，格式：主種族-子類\n    const subRaceMatch = actualRace.match(/^(.+?)-(.+)$/);\n    if(subRaceMatch) {\n        const mainRace = subRaceMatch[1];  // 主種族\n        const subRace = subRaceMatch[2];   // 子類\n        console.log(`Detected sub-race: ${subRace} of ${mainRace}`);\n        \n        // 如果主種族存在，使用主種族的生理參數\n        if(bsRacePhysiologyProfiles[mainRace]) {\n            actualRace = mainRace;\n            console.log(`Using main race physiology: ${mainRace}`);\n        }\n    }\n    \n    // 處理混血種族，格式：種族1x種族2x種族3 (大小x皆可)\n    let raceProfile;\n    const hybridMatch = actualRace.match(/^(.+?)[xX](.+)$/);\n    if(hybridMatch) {\n        const raceComponents = actualRace.split(/[xX]/);\n        console.log(`Detected hybrid race: ${raceComponents.join(' x ')}`);\n        \n        // 計算混血種族的平均參數\n        raceProfile = this.bsCalculateHybridProfile(raceComponents);\n        this.setvar(`bs.${female}.race`, actualRace);\n    } else {\n        // 檢查單一種族是否存在，不存在就使用人類生理參數但保持原始種族名稱\n        if(!bsRacePhysiologyProfiles[actualRace]) {\n            console.log(`Unknown race: ${actualRace} for ${female}, using human physiology parameters but keeping original race name`);\n            raceProfile = bsRacePhysiologyProfiles['人类'];\n        } else {\n            raceProfile = bsRacePhysiologyProfiles[actualRace];\n        }\n        \n        this.setvar(`bs.${female}.race`, actualRace);\n    }\n    \n    this.bsUpdatePhysiologyProfile(female, raceProfile);\n    \n    // 如果有後天類型，也記錄下來\n    if(derivedType) {\n        this.setvar(`bs.${female}.derivedType`, derivedType);\n        console.log(`Set race for ${female} to ${actualRace} (derived: ${derivedType}) with physiology profile:`, raceProfile);\n    } else {\n        console.log(`Set race for ${female} to ${actualRace} with physiology profile:`, raceProfile);\n    }\n    \n    // 更新全域种族统计\n    this.bsUpdateGlobalRaceAndTypes();\n});\n\n// 計算混血種族的平均參數\ndefine('bsCalculateHybridProfile', function(raceComponents) {\n    const validProfiles = [];\n    const invalidRaces = [];\n    \n    // 收集有效的種族配置\n    for(const component of raceComponents) {\n        const trimmedComponent = component.trim();\n        if(bsRacePhysiologyProfiles[trimmedComponent]) {\n            validProfiles.push(bsRacePhysiologyProfiles[trimmedComponent]);\n        } else {\n            invalidRaces.push(trimmedComponent);\n            console.log(`Unknown race component: ${trimmedComponent}, skipping`);\n        }\n    }\n    \n    // 如果沒有有效配置，使用人類\n    if(validProfiles.length === 0) {\n        console.log('No valid race components found, using human profile');\n        return bsRacePhysiologyProfiles['人类'];\n    }\n    \n    // 如果只有一個有效配置，直接返回\n    if(validProfiles.length === 1) {\n        return validProfiles[0];\n    }\n    \n    // 計算平均參數\n    const averageProfile = {};\n    const parameterKeys = Object.keys(validProfiles[0]);\n    \n    for(const key of parameterKeys) {\n        const values = validProfiles.map(profile => profile[key]);\n        const sum = values.reduce((acc, val) => acc + val, 0);\n        averageProfile[key] = sum / values.length;\n    }\n    \n    console.log(`Calculated hybrid profile from ${validProfiles.length} races:`, averageProfile);\n    return averageProfile;\n});\n\n// 根據胎兒種族計算平均生理參數\ndefine('bsCalculateFetusBasedProfile', function(female) {\n    const pregnant = this.getvar(`bs.${female}.pregnant`, { defaults: [] });\n    \n    if(pregnant.length === 0) {\n        console.log(`No fetuses found for ${female}`);\n        return null;\n    }\n    \n    const validProfiles = [];\n    \n    for(const fetus of pregnant) {\n        let fetusRace = fetus.race;\n        \n        // 處理後天種族標籤，格式：[後天]先天\n        const derivedMatch = fetusRace.match(/^\\[([^\\]]+)\\](.+)$/);\n        if(derivedMatch) {\n            fetusRace = derivedMatch[2];  // 只取先天種族\n            console.log(`Fetus race has derived tag, using base race: ${fetusRace}`);\n        }\n        \n        // 處理子類物種，格式：主種族-子類\n        const subRaceMatch = fetusRace.match(/^(.+?)-(.+)$/);\n        if(subRaceMatch) {\n            const mainRace = subRaceMatch[1];  // 主種族\n            const subRace = subRaceMatch[2];   // 子類\n            console.log(`Fetus race has sub-race: ${subRace} of ${mainRace}`);\n            \n            // 如果主種族存在，使用主種族的生理參數\n            if(bsRacePhysiologyProfiles[mainRace]) {\n                fetusRace = mainRace;\n                console.log(`Using main race for fetus: ${mainRace}`);\n            }\n        }\n        \n        if(bsRacePhysiologyProfiles[fetusRace]) {\n            validProfiles.push(bsRacePhysiologyProfiles[fetusRace]);\n        } else {\n            // 檢查是否為混血種族，如果是，嘗試使用已知的種族組件\n            const hybridMatch = fetusRace.match(/^(.+?)[xX](.+)$/);\n            if(hybridMatch) {\n                const raceComponents = fetusRace.split(/[xX]/).map(race => race.trim());\n                console.log(`Unknown hybrid fetus race: ${fetusRace} for ${female}, checking components: ${raceComponents.join(', ')}`);\n                \n                // 找到第一個已知的種族組件\n                let foundKnownRace = null;\n                for(const component of raceComponents) {\n                    if(bsRacePhysiologyProfiles[component]) {\n                        foundKnownRace = component;\n                        console.log(`Found known race component: ${component} for fetus race: ${fetusRace}`);\n                        break;\n                    }\n                }\n                \n                if(foundKnownRace) {\n                    validProfiles.push(bsRacePhysiologyProfiles[foundKnownRace]);\n                } else {\n                    console.log(`No known race components found for ${fetusRace}, using human parameters`);\n                    validProfiles.push(bsRacePhysiologyProfiles['人类']);\n                }\n            } else {\n                console.log(`Unknown fetus race: ${fetusRace} for ${female}, using human parameters`);\n                validProfiles.push(bsRacePhysiologyProfiles['人类']);\n            }\n        }\n    }\n    \n    if(validProfiles.length === 0) {\n        return null;\n    }\n    \n    if(validProfiles.length === 1) {\n        return validProfiles[0];\n    }\n    \n    // 計算平均參數\n    const averageProfile = {};\n    const parameterKeys = Object.keys(validProfiles[0]);\n    \n    for(const key of parameterKeys) {\n        const values = validProfiles.map(profile => profile[key]);\n        const sum = values.reduce((acc, val) => acc + val, 0);\n        averageProfile[key] = sum / values.length;\n    }\n    \n    console.log(`Calculated fetus-based profile for ${female}:`, averageProfile);\n    return averageProfile;\n});\n\n// 更新懷孕角色的生理參數（根據胎兒種族）\ndefine('bsUpdatePregnancyPhysiology', function(female) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    \n    const stage = this.getvar(`bs.${female}.stage`);\n    const isPregnant = bsPregnancyStage.includes(stage) || stage === '假孕期' || stage === '产前阵痛' || bsLaborStage.includes(stage);\n    \n    if(!isPregnant) {\n        console.log(`${female} is not pregnant, skipping pregnancy physiology update`);\n        return;\n    }\n    \n    // 根據胎兒種族計算新的參數\n    const fetusProfile = this.bsCalculateFetusBasedProfile(female);\n    \n    if(fetusProfile) {\n        // 更新 gestationSpeed, birthDifficulty 和 breedTolerance\n        this.setvar(`bs.${female}.gestationSpeed`, fetusProfile.gestationSpeed);\n        this.setvar(`bs.${female}.birthDifficulty`, fetusProfile.birthDifficulty);\n        \n        // 计算并存储产后恢复天数\n        const recoveryDays = this.bsCalculateRecoveryDays(female);\n        this.setvar(`bs.${female}.recoveryDays`, recoveryDays);\n        \n        console.log(`Updated pregnancy physiology for ${female}: gestationSpeed=${fetusProfile.gestationSpeed}, birthDifficulty=${fetusProfile.birthDifficulty}, recoveryDays=${recoveryDays}`);\n    }\n});\n\n// 恢復角色原始生理參數 (結束妊娠後)\ndefine('bsRestoreOriginalPhysiology', function(female) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    \n    // 獲取角色種族\n    const race = this.getvar(`bs.${female}.race`, { defaults: '人类' });\n    \n    // 處理後天種族標籤，格式：[後天]先天\n    let actualRace = race;\n    const derivedMatch = race.match(/^\\[([^\\]]+)\\](.+)$/);\n    if(derivedMatch) {\n        actualRace = derivedMatch[2];  // 只取先天種族\n        console.log(`Restoring physiology for derived race: ${race} -> ${actualRace}`);\n    }\n    \n    // 處理子類物種，格式：主種族-子類\n    const subRaceMatch = actualRace.match(/^(.+?)-(.+)$/);\n    if(subRaceMatch) {\n        const mainRace = subRaceMatch[1];  // 主種族\n        const subRace = subRaceMatch[2];   // 子類\n        console.log(`Detected sub-race for restoration: ${subRace} of ${mainRace}`);\n        \n        // 如果主種族存在，使用主種族的生理參數\n        if(bsRacePhysiologyProfiles[mainRace]) {\n            actualRace = mainRace;\n            console.log(`Using main race physiology for restoration: ${mainRace}`);\n        }\n    }\n    \n    // 處理混血種族，格式：種族1x種族2x種族3\n    let raceProfile;\n    const hybridMatch = actualRace.match(/^(.+?)[xX](.+)$/);\n    if(hybridMatch) {\n        const raceComponents = actualRace.split(/[xX]/);\n        raceProfile = this.bsCalculateHybridProfile(raceComponents);\n    } else {\n        // 檢查單一種族是否存在，不存在就使用人類生理參數但保持原始種族名稱\n        if(!bsRacePhysiologyProfiles[actualRace]) {\n            console.log(`Unknown race: ${actualRace} for ${female}, using human physiology parameters but keeping original race name`);\n            raceProfile = bsRacePhysiologyProfiles['人类'];\n        } else {\n            raceProfile = bsRacePhysiologyProfiles[actualRace];\n        }\n    }\n    \n    // 恢復原始參數\n    this.setvar(`bs.${female}.gestationSpeed`, raceProfile.gestationSpeed);\n    this.setvar(`bs.${female}.birthDifficulty`, raceProfile.birthDifficulty);\n    \n    // 计算并存储产后恢复天数\n    const recoveryDays = this.bsCalculateRecoveryDays(female);\n    this.setvar(`bs.${female}.recoveryDays`, recoveryDays);\n    \n    console.log(`Restored original physiology for ${female} (${race}): gestationSpeed=${raceProfile.gestationSpeed}, birthDifficulty=${raceProfile.birthDifficulty}, recoveryDays=${recoveryDays}`);\n});\n\n// 計算胎兒胚胎類型\ndefine('bsCalculateFetusEmbryoType', function(fetusRace) {\n    // 處理後天種族標籤，格式：[後天]先天\n    let actualRace = fetusRace;\n    const derivedMatch = fetusRace.match(/^\\[([^\\]]+)\\](.+)$/);\n    if(derivedMatch) {\n        actualRace = derivedMatch[2];  // 只取先天種族\n        console.log(`Fetus race has derived tag, using base race for embryo type: ${actualRace}`);\n    }\n    \n    // 處理子類物種，格式：主種族-子類\n    const subRaceMatch = actualRace.match(/^(.+?)-(.+)$/);\n    if(subRaceMatch) {\n        const mainRace = subRaceMatch[1];  // 主種族\n        const subRace = subRaceMatch[2];   // 子類\n        console.log(`Fetus race has sub-race for embryo type: ${subRace} of ${mainRace}`);\n        \n        // 如果主種族存在，使用主種族\n        if(bsRacePhysiologyProfiles[mainRace]) {\n            actualRace = mainRace;\n            console.log(`Using main race for embryo type: ${mainRace}`);\n        }\n    }\n    \n    // 處理混血種族，格式：種族1x種族2x種族3\n    const hybridMatch = actualRace.match(/^(.+?)[xX](.+)$/);\n    if(hybridMatch) {\n        const raceComponents = actualRace.split(/[xX]/).map(race => race.trim());\n        console.log(`Calculating embryo type for hybrid race: ${raceComponents.join(' x ')}`);\n        \n        // 找到gestationSpeed最小的已知種族\n        let minGestationSpeed = Infinity;\n        let dominantRace = null;\n        \n        for(const component of raceComponents) {\n            if(bsRacePhysiologyProfiles[component]) {\n                const gestationSpeed = bsRacePhysiologyProfiles[component].gestationSpeed;\n                if(gestationSpeed < minGestationSpeed) {\n                    minGestationSpeed = gestationSpeed;\n                    dominantRace = component;\n                }\n            }\n        }\n        \n        // 如果沒有找到已知種族，使用第一個組件\n        if(!dominantRace) {\n            dominantRace = raceComponents[0];\n            console.log(`No known race components found for hybrid race: ${actualRace}, using first component: ${dominantRace}`);\n        }\n        \n        console.log(`Dominant race for embryo type: ${dominantRace} (gestationSpeed: ${minGestationSpeed})`);\n        actualRace = dominantRace;\n    }\n    \n    // 根據種族確定胚胎類型，找不到預設胎生\n    if(viviparousRace.includes(actualRace)) {\n        return '胎生';\n    } else if(oviparousRace.includes(actualRace)) {\n        return '卵生';\n    } else if(ovoviviparousRace.includes(actualRace)) {\n        return '卵胎生';\n    } else if(metoviviparousRace.includes(actualRace)) {\n        return '胎转卵生';\n    } else if(amorphousRace.includes(actualRace)) {\n        return '不定型';\n    } else {\n        console.log(`Unknown race for embryo type: ${actualRace}, defaulting to viviparous`);\n        return '胎生';\n    }\n});\n\n// 計算胎兒種族（忽略後天種族標籤，去重）\ndefine('bsCalculateFetusRace', function(female, male) {\n    // 獲取母親種族\n    const femaleRace = this.getvar(`bs.${female}.race`, { defaults: '人类' });\n    \n    // 從女性宮內精子中查找男性種族，找不到則默認取母親種族（純血）\n    let maleRace = femaleRace; // 默認為母親種族\n    const sperms = this.getvar(`bs.${female}.sperms`, { defaults: [] });\n    const maleSperm = sperms.find(sperm => sperm.male === male);\n    if (maleSperm && maleSperm.race) {\n        maleRace = maleSperm.race;\n        console.log(`Found male race from sperm: ${male} -> ${maleRace}`);\n    } else {\n        console.log(`Male race not found in sperm, using mother's race (pure blood): ${male} -> ${maleRace}`);\n    }\n    \n    // 處理後天種族標籤，格式：[後天]先天\n    let actualFemaleRace = femaleRace;\n    let actualMaleRace = maleRace;\n    \n    const femaleDerivedMatch = femaleRace.match(/^\\[([^\\]]+)\\](.+)$/);\n    if(femaleDerivedMatch) {\n        actualFemaleRace = femaleDerivedMatch[2];  // 只取先天種族\n        console.log(`Female race has derived tag: ${femaleRace} -> ${actualFemaleRace}`);\n    }\n    \n    const maleDerivedMatch = maleRace.match(/^\\[([^\\]]+)\\](.+)$/);\n    if(maleDerivedMatch) {\n        actualMaleRace = maleDerivedMatch[2];  // 只取先天種族\n        console.log(`Male race has derived tag: ${maleRace} -> ${actualMaleRace}`);\n    }\n    \n    // 處理子類物種，格式：主種族-子類\n    const femaleSubRaceMatch = actualFemaleRace.match(/^(.+?)-(.+)$/);\n    if(femaleSubRaceMatch) {\n        const mainRace = femaleSubRaceMatch[1];  // 主種族\n        const subRace = femaleSubRaceMatch[2];   // 子類\n        console.log(`Female race has sub-race: ${subRace} of ${mainRace}`);\n        \n        // 如果主種族存在，使用主種族\n        if(bsRacePhysiologyProfiles[mainRace]) {\n            actualFemaleRace = mainRace;\n            console.log(`Using main race for female: ${mainRace}`);\n        }\n    }\n    \n    const maleSubRaceMatch = actualMaleRace.match(/^(.+?)-(.+)$/);\n    if(maleSubRaceMatch) {\n        const mainRace = maleSubRaceMatch[1];  // 主種族\n        const subRace = maleSubRaceMatch[2];   // 子類\n        console.log(`Male race has sub-race: ${subRace} of ${mainRace}`);\n        \n        // 如果主種族存在，使用主種族\n        if(bsRacePhysiologyProfiles[mainRace]) {\n            actualMaleRace = mainRace;\n            console.log(`Using main race for male: ${mainRace}`);\n        }\n    }\n    \n    // 處理混血種族，格式：種族1x種族2x種族3\n    let femaleRaces = [];\n    let maleRaces = [];\n    \n    const femaleHybridMatch = actualFemaleRace.match(/^(.+?)[xX](.+)$/);\n    if(femaleHybridMatch) {\n        femaleRaces = actualFemaleRace.split(/[xX]/).map(race => race.trim());\n    } else {\n        femaleRaces = [actualFemaleRace];\n    }\n    \n    const maleHybridMatch = actualMaleRace.match(/^(.+?)[xX](.+)$/);\n    if(maleHybridMatch) {\n        maleRaces = actualMaleRace.split(/[xX]/).map(race => race.trim());\n    } else {\n        maleRaces = [actualMaleRace];\n    }\n    \n    // 計算所有可能的組合\n    const allRaces = [...femaleRaces, ...maleRaces];\n    \n    // 去重並排序\n    const uniqueRaces = [...new Set(allRaces)].sort();\n    \n    // 如果只有一個種族，直接返回\n    if(uniqueRaces.length === 1) {\n        return uniqueRaces[0];\n    }\n    \n    // 多個種族，用x連接\n    const fetusRace = uniqueRaces.join('x');\n    console.log(`Calculated fetus race for ${female} x ${male}: ${fetusRace}`);\n    return fetusRace;\n});\n\n// 获取种族的 breedTolerance（处理混血、子类等）\ndefine('bsGetRaceBreedTolerance', function(race) {\n    if (!race) return 1.0;\n    \n    // 處理後天種族標籤，格式：[後天]先天\n    let actualRace = race;\n    const derivedMatch = race.match(/^\\[([^\\]]+)\\](.+)$/);\n    if(derivedMatch) {\n        actualRace = derivedMatch[2];  // 只取先天種族\n    }\n    \n    // 處理子類物種，格式：主種族-子類\n    const subRaceMatch = actualRace.match(/^(.+?)-(.+)$/);\n    if(subRaceMatch) {\n        const mainRace = subRaceMatch[1];\n        if(bsRacePhysiologyProfiles[mainRace]) {\n            actualRace = mainRace;\n        }\n    }\n    \n    // 处理混血种族，格式：種族1x種族2x種族3\n    const hybridMatch = actualRace.match(/^(.+?)[xX](.+)$/);\n    if(hybridMatch) {\n        const raceComponents = actualRace.split(/[xX]/);\n        const hybridProfile = this.bsCalculateHybridProfile(raceComponents);\n        return hybridProfile?.breedTolerance || 1.0;\n    }\n    \n    // 单一种族\n    const raceProfile = bsRacePhysiologyProfiles[actualRace];\n    return raceProfile?.breedTolerance || 1.0;\n});\n\n// 根据种族计算性别（处理混血、genderRatio平均值）\ndefine('bsCalculateGenderByRace', function(race) {\n    if (!race) return _.random(0, 1) ? '男' : '女';\n    \n    // 處理後天種族標籤，格式：[後天]先天\n    let actualRace = race;\n    const derivedMatch = race.match(/^\\[([^\\]]+)\\](.+)$/);\n    if(derivedMatch) {\n        actualRace = derivedMatch[2];  // 只取先天種族\n    }\n    \n    // 處理子類物種，格式：主種族-子類\n    const subRaceMatch = actualRace.match(/^(.+?)-(.+)$/);\n    if(subRaceMatch) {\n        const mainRace = subRaceMatch[1];\n        if(bsRacePhysiologyProfiles[mainRace]) {\n            actualRace = mainRace;\n        }\n    }\n    \n    // 处理混血种族，格式：種族1x種族2x種族3\n    const hybridMatch = actualRace.match(/^(.+?)[xX](.+)$/);\n    if(hybridMatch) {\n        const raceComponents = actualRace.split(/[xX]/);\n        let validRatios = [];\n        let hasMinusOne = false;\n        \n        for(let component of raceComponents) {\n            const profile = bsRacePhysiologyProfiles[component];\n            if(profile) {\n                const ratio = profile.genderRatio;\n                if(ratio === -1) {\n                    // 遇到 -1（无性别），直接返回\n                    hasMinusOne = true;\n                    break;\n                } else if(ratio !== null && ratio !== undefined) {\n                    // null 跳过不算\n                    validRatios.push(ratio);\n                }\n            }\n        }\n        \n        if(hasMinusOne) {\n            return '无性'; // 无性别\n        }\n        \n        if(validRatios.length === 0) {\n            // 全是 null，视为双性\n            return '双性';\n        }\n        \n        // 取平均值\n        const avgRatio = validRatios.reduce((sum, r) => sum + r, 0) / validRatios.length;\n        // 根据平均值概率决定性别\n        return _.random(0, 99) < avgRatio ? '男' : '女';\n    }\n    \n    // 单一种族\n    const raceProfile = bsRacePhysiologyProfiles[actualRace];\n    if(!raceProfile) return _.random(0, 1) ? '男' : '女';\n    \n    const genderRatio = raceProfile.genderRatio;\n    \n    if(genderRatio === -1) {\n        return '无性'; // 无性别\n    } else if(genderRatio === null || genderRatio === undefined) {\n        return '双性'; // 双性（温度决定性别等特殊情况）\n    } else {\n        // 根据性别比概率决定性别\n        return _.random(0, 99) < genderRatio ? '男' : '女';\n    }\n});\n\n// 计算胎儿能量消耗（考虑母体和胎儿种族差异）\ndefine('bsCalculateFetalEnergyDrain', function(female) {\n    if (!female || this.variables?.bs?.[female] == null) return 0;\n    \n    const pregnant = this.getvar(`bs.${female}.pregnant`, { defaults: [] });\n    if (pregnant.length === 0) {\n        this.setvar(`bs.${female}.fetalEnergyDrain`, 0);\n        return 0;\n    }\n    \n    // 母体承受力\n    const motherBreedTolerance = this.getvar(`bs.${female}.breedTolerance`, { defaults: 1.0 });\n    \n    // 计算总能量消耗\n    let totalEnergyDrain = 0;\n    for (let fetus of pregnant) {\n        // 获取胎儿种族的 breedTolerance\n        const fetusBreedTolerance = this.bsGetRaceBreedTolerance(fetus.race);\n        \n        // 该胎儿的发育负载（fetalAge / 40，40周时为1）\n        const fetalLoad = (fetus.fetalAge || 0) / 40;\n        \n        // 该胎儿的能量消耗 = 发育负载 × (胎儿种族breedTolerance / 母体breedTolerance)\n        const fetusEnergyDrain = fetalLoad * (fetusBreedTolerance / motherBreedTolerance);\n        \n        totalEnergyDrain += fetusEnergyDrain;\n    }\n    \n    // 存储计算结果\n    this.setvar(`bs.${female}.fetalEnergyDrain`, totalEnergyDrain);\n    \n    return totalEnergyDrain;\n});\n\n// 计算产后恢复天数\ndefine('bsCalculateRecoveryDays', function(female) {\n    if (!female || this.variables?.bs?.[female] == null) return 42; // 默认6周\n    \n    let birthDifficulty = this.getvar(`bs.${female}.birthDifficulty`, { defaults: 1.0 });\n    let gestationSpeed = this.getvar(`bs.${female}.gestationSpeed`, { defaults: 1.0 });\n    let breedTolerance = this.getvar(`bs.${female}.breedTolerance`, { defaults: 1.0 });\n    let race = this.getvar(`bs.${female}.race`, { defaults: '人类' });\n    \n    // 處理後天種族標籤，格式：[後天]先天\n    let actualRace = race;\n    const derivedMatch = race.match(/^\\[([^\\]]+)\\](.+)$/);\n    if(derivedMatch) {\n        actualRace = derivedMatch[2];  // 只取先天種族\n        console.log(`Race has derived tag for recovery calculation: ${race} -> ${actualRace}`);\n    }\n    \n    // 處理子類物種，格式：主種族-子類\n    const subRaceMatch = actualRace.match(/^(.+?)-(.+)$/);\n    if(subRaceMatch) {\n        const mainRace = subRaceMatch[1];  // 主種族\n        const subRace = subRaceMatch[2];   // 子類\n        console.log(`Race has sub-race for recovery calculation: ${subRace} of ${mainRace}`);\n        \n        // 如果主種族存在，使用主種族\n        if(bsRacePhysiologyProfiles[mainRace]) {\n            actualRace = mainRace;\n            console.log(`Using main race for recovery calculation: ${mainRace}`);\n        }\n    }\n    \n    // 处理混血种族，格式：種族1x種族2x種族3\n    let embryoCoefficient = 0.15; // 默认胎生种族系数\n    const hybridMatch = actualRace.match(/^(.+?)[xX](.+)$/);\n    \n    if(hybridMatch) {\n        // 混血种族：数值取平均，embryoCoefficient取gestationSpeed最小值的类型\n        const raceComponents = actualRace.split(/[xX]/).map(race => race.trim());\n        let minGestationSpeed = Infinity;\n        let dominantRaceType = null;\n        \n        // 找到gestationSpeed最小的种族类型\n        for(const component of raceComponents) {\n            if(viviparousRace.includes(component)) {\n                const raceProfile = bsRacePhysiologyProfiles[component];\n                if(raceProfile && raceProfile.gestationSpeed < minGestationSpeed) {\n                    minGestationSpeed = raceProfile.gestationSpeed;\n                    dominantRaceType = 'viviparous';\n                }\n            } else if(oviparousRace.includes(component)) {\n                const raceProfile = bsRacePhysiologyProfiles[component];\n                if(raceProfile && raceProfile.gestationSpeed < minGestationSpeed) {\n                    minGestationSpeed = raceProfile.gestationSpeed;\n                    dominantRaceType = 'oviparous';\n                }\n            } else if(ovoviviparousRace.includes(component)) {\n                const raceProfile = bsRacePhysiologyProfiles[component];\n                if(raceProfile && raceProfile.gestationSpeed < minGestationSpeed) {\n                    minGestationSpeed = raceProfile.gestationSpeed;\n                    dominantRaceType = 'ovoviviparous';\n                }\n            } else if(metoviviparousRace.includes(component)) {\n                const raceProfile = bsRacePhysiologyProfiles[component];\n                if(raceProfile && raceProfile.gestationSpeed < minGestationSpeed) {\n                    minGestationSpeed = raceProfile.gestationSpeed;\n                    dominantRaceType = 'metoviviparous';\n                }\n            } else if(amorphousRace.includes(component)) {\n                const raceProfile = bsRacePhysiologyProfiles[component];\n                if(raceProfile && raceProfile.gestationSpeed < minGestationSpeed) {\n                    minGestationSpeed = raceProfile.gestationSpeed;\n                    dominantRaceType = 'amorphous';\n                }\n            }\n        }\n        \n        // 根据dominantRaceType设置embryoCoefficient\n        switch(dominantRaceType) {\n            case 'viviparous':\n                embryoCoefficient = 0.2;\n                break;\n            case 'oviparous':\n                embryoCoefficient = 0.6;\n                break;\n            case 'ovoviviparous':\n                embryoCoefficient = 0.4;\n                break;\n            case 'metoviviparous':\n                embryoCoefficient = 1.0;\n                break;\n            case 'amorphous':\n                embryoCoefficient = 0.8;\n                break;\n            default:\n                embryoCoefficient = 0.2; // 默认胎生种族系数\n        }\n    } else {\n        // 单一种族：根据种族确定胚胎群系数\n        if(viviparousRace.includes(race)) {\n            embryoCoefficient = 0.2; // 胎生种族\n        } else if(oviparousRace.includes(race)) {\n            embryoCoefficient = 0.6; // 卵生种族\n        } else if(ovoviviparousRace.includes(race)) {\n            embryoCoefficient = 0.4; // 卵胎生种族\n        } else if(metoviviparousRace.includes(race)) {\n            embryoCoefficient = 1.0; // 胎转卵生种族\n        } else if(amorphousRace.includes(race)) {\n            embryoCoefficient = 0.8; // 不定型种族\n        }\n    }\n    \n    // 使用新的统一公式：recoveryDays = 胚胎群系数 * (280/gestationSpeed) * (birthDifficulty/breedTolerance)\n    let recoveryDays = embryoCoefficient * (280 / gestationSpeed) * (birthDifficulty / breedTolerance);\n    \n    return Math.round(recoveryDays);\n});\n\ndefine('bsAddEggs', function(female, amount = 1) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n\n    // 检查是否在排卵期\n    const stage = this.getvar(`bs.${female}.stage`);\n    const orgasmOvulationUsed = this.getvar(`bs.${female}.orgasmOvulationUsed`, { defaults: false });\n    \n    // 假孕期不排卵\n    if(stage === '假孕期') {\n        this.setvar(`bs.${female}.notifySecondary`, `${female}处于假孕期，不会排卵`);\n        return;\n    }\n    \n    // 如果在排卵期，直接排卵\n    if(stage === '排卵期') {\n        this.incvar(`bs.${female}.eggs`, amount);\n        this.incvar(`bs.${female}.uterinePressure`, 2); //排卵痛\n        return;\n    }\n    \n    // 非排卵期：检查是否已使用高潮排卵\n    if(orgasmOvulationUsed) {\n        // 已使用高潮排卵，不排卵\n\n        return;\n    }\n    \n    // 未使用高潮排卵，正常排卵    \n    this.incvar(`bs.${female}.eggs`, amount);\n    this.incvar(`bs.${female}.uterinePressure`, 2); //排卵痛\n});\n\ndefine('bsAddSperm', function(female, male, race, amount) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    let sperms = this.getvar(`bs.${female}.sperms`, { defaults: [] });\n    let found = false;\n    for(let i = 0; i < sperms.length; i++) {\n        if(sperms[i].male === male) {\n            sperms[i].value += amount;\n            if(sperms[i].value <= 0) {\n                sperms.splice(i, 1); // 当精子数量小于等于0时，从数组中移除\n            }\n            found = true;\n            break;\n        }\n    }\n    if(!found && amount > 0) {\n        sperms.push({ male: male, race: race, value: amount });\n    }\n    this.setvar(`bs.${female}.sperms`, sperms);\n    \n    // 更新全域种族统计\n    this.bsUpdateGlobalRaceAndTypes();\n});\n\ndefine('bsImpregnate', function(female, male) {\n    if (!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    const stage = this.getvar(`bs.${female}.stage`);\n    if (!bsMenstrualStage.includes(stage) && stage!=='已受精' && stage!=='孕早期'){\n        return;\n    }\n    let pregnant = this.getvar(`bs.${female}.pregnant`, { defaults: [] });\n    let fetuses = this.getvar(`bs.${female}.fetuses`, { defaults: 0 });\n    let twinCounter = this.getvar(`bs.${female}.twinCounter`, { defaults: 0 });\n    const profile = this.getvar(`bs.${female}`, {\n        defaults: {\n            identicalProbability:          0,\n            semiIdenticalProbability:      0,\n            sharedMembraneProbability:     0,\n            earlyFusionProbability:        0,\n            superfetationProbability:      0,\n            polyploidyProbability:         0,\n        }\n    });\n\n    // 孕早期异期受孕检查\n    if (stage === '孕早期') {\n        if (_.random(0, 99) >= profile.superfetationProbability) {\n            return; // 未通过异期受孕概率检查，直接返回\n        }\n        // 通过检查，创建异期胎\n        const fetusRace = this.bsCalculateFetusRace(female, male);\n        let superfetationFetus = {\n            fathers: male,\n            race: fetusRace,\n            gender: this.bsCalculateGenderByRace(fetusRace),\n            twinId: null,\n            zygoteType: '异期胎',\n            embryoType: this.bsCalculateFetusEmbryoType(fetusRace),\n            impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n            fetalAge: 0,\n            fetalBias: _.random(0.5, 0.63),\n            affinity: 0,\n        };\n\n        // 检查是否存在符合条件的独胎（fetalBias > 1.1，女性，独胎）\n        let existingFetus = pregnant.find(f => \n            f.zygoteType === '独胎' && \n            f.fetalBias > 1.26 && \n            f.gender === '女'\n        );\n\n        // 如果找到符合条件的独胎，50%概率形成嵌套胎\n        if (existingFetus && _.random(0, 1)) {\n            existingFetus.zygoteType = '嵌套外胎';\n            existingFetus.twinId = twinCounter;\n            superfetationFetus.zygoteType = '嵌套内胎';\n            superfetationFetus.fetalBias = _.random(0.4, 0.5) // 养分更少\n            superfetationFetus.twinId = twinCounter;\n            this.incvar(`bs.${female}.twinCounter`, 1);\n        }\n\n        pregnant.push(superfetationFetus);\n        fetuses += 1;\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        return;\n    }\n\n    // 检查是否为双母源\n    const isDualMother = this.variables?.bs?.[male] !== undefined && this.variables.bs[male] !== null;\n    // 检查是否为自交\n    const isSelfFertilization = male === female;\n    // 其他受精类型\n    const isEarlyFusion     = _.random(0, 99) < profile.earlyFusionProbability;\n    const isIdentical       = _.random(0, 99) < profile.identicalProbability;\n    const isSemiIdentical   = _.random(0, 99) < profile.semiIdenticalProbability;\n    const isSharedMembrane  = _.random(0, 99) < profile.sharedMembraneProbability;\n\n    const totalSperms = this.getvar(`bs.${female}.sperms`, { defaults: [] });\n    const eggs = this.getvar(`bs.${female}.eggs`, { defaults: 0 });\n    const totalSperm = totalSperms.reduce((sum, s) => sum + s.value, 0);\n\n\n    // 双母源\n    if (isDualMother) {\n        const fetusRace = this.bsCalculateFetusRace(female, male);\n        let dualMotherFetus = {\n            fathers: male,\n            race: fetusRace,\n            gender: '女',\n            twinId: null,\n            zygoteType: '双母源',\n            embryoType: this.bsCalculateFetusEmbryoType(fetusRace),\n            impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n            fetalAge: 0,\n            fetalBias: _.random(0.5, 0.63),\n            affinity: 0,\n        };\n        pregnant.push(dualMotherFetus);\n        fetuses += 1;\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        return;\n    }\n\n    // 自交卵\n    if (isSelfFertilization) {\n        const fetusRace = this.bsCalculateFetusRace(female, male);\n        let selfFertilizationFetus = {\n            fathers: male,\n            race: fetusRace,\n            gender: '双性',\n            twinId: null,\n            zygoteType: '自交',\n            embryoType: this.bsCalculateFetusEmbryoType(fetusRace),\n            impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n            fetalAge: 0,\n            fetalBias: _.random(1.0, 1.26),\n            affinity: 0,\n        };\n        pregnant.push(selfFertilizationFetus);\n        fetuses += 1;\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        return;\n    }\n    \n    // 多倍体\n    if (totalSperm > 50 && eggs > 1 && _.random(0, 99) < profile.polyploidyProbability) {\n        // 创建胎儿\n        const fetusRace = this.bsCalculateFetusRace(female, male);\n            let polyploidyFetus = {\n            fathers: totalSperms.map(s => s.male).join('+'),\n            race: fetusRace,\n            gender: this.bsCalculateGenderByRace(fetusRace),\n            twinId: null,\n            zygoteType: '多倍体',\n            embryoType: this.bsCalculateFetusEmbryoType(fetusRace),\n            impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n            fetalAge: 0,\n            fetalBias: _.random(2.0, 2.51),\n            affinity: 0,\n        };\n        \n        // 清空所有精子和卵子\n        this.setvar(`bs.${female}.sperms`, []);\n        this.setvar(`bs.${female}.eggs`, 0);\n        \n        pregnant.push(polyploidyFetus);\n        fetuses += 1;\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        return;\n    }\n    // 双父源（卵泡期，精子多且有两个父亲，未成熟卵被借壳）\n    if (stage === '卵泡期' && totalSperm > 50 && totalSperms.length >= 2) {\n        // 随机选择两个不同的父亲\n        const firstFather = male;\n        const allFathers = totalSperms.map(s => s.male).filter(f => f !== male);\n        const secondFather = allFathers.length > 0 ? _.sample(allFathers) : male;\n        \n        if (firstFather !== secondFather) {\n            // 创建双父源胎儿（没有母亲基因，种族为两父混血）\n            const fatherStr = `${firstFather}+${secondFather}`;\n            const fetusRace = this.bsCalculateFetusRace(firstFather, secondFather);\n            \n            let dualFatherFetus = {\n                fathers: fatherStr,\n                race: fetusRace,\n                gender: '男', // 双父源固定为男性\n                twinId: null,\n                zygoteType: '双父源',\n                embryoType: this.bsCalculateFetusEmbryoType(fetusRace),\n                impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n                fetalAge: 0,\n                fetalBias: _.random(1.58, 2.0),\n                affinity: 0,\n            };\n            \n            // 清空所有精子和卵子\n            this.setvar(`bs.${female}.sperms`, []);\n            this.setvar(`bs.${female}.eggs`, 0);\n            \n            pregnant.push(dualFatherFetus);\n            fetuses += 1;\n            this.setvar(`bs.${female}.pregnant`, pregnant);\n            this.setvar(`bs.${female}.fetuses`, fetuses);\n            return;\n        }\n    }\n    // 早期融合卵\n    if (isEarlyFusion) {\n        let existingFetus = pregnant.find(f => f.zygoteType === '独胎');\n        if (existingFetus) {\n            // 检查是否为解离纯化x2：两卵的父方一致且父母种族不同\n            const femaleRace = this.getvar(`bs.${female}.race`, { defaults: null });\n            const maleRace = this.getvar(`bs.${male}.race`, { defaults: null });\n            const isSameFather = existingFetus.fathers === male;\n            const isDifferentRace = femaleRace && maleRace && femaleRace !== maleRace;\n            \n            if (isSameFather && isDifferentRace) {\n                // 检查是否为解离纯化x4（混血夫妇怀上四个纯血胎儿）\n                if (femaleRace && maleRace && (femaleRace.includes('x') || femaleRace.includes('X')) && (maleRace.includes('x') || maleRace.includes('X'))) {\n                    // 解析混血种族（支持大小写x和X）\n                    const femaleRaces = femaleRace.toLowerCase().split('x');\n                    const maleRaces = maleRace.toLowerCase().split('x');\n                    \n                    // 检查父母是否都是雙混血\n                    if (femaleRaces.length === 2 && maleRaces.length === 2) {\n                        // 解离纯化x4：四个纯血胎儿，两男两女，胎重都是1.0\n                        const quadrupletId = twinCounter;\n                        const genders = ['男', '男', '女', '女'];\n                        \n                        // 随机打乱种族和性别顺序\n                        const allRaces = [...new Set([...femaleRaces, ...maleRaces])];\n                        const shuffledRaces = _.shuffle(allRaces);\n                        const shuffledGenders = _.shuffle(genders);\n                        \n                        // 移除现有的独胎\n                        const existingFetusIndex = pregnant.indexOf(existingFetus);\n                        pregnant.splice(existingFetusIndex, 1);\n                        fetuses -= 1;\n                        \n                        // 创建四个纯血胎儿\n                        for (let i = 0; i < 4; i++) {\n                            let pureFetus = {\n                                fathers: male,\n                                race: shuffledRaces[i],\n                                gender: shuffledGenders[i],\n                                twinId: quadrupletId,\n                                zygoteType: '解离纯化x4',\n                                embryoType: this.bsCalculateFetusEmbryoType(shuffledRaces[i]),\n                                impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n                                fetalAge: 0,\n                                fetalBias: 1.0, // 固定胎重1.0\n                                affinity: 0,\n                            };\n                            pregnant.push(pureFetus);\n                        }\n                        \n                        this.incvar(`bs.${female}.twinCounter`, 1);\n                        fetuses += 4;\n                        this.setvar(`bs.${female}.pregnant`, pregnant);\n                        this.setvar(`bs.${female}.fetuses`, fetuses);\n                        return;\n                    }\n                }\n                \n                // 检查是否为解离纯化x3（一方混血一方纯血，怀上三个纯血胎儿）\n                if (femaleRace && maleRace) {\n                    const femaleRaces = (femaleRace.includes('x') || femaleRace.includes('X')) ? femaleRace.toLowerCase().split('x') : [femaleRace.toLowerCase()];\n                    const maleRaces = (maleRace.includes('x') || maleRace.includes('X')) ? maleRace.toLowerCase().split('x') : [maleRace.toLowerCase()];\n                    \n                    // 检查是否一方是双混血，另一方是纯血\n                    if ((femaleRaces.length === 2 && maleRaces.length === 1) || (femaleRaces.length === 1 && maleRaces.length === 2)) {\n                        // 解离纯化x3：三个纯血胎儿，2女1男或1女2男，胎重都是1.0\n                        const tripletId = twinCounter;\n                        const genders = _.random(0, 1) ? ['女', '女', '男'] : ['男', '男', '女'];\n                        \n                        // 收集所有种族（A、B、C）\n                        const allRaces = [...new Set([...femaleRaces, ...maleRaces])];\n                        const shuffledGenders = _.shuffle(genders);\n                        \n                        // 移除现有的独胎\n                        const existingFetusIndex = pregnant.indexOf(existingFetus);\n                        pregnant.splice(existingFetusIndex, 1);\n                        fetuses -= 1;\n                        \n                        // 创建三个纯血胎儿\n                        for (let i = 0; i < 3; i++) {\n                            let pureFetus = {\n                                fathers: male,\n                                race: allRaces[i],\n                                gender: shuffledGenders[i],\n                                twinId: tripletId,\n                                zygoteType: '解离纯化x3',\n                                embryoType: this.bsCalculateFetusEmbryoType(allRaces[i]),\n                                impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n                                fetalAge: 0,\n                                fetalBias: 1.0, // 固定胎重1.0\n                                affinity: 0,\n                            };\n                            pregnant.push(pureFetus);\n                        }\n                        \n                        this.incvar(`bs.${female}.twinCounter`, 1);\n                        fetuses += 3;\n                        this.setvar(`bs.${female}.pregnant`, pregnant);\n                        this.setvar(`bs.${female}.fetuses`, fetuses);\n                        return;\n                    }\n                }\n                \n                // 解离纯化x2：无法融合，成为母方种族和父方种族各一胎，必为一男一女\n                const twinId = twinCounter;\n                const sharedFetalBias = 1.0; // 固定胎重1.0\n                \n                // 随机决定性别分配（50%概率）\n                const motherIsMale = _.random(0, 1); // true = 母方种族男胎, false = 母方种族女胎\n                \n                // 修改现有胎儿为母方种族\n                existingFetus.race = femaleRace;\n                existingFetus.gender = motherIsMale ? '男' : '女';\n                existingFetus.twinId = twinId;\n                existingFetus.zygoteType = '解离纯化x2';\n                existingFetus.fetalBias = sharedFetalBias;\n                existingFetus.embryoType = this.bsCalculateFetusEmbryoType(femaleRace);\n                \n                // 创建父方种族（性别相反）\n                let twinFetus = {\n                    fathers: male,\n                    race: maleRace,\n                    gender: motherIsMale ? '女' : '男',\n                    twinId: twinId,\n                    zygoteType: '解离纯化x2',\n                    embryoType: this.bsCalculateFetusEmbryoType(maleRace),\n                    impregnateDay: existingFetus.impregnateDay,\n                    fetalAge: 0,\n                    fetalBias: sharedFetalBias,\n                    affinity: 0,\n                };\n                \n                pregnant.push(twinFetus);\n                fetuses += 1;\n                this.incvar(`bs.${female}.twinCounter`, 1);\n                this.setvar(`bs.${female}.pregnant`, pregnant);\n                this.setvar(`bs.${female}.fetuses`, fetuses);\n                return;\n            } else {\n                // 正常早期融合卵逻辑\n                if (existingFetus.fathers !== male) {\n                    existingFetus.fathers = `${existingFetus.fathers}+${male}`;\n                }\n                existingFetus.zygoteType = '早期融合卵';\n                existingFetus.fetalBias = _.random(1.26, 1.58);\n                // 50%概率变成双性\n                if (_.random(0, 1)) {\n                    existingFetus.gender = '双性';\n                }\n                this.setvar(`bs.${female}.pregnant`, pregnant);\n                this.setvar(`bs.${female}.fetuses`, fetuses); //胎儿数不会变动\n                return;\n            }\n        }\n    }\n\n    // identicalProbability：百分比（0~100）→轉成 0~1\n    const splitP = profile.identicalProbability / 100;\n\n    // 四胞胎检查（isIdentical的三次方概率）\n    // 「同卵四胎 ≈ 連續 3 次分裂都發生」的近似：p^3\n    const quadProb = Math.pow(splitP, 3);\n    const isQuadruplet = Math.random() < quadProb;\n    \n    if (isQuadruplet) {\n        // 普通四胞胎：四胎同性，共享twinId，胎重随机\n        const quadrupletId = twinCounter;\n        const fetusRace = this.bsCalculateFetusRace(female, male);\n        const gender = this.bsCalculateGenderByRace(fetusRace);\n        \n        // 创建四个胎儿，根據isSharedMembrane 決定 'MCQA' or 'QCQA'\n        const quadZygoteType = isSharedMembrane ? 'MCQA' : 'QCQA';\n        \n        if (isSharedMembrane) {\n            // MCQA（单绒四羊）：四个胎儿胎重随机\n            // 判断是否为 MCMAx4（单绒单羊四胞胎）\n            const isMirror = _.random(0, 99) < profile.sharedMembraneProbability/2;\n            const finalZygoteType = isMirror ? 'MCMAx4' : quadZygoteType;\n            \n            if (isMirror) {\n                // MCMAx4：四个胎儿使用相同的镜像胎重\n                const mirrorBias = _.random(0.4, 0.63);\n                for (let i = 0; i < 4; i++) {\n                    let quadrupletFetus = {\n                        fathers: male,\n                        race: fetusRace,\n                        gender: gender,\n                        twinId: quadrupletId,\n                        zygoteType: finalZygoteType,\n                        embryoType: this.bsCalculateFetusEmbryoType(fetusRace),\n                        impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n                        fetalAge: 0,\n                        fetalBias: mirrorBias, // 四个胎儿相同胎重\n                        affinity: 0,\n                    };\n                    pregnant.push(quadrupletFetus);\n                }\n            } else {\n                // MCQA：四个胎儿胎重随机\n                for (let i = 0; i < 4; i++) {\n                    let quadrupletFetus = {\n                        fathers: male,\n                        race: fetusRace,\n                        gender: gender,\n                        twinId: quadrupletId,\n                        zygoteType: finalZygoteType,\n                        embryoType: this.bsCalculateFetusEmbryoType(fetusRace),\n                        impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n                        fetalAge: 0,\n                        fetalBias: _.random(0.4, 0.63), // 随机胎重，范围[0.4, 0.5]\n                        affinity: 0,\n                    };\n                    pregnant.push(quadrupletFetus);\n                }\n            }\n        } else {\n            // QCQA（四绒四羊）：四个胎儿完全独立，胎重随机\n            for (let i = 0; i < 4; i++) {\n                let quadrupletFetus = {\n                    fathers: male,\n                    race: fetusRace,\n                    gender: gender,\n                    twinId: quadrupletId,\n                    zygoteType: quadZygoteType,\n                    embryoType: this.bsCalculateFetusEmbryoType(fetusRace),\n                    impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n                    fetalAge: 0,\n                    fetalBias: _.random(0.5, 0.63), // 随机胎重，完全独立\n                    affinity: 0,\n                };\n                pregnant.push(quadrupletFetus);\n            }\n        }\n        \n        this.incvar(`bs.${female}.twinCounter`, 1);\n        fetuses += 4;\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        return;\n    }\n    \n    // 三胞胎检查（isIdentical的二次方概率）\n    // 「同卵三胎 ≈ 連續 2 次分裂都發生」的近似：p^2\n    const tripletProb = Math.pow(splitP, 2);\n    const isTriplet = Math.random() < tripletProb;\n    \n    if (isTriplet) {\n        // 同卵三胞胎：三胎同性，共享twinId\n        const tripletId = twinCounter;\n        const fetusRace = this.bsCalculateFetusRace(female, male);\n        const gender = this.bsCalculateGenderByRace(fetusRace);\n        \n        // 根據isSharedMembrane 決定 'MCTA' or 'TCTA'\n        const tripletZygoteType = isSharedMembrane ? 'MCTA' : 'TCTA';\n        \n        if (isSharedMembrane) {\n            // MCTA（单绒三羊）：三个胎儿胎重随机\n            // 判断是否为 MCMAx3（单绒单羊三胞胎）\n            const isMirror = _.random(0, 99) < profile.sharedMembraneProbability/2;\n            const finalZygoteType = isMirror ? 'MCMAx3' : tripletZygoteType;\n            \n            if (isMirror) {\n                // MCMAx3：三个胎儿使用相同的镜像胎重\n                const mirrorBias = _.random(0.5, 0.79);\n                for (let i = 0; i < 3; i++) {\n                    let tripletFetus = {\n                        fathers: male,\n                        race: fetusRace,\n                        gender: gender,\n                        twinId: tripletId,\n                        zygoteType: finalZygoteType,\n                        embryoType: this.bsCalculateFetusEmbryoType(fetusRace),\n                        impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n                        fetalAge: 0,\n                        fetalBias: mirrorBias, // 三个胎儿相同胎重\n                        affinity: 0,\n                    };\n                    pregnant.push(tripletFetus);\n                }\n            } else {\n                // MCTA：三个胎儿胎重随机\n                for (let i = 0; i < 3; i++) {\n                    let tripletFetus = {\n                        fathers: male,\n                        race: fetusRace,\n                        gender: gender,\n                        twinId: tripletId,\n                        zygoteType: finalZygoteType,\n                        embryoType: this.bsCalculateFetusEmbryoType(fetusRace),\n                        impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n                        fetalAge: 0,\n                        fetalBias: _.random(0.5, 0.79), // 随机胎重，范围[0.5, 0.79]\n                        affinity: 0,\n                    };\n                    pregnant.push(tripletFetus);\n                }\n            }\n        } else {\n            // TCTA（三绒三羊）：三个胎儿完全独立，胎重随机\n            for (let i = 0; i < 3; i++) {\n                let tripletFetus = {\n                    fathers: male,\n                    race: fetusRace,\n                    gender: gender,\n                    twinId: tripletId,\n                    zygoteType: tripletZygoteType,\n                    embryoType: this.bsCalculateFetusEmbryoType(fetusRace),\n                    impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n                    fetalAge: 0,\n                    fetalBias: _.random(0.63, 0.79), // 随机胎重，完全独立\n                    affinity: 0,\n                };\n                pregnant.push(tripletFetus);\n            }\n        }\n        \n        this.incvar(`bs.${female}.twinCounter`, 1);\n        fetuses += 3;\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        return;\n    }\n    \n    // 双胞胎概率计算\n    const sperms = this.getvar(`bs.${female}.sperms`, { defaults: [] });\n    const fetusRace = this.bsCalculateFetusRace(female, male);\n\n    // 半同卵双胞胎检查\n    if (isSemiIdentical) {\n        const twinId = twinCounter;\n        const allFathers = sperms.map(s => s.male);\n        const secondFather = _.sample(allFathers);\n        const fatherStr = (secondFather !== male) ? `${male}+${secondFather}` : male;\n        \n        // 根据是否共享膜决定类型和胎重\n        let semiZygoteType;\n        let biasArray = [];\n        \n        if (isSharedMembrane) {\n            const isMirror = _.random(0, 99) < profile.sharedMembraneProbability/2;\n            if (isMirror) {\n                // S-MCMA（单绒单羊）：镜像半同卵，相同胎重\n                const mirrorBias = _.random(0.63, 1.26);\n                biasArray = [mirrorBias, mirrorBias];\n                semiZygoteType = 'S-MCMA';\n            } else {\n                // S-MCDA（单绒双羊）：不同胎重\n                biasArray = [_.random(0.63, 1.26), _.random(0.63, 1.26)];\n                semiZygoteType = 'S-MCDA';\n            }\n        } else {\n            // S-DCDA（双绒双羊）：不同胎重\n            biasArray = [_.random(0.79, 1.26), _.random(0.79, 1.26)];\n            semiZygoteType = 'S-DCDA';\n        }\n        \n        for (let i = 0; i < 2; i++) {\n            let semiTwin = {\n                fathers: fatherStr,\n                race: fetusRace,\n                gender: this.bsCalculateGenderByRace(fetusRace), // 每个胎儿独立计算性别\n                twinId: twinId,\n                zygoteType: semiZygoteType,\n                embryoType: this.bsCalculateFetusEmbryoType(fetusRace),\n                impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n                fetalAge: 0,\n                fetalBias: biasArray[i],\n                affinity: 0,\n            };\n            pregnant.push(semiTwin);\n        }\n        \n        fetuses += 2;\n        this.incvar(`bs.${female}.twinCounter`, 1);\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        return;\n    }\n\n    // 同卵双胞胎检查\n    if (isIdentical) {\n        const twinId = twinCounter;\n        const gender = this.bsCalculateGenderByRace(fetusRace); // 同卵双胞胎同性别\n        \n        // 根据是否共享膜决定类型和胎重\n        let twinZygoteType;\n        let biasArray = [];\n        \n        if (isSharedMembrane) {\n            const isMirror = _.random(0, 99) < profile.sharedMembraneProbability/2;\n            if (isMirror) {\n                // MCMA（单绒单羊）：镜像双胞胎，相同胎重\n                const mirrorBias = _.random(0.63, 1.0);\n                biasArray = [mirrorBias, mirrorBias];\n                twinZygoteType = 'MCMA';\n            } else {\n                // MCDA（单绒双羊）：不同胎重\n                biasArray = [_.random(0.63, 1.0), _.random(0.63, 1.0)];\n                twinZygoteType = 'MCDA';\n            }\n        } else {\n            // DCDA（双绒双羊）：不同胎重\n            biasArray = [_.random(0.79, 1.0), _.random(0.79, 1.0)];\n            twinZygoteType = 'DCDA';\n        }\n        \n        for (let i = 0; i < 2; i++) {\n            let twin = {\n                fathers: male,\n                race: fetusRace,\n                gender: gender,\n                twinId: twinId,\n                zygoteType: twinZygoteType,\n                embryoType: this.bsCalculateFetusEmbryoType(fetusRace),\n                impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n                fetalAge: 0,\n                fetalBias: biasArray[i],\n                affinity: 0,\n            };\n            pregnant.push(twin);\n        }\n        \n        fetuses += 2;\n        this.incvar(`bs.${female}.twinCounter`, 1);\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        return;\n    }\n\n    // 单胎\n    let newFetus = {\n        fathers: male,\n        race: fetusRace,\n        gender: this.bsCalculateGenderByRace(fetusRace),\n        twinId: null,\n        zygoteType: '独胎',\n        embryoType: this.bsCalculateFetusEmbryoType(fetusRace),\n        impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n        fetalAge: 0,\n        fetalBias: _.random(0.79, 1.26),\n        affinity: 0,\n    };\n    \n    // 检查是否在月经期受精，判断是否形成经期胚\n    if (stage === '月经期') {\n        newFetus.zygoteType = '经期胚';\n        newFetus.fetalBias = _.random(0.63, 0.79);\n    } else {\n        // 检查vitality值，判断是否形成厚养胚\n        const vitality = this.getvar(`bs.${female}.vitality`, { defaults: 100 });\n        if (vitality <= 60 || vitality >= 140) {\n            newFetus.zygoteType = '厚养胚';\n            newFetus.fetalBias = _.random(1.26, 1.58);\n        }\n    }\n    \n    pregnant.push(newFetus);\n    fetuses += 1;\n    this.setvar(`bs.${female}.pregnant`, pregnant);\n    this.setvar(`bs.${female}.fetuses`, fetuses);\n});\n\ndefine('bsAdjustFetalWeight', function(female, fetusIndex, biasChange) {\n    if (!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    let pregnant = this.getvar(`bs.${female}.pregnant`, { defaults: [] });\n    if (fetusIndex < 0 || fetusIndex >= pregnant.length) return;\n\n    let currentFetus = pregnant[fetusIndex];\n    const currentBias = currentFetus.fetalBias || 1.0;\n    \n    // 更新重量\n    const newBias = Math.max(0.3, Math.min(3.0, currentBias + biasChange));\n    currentFetus.fetalBias = newBias;\n    \n    console.log(`Fetal weight adjusted for ${female}'s fetus ${fetusIndex}: ${currentBias.toFixed(2)} -> ${newBias.toFixed(2)} (change: ${biasChange.toFixed(2)})`);\n    \n    this.setvar(`bs.${female}.pregnant`, pregnant);\n});\ndefine('bsPassedTime', function(opt = { minute: 15 }) {\n    let remaining = (opt.day || 0) +\n        ((opt.hour || 0) * (1 / 24)) +\n        ((opt.minute || 0) * (1 / 24 / 60)) +\n        ((opt.second || 0) * (1 / 24 / 60 / 60)) +\n        (opt.month || 0) * 30 +\n        (opt.week || 0) * 7 +\n        (opt.year || 0) * 365;\n    while(remaining > 0) {\n        const passed = remaining > 1 ? 1 : remaining;\n        remaining -= passed;\n        for(let [char, data] of _.entries(this.variables.bs)) {\n            if(!char || !data || char === 'global') continue;\n            let stage = data.stage || '卵泡期';\n            // 取出旧的天数\n            const oldDays = data.days || 0;\n            const newDays = oldDays + passed;\n\n            // 由天数推算：天、周、月、小时\n            const oldDayCount   = Math.floor(oldDays);\n            const newDayCount   = Math.floor(newDays);\n\n            const oldWeekCount  = Math.floor(oldDays  / 7);\n            const newWeekCount  = Math.floor(newDays  / 7);\n\n            const oldMonthCount = Math.floor(oldDays  / 30);\n            const newMonthCount = Math.floor(newDays  / 30);\n\n            const oldHourCount  = Math.floor(oldDays * 24);\n            const newHourCount  = Math.floor(newDays * 24);\n\n            // 判断是否「新」一日、一周、一月、一小时（基于实际时间推进）\n            const isNewDay   = newDayCount   > oldDayCount;\n            const isNewWeek  = newWeekCount  > oldWeekCount;\n            const isNewMonth = newMonthCount > oldMonthCount;\n            const isNewHour  = newHourCount  > oldHourCount;\n\n             // 写回最新天数\n            this.setvar(`bs.${char}.days`, newDays);\n\n            const metabolismImmune = this.getvar(`bs.${char}.metabolismImmune`, { defaults: false });\n            const isHere =  this.getvar(`bs.${char}.isHere`, { defaults: false });\n            \n            // 計算fetalEnergyDrain（用于代谢物累积）\n            let fetalEnergyDrain = this.bsCalculateFetalEnergyDrain(char);\n            \n            // 如果是怀孕状态，累加怀孕天数\n            if(bsPregnancyStage.includes(stage) || stage === '产前阵痛' || bsLaborStage.includes(stage)) {\n                let pregnantDays = this.getvar(`bs.${char}.pregnantDays`, { defaults: 0 });\n                pregnantDays += passed;\n                this.setvar(`bs.${char}.pregnantDays`, pregnantDays);\n                \n                // 更新每个胎儿的实际发育情况\n                let pregnant = this.getvar(`bs.${char}.pregnant`, { defaults: [] });\n                let gestationSpeed = this.getvar(`bs.${char}.gestationSpeed`, { defaults: 1.0 });\n                \n                for(let fetus of pregnant) {\n                    // 计算胎儿实际发育周数\n                    let AgeInDays = (pregnantDays - fetus.impregnateDay) * gestationSpeed * fetus.fetalBias;\n                    fetus.fetalAge = AgeInDays / 7;\n                }\n                \n                this.setvar(`bs.${char}.pregnant`, pregnant);\n            }\n\n            if(bsMenstrualStage.includes(stage)) {\n                // 计算当前阶段的实际天数（包括波动）\n                let menstrualFluctuationDays = this.getvar(`bs.${char}.menstrualFluctuationDays`, { defaults: 1 });\n                let menstrualLengthRatio = this.getvar(`bs.${char}.menstrualLengthRatio`, { defaults: 1 });\n                let baseDays = menstrualStageDays[stage];\n                let fluctuation = _.random(-1*menstrualFluctuationDays, menstrualFluctuationDays);\n                // 确保波动后的天数至少为1天\n                let actualDays = Math.max(1, (baseDays + fluctuation)) * menstrualLengthRatio;\n                if(newDayCount > actualDays) {\n                    let nextIndex = (bsMenstrualStage.indexOf(stage) + 1) % bsMenstrualStage.length;\n                    let nextStage = bsMenstrualStage[nextIndex];\n                    \n                    // 检查是否应该进入假孕期\n                    if(nextStage === '月经期') {\n                        let psyStress = this.getvar(`bs.${char}.psyStress`, { defaults: 0 });\n                        let latestSexPartner = this.getvar(`bs.${char}.latestSexPartner`, { defaults: null });\n                        let pseudopregnancyImmune = this.getvar(`bs.${char}.pseudopregnancyImmune`, { defaults: false });\n                        \n                        if(psyStress >= 100 && libido >= 50 && latestSexPartner !== null && !pseudopregnancyImmune) {\n                            // 进入假孕期\n                            this.bsSetStageWithOrgasmOvulation(char, '假孕期', { days: 1 });\n                            this.setvar(`bs.${char}.notifySecondary`, `${char}因心理压力过大，出现了假孕症状`);\n                        } else {\n                            // 正常进入月经期\n                            const overflowDays = newDayCount - actualDays;\n                            const nextStageDays = Math.max(1, overflowDays);\n                            this.bsSetStageWithOrgasmOvulation(char, nextStage, { days: nextStageDays });\n                        }\n                    } else {\n                        // 其他阶段正常切换\n                        const overflowDays = newDayCount - actualDays;\n                        const nextStageDays = Math.max(1, overflowDays);\n                        this.bsSetStageWithOrgasmOvulation(char, nextStage, { days: nextStageDays });\n                    }\n                }\n                if (stage === '月经期' && isNewDay){\n                    this.incvar(`bs.${char}.uterinePressure`, 5);\n\n                }\n                \n                if (stage === '卵泡期' && isNewDay){\n                    this.incvar(`bs.${char}.uterinePressure`, -3);\n                }\n\n            } else if(bsPregnancyStage.includes(stage)) {\n                let pregnantDays = this.getvar(`bs.${char}.pregnantDays`, { defaults: 0 });\n                let pregnant = this.getvar(`bs.${char}.pregnant`, { defaults: [] });\n                const gestationSpeed = this.getvar(`bs.${char}.gestationSpeed`, { defaults: 1.0 });\n\n                //跨日\n                const uterinePressure = this.getvar(`bs.${char}.uterinePressure`, { defaults: 0 });\n                const vitality = this.getvar(`bs.${char}.vitality`, { defaults: 100 });\n                \n                if(stage === '逾期') {\n                    if(isNewDay) {\n                        const overdueDays = pregnantDays*gestationSpeed - 280; //还原人类逾期天数\n                        const overdueMultiplier = 1 + Math.pow(overdueDays, 2) * 0.08; // 平方加速恶化，人类14天累积约100\n                        // 自然催产：子宫压力与胎儿能量消耗强相关\n                        this.incvar(`bs.${char}.uterinePressure`, fetalEnergyDrain * overdueMultiplier);\n                        this.incvar(`bs.${char}.vitality`, -fetalEnergyDrain * overdueMultiplier);\n                    }\n                } else {\n                    // 计算当前阶段的天数阈值\n                    let currentStageIndex = bsPregnancyStage.indexOf(stage);\n                    let baseDays = 0;\n                    // 计算当前阶段之前的所有阶段天数总和\n                    for(let i = 0; i < currentStageIndex; i++) {\n                        baseDays += pregnancyStageDays[bsPregnancyStage[i]] / gestationSpeed;\n                    }\n                    // 计算当前阶段的天数阈值\n                    let daysThreshold = baseDays + pregnancyStageDays[stage] / gestationSpeed;\n                    \n                    // 如果超过当前阶段阈值，需要确定最终阶段\n                    if(pregnantDays >= daysThreshold) {\n                        let finalStage = stage;\n                        let finalStageDays = 1;\n                        let remainingDays = pregnantDays;\n                        \n                        // 遍历所有后续阶段，找到最终阶段\n                        for(let i = currentStageIndex; i < bsPregnancyStage.length; i++) {\n                            let stageDays = pregnancyStageDays[bsPregnancyStage[i]] / gestationSpeed;\n                            if(remainingDays >= stageDays) {\n                                remainingDays -= stageDays;\n                                if(i < bsPregnancyStage.length - 1) {\n                                    finalStage = bsPregnancyStage[i + 1];\n                                } else {\n                                    finalStage = '逾期';\n                                }\n                            } else {\n                                finalStageDays = Math.max(1, Math.floor(remainingDays));\n                                break;\n                            }\n                        }\n                        \n                        this.bsSetStageWithOrgasmOvulation(char, finalStage, { days: finalStageDays });\n                        this.bsNotifyCycle(char, true);\n                    }\n                    \n                    if(isNewDay && isHere && !this.getvar(`bs.${char}.drainImmune`, { defaults: false })) {\n                        // 日常孕期压力，角色需在场才执行事件判定\n                        this.incvar(`bs.${char}.uterinePressure`, fetalEnergyDrain);\n                        this.incvar(`bs.${char}.vitality`, -fetalEnergyDrain);\n                        console.log(`Daily pregnancy pressure for ${char}: uterinePressure +${fetalEnergyDrain.toFixed(1)}, vitality -${fetalEnergyDrain.toFixed(1)}`);\n                        \n                        // 重置情感更新冷却\n                        this.setvar(`bs.${char}.emotionalUpdateUsed`, false);\n                    }\n                }\n                \n\n\n                //分娩判定，角色需在场才执行事件判定\n                if(isHere) {\n                    const abortionImmune = this.getvar(`bs.${char}.abortionImmune`, { defaults: false });\n                    \n                    if(stage === '孕早期' && uterinePressure >= 50) {\n                      // 孕早期压力阈值更低，更容易流产\n                      this.bsAbortion(char);\n                    } else if(stage === '孕中期' && uterinePressure >= 80) {\n                        // 孕中期压力阈值保持原样\n                        this.bsAbortion(char);\n                    } else if((stage === '孕晚期' || stage === '临产期') && uterinePressure >= 80) {\n                        // 晚期、临产期可以触发产前阵痛\n                        if (abortionImmune){\n                          this.setvar(`bs.${char}.notifySecondary`, `${char}的胎儿受到保护，早产被阻止了`);\n                        } else{\n                            this.bsSetStageWithOrgasmOvulation(char, '产前阵痛', { days: 1 });\n                          this.bsNotifyCycle(char, true);\n                        }\n\n                    } else if(stage === '逾期' && uterinePressure >= 100) {\n                        // 逾期压力阈值更高，才能触发产前阵痛\n                        this.bsSetStageWithOrgasmOvulation(char, '产前阵痛', { days: 1 });\n                        this.bsNotifyCycle(char, true);\n                    }\n                }\n                \n                //跨時\n                if(isNewHour && isHere) {\n                    // 重置affinity调整冷却\n                    this.setvar(`bs.${char}.affinityAdjustmentUsed`, false);\n                    \n                    const fetalEnergyDrainRounded = Math.max(1, Math.ceil(fetalEnergyDrain));\n                    // 执行n次判定（n为向上取整的fetalEnergyDrain）\n                    for(let i = 0; i < fetalEnergyDrainRounded; i++) {\n                        const symptomChance = (200 - vitality) * 0.5;\n                        if(_.random(0, 100) < symptomChance && !this.getvar(`bs.${char}.drainImmune`, { defaults: false })) {\n                            // 通用妊娠症状\n                            const pregnancySymptom = `${char}的身体出现了妊娠症状`;\n                            this.setvar(`bs.${char}.notifySecondary`, pregnancySymptom);\n                        }\n                    }\n                }\n                \n                //跨周\n                if (isNewWeek && isHere && !this.getvar(`bs.${char}.drainImmune`, { defaults: false })){\n                    // 估算本周消耗（基于当前 fetalEnergyDrain）\n                    const weeklyDrain = fetalEnergyDrain * 7;\n                    \n                    // 考虑母体活力和胎儿能量消耗的平衡\n                    // 使用温和的调整，避免极端变化\n                    const vitalityThreshold = 100;\n                    const vitalityDeviation = vitality - vitalityThreshold;\n                    const expectedDrain = fetalEnergyDrain * 7; // 一周的预期消耗\n                    \n                    // 营养盈余或亏损（扣除预期消耗后的剩余）\n                    const netVitality = vitalityDeviation - expectedDrain;\n                    \n                    // 只有净盈余或净亏损较大时才调整\n                    // 阈值：预期消耗的1.5倍\n                    const adjustmentThreshold = expectedDrain * 1.5;\n                    let biasAdjustment = 0;\n                    \n                    // 多胎惩罚系数：胎数越多，营养不足时影响越大\n                    const fetusCountPenalty = Math.sqrt(pregnant.length); // 1胎=1.0, 2胎=1.41, 3胎=1.73, 4胎=2.0\n                    \n                    if (netVitality > adjustmentThreshold) {\n                        // 营养大量盈余，胎儿缓慢增重\n                        biasAdjustment = (netVitality - adjustmentThreshold) / 5000;\n                    } else if (netVitality < -adjustmentThreshold) {\n                        // 营养大量亏损，胎儿缓慢减重（多胎惩罚）\n                        biasAdjustment = (netVitality + adjustmentThreshold) / 5000 * fetusCountPenalty;\n                    }\n                    // 否则在合理范围内，不调整\n                    \n                    for (let i=0; i<pregnant.length; i++){\n                        this.bsAdjustFetalWeight(char, i, biasAdjustment);\n                    }\n                    \n                    // 调整胎儿亲密度\n                    this.bsAdjustAffinity(char, 0.25);\n                    \n                    // 周护理：补充一周消耗的1.0倍（在胎重调整后，模拟定期营养补充）\n                    const weeklyRecovery = weeklyDrain * 1.0;\n                    this.incvar(`bs.${char}.vitality`, weeklyRecovery);\n                    console.log(`Weekly care for ${char}: vitality +${weeklyRecovery.toFixed(1)} (100% of weekly drain: ${weeklyDrain.toFixed(1)})`);\n                }\n                //跨月\n                if (isNewMonth && isHere && !this.getvar(`bs.${char}.drainImmune`, { defaults: false })){\n                    let fetalBiasSum = 0;\n                    for(let fetus of pregnant) {\n                        fetalBiasSum += fetus.fetalBias;\n                    }\n                    let fetalBiasAvg = pregnant.length > 0 ? fetalBiasSum / pregnant.length : 0;\n                    let adjustBreedTolerance = (1 - fetalBiasAvg) * 0.01;  // 胎儿偏小，适应力提升；偏大，适应力降低\n                    let adjustBirthDifficulty = (fetalBiasAvg - 1) * 0.02; // 胎儿偏小，难产率降低；偏大，难产率上升\n                    this.incvar(`bs.${char}.breedTolerance`, adjustBreedTolerance);\n                    this.incvar(`bs.${char}.birthDifficulty`, adjustBirthDifficulty);\n                    \n                    // 胎梦事件\n                    this.bsFetalDream(char);\n                }\n\n                \n            } else if (stage === '产前阵痛') {\n                if(_.random(1, 3) === 1) {\n                    this.bsSetStageWithOrgasmOvulation(char, '第一产程', { days: 1 });\n                }\n            } else if (bsLaborStage.includes(stage)) {\n                this.bsInLabor(char, passed);\n            } else if (stage === '假孕期') {\n                // 假孕期处理，使用pregnantDays\n                let pregnantDays = this.getvar(`bs.${char}.pregnantDays`, { defaults: 0 });\n                pregnantDays += passed;\n                this.setvar(`bs.${char}.pregnantDays`, pregnantDays);\n                \n                // 检查假孕期是否结束\n                let gestationSpeed = this.getvar(`bs.${char}.gestationSpeed`, { defaults: 1.0 });\n                let maxPseudoPregnancyDays = Math.floor(pregnancyStageDays['孕早期'] * gestationSpeed);\n                \n                if(pregnantDays >= maxPseudoPregnancyDays) {\n                    // 假孕期结束，进入月经期\n                    this.bsSetStageWithOrgasmOvulation(char, '月经期', { days: 1 });\n                    this.setvar(`bs.${char}.notifySecondary`, `${char}的假孕症状消失了`);\n                }\n            } else if (stage === '产后恢复') {\n                // 直接使用存储的产后恢复天数\n                let recoveryDays = this.getvar(`bs.${char}.recoveryDays`, { defaults: 42 }); // 默认6周\n                if(newDayCount > recoveryDays) {\n                    this.bsSetStageWithOrgasmOvulation(char, _.sample(bsMenstrualStage), { days: 1, pregnant: [] });\n                }\n            } else if (stage == '已受精') {\n                if(newDays > 1.5) {\n                    // 著床判定，与vitality相关\n                    const vitality = this.getvar(`bs.${char}.vitality`, { defaults: 100 });\n                    const implantationFailChance = vitality < 100 ? (100 - vitality) : 0;\n                    \n                    if(_.random(0, 99) < implantationFailChance) {\n                        // 著床失败，进入黄体期\n                        this.bsSetStageWithOrgasmOvulation(char, '黄体期', { days: 1 });\n                        this.setvar(`bs.${char}.notifySecondary`, `${char}因身体虚弱，胚胎著床失败`);\n                    } else {\n                        // 著床成功，进入孕早期\n                        this.bsSetStageWithOrgasmOvulation(char, '孕早期', { days: 1 });\n                        // 懷孕生理參數更新：根據胎兒種族調整gestationSpeed和birthDifficulty\n                        this.bsUpdatePregnancyPhysiology(char);\n                        // 妊娠經驗+1\n                        this.incvar(`bs.${char}.pregnantExperience`, 1);\n                    }\n                }\n            }\n            // 代谢物積累\n            // 基础代谢物累积（每小时 (1+fetalEnergyDrain)*2，强化妊娠影响）\n            if (!metabolismImmune && isHere && isNewHour) {\n                this.bsUpdateMetabolism(char, (1+fetalEnergyDrain)*2);\n                this.bsUpdateMetabolism(char, -((1+fetalEnergyDrain)*2));\n            }\n            \n            // 跨周或跨月时清空代谢物\n            if ((isNewWeek || isNewMonth)) {\n                if (!metabolismImmune) {\n                    this.setvar(`bs.${char}.urine`, 0);\n                    this.setvar(`bs.${char}.stool`, 0);\n                    this.setvar(`bs.${char}.hunger`, 0);\n                    this.setvar(`bs.${char}.sleep`, 0);\n                }\n            }\n\n            if((stage === '排卵期' || stage === '已受精') && isNewDay) {\n                // 排卵期每天都有机会排卵\n                this.bsAddEggs(char, 1);\n            }\n\n            let eggs = data.eggs || 0;\n            if(eggs > 0) {\n                // 卵子只在非排卵期减少\n                if(isNewDay && stage !== '排卵期') {\n                    eggs -= 1;\n                }\n                if(stage === '月经期' && isNewHour) {\n                    eggs = 0;\n                }\n            }\n            for(let egg = 1; egg <= eggs; egg++) {\n                let impregnationDifficulty = this.getvar(`bs.${char}.impregnationDifficulty`, { defaults: 1.0 });\n                const chance = _.clamp(passed / (1 / 24) * 0.5 / impregnationDifficulty, 0.001, 0.8);\n                let sperms = this.getvar(`bs.${char}.sperms`, { defaults: [] });\n                let availableSperms = sperms.filter(s => s.value > 0);\n                const totalSperm = availableSperms.reduce((sum, s) => sum + s.value, 0);\n                \n                console.log(`impregnate chance ${chance * 100}% for ${char} (difficulty: ${impregnationDifficulty}, total sperm: ${totalSperm})`);\n                \n                if(totalSperm > 0) {\n                    for(let sperm of availableSperms) {\n                        if(_.random(0.001, 1.0) <= chance * sperm.value / totalSperm) {\n                            this.bsAddSperm(char, sperm.male, -Math.min(sperm.value, 20*impregnationDifficulty));\n                            this.bsImpregnate(char, sperm.male);\n                        eggs -= 1;\n                            break; // 一个卵子只能受精一次\n                        }\n                    }\n                }\n            }\n\n            if(bsMenstrualStage.includes(stage) && data.fetuses > 0) {\n                this.bsSetStageWithOrgasmOvulation(char, '已受精', { days: 1 });\n            }\n            \n            let sperms = this.getvar(`bs.${char}.sperms`, { defaults: [] });\n            if(sperms.length > 0) {\n                if(stage === '月经期' && isNewHour) {\n                    // 月经期每小时清空所有精子\n                    this.setvar(`bs.${char}.sperms`, []);\n                } else {\n                    // 其他时期按时间流逝减少精子\n                    this.bsDrainSperm(char, passed * 10);\n                }\n            }\n            // 月经周期, 已受精, 孕早期, 和产后恢复都允许精子留存\n            if(!bsMenstrualStage.includes(stage) && stage !== '已受精' && stage !== '孕早期' && stage !== '产后恢复') {\n                this.setvar(`bs.${char}.sperms`, []);\n            }\n            \n            this.setvar(`bs.${char}.eggs`, eggs);\n            \n            if (isNewDay) {\n                // 清空过期的性伴侣信息（超过一个完整月经周期）\n                let totalMenstrualDays = 0;\n                for(let stageName of bsMenstrualStage) {\n                    totalMenstrualDays += menstrualStageDays[stageName];\n                }\n                let menstrualLengthRatio = this.getvar(`bs.${char}.menstrualLengthRatio`, { defaults: 1.0 });\n                let fullCycleDays = totalMenstrualDays * menstrualLengthRatio;\n                \n                // 如果当前天数超过一个完整周期，清空latestSexPartner\n                if(newDayCount >= fullCycleDays) {\n                    this.setvar(`bs.${char}.latestSexPartner`, null);\n                }\n\n\n                // 安全措施：非怀孕角色定期重置妊娠心情指标\n                if (!bsPregnancyStage.includes(stage) && stage !== '产前阵痛' && stage !== '已受精' && stage !== '假孕期' && !bsLaborStage.includes(stage)) {\n                    this.setvar(`bs.${char}.pregnancyAwareness`, 0);\n                    this.setvar(`bs.${char}.pregnancyAcceptance`, 0);\n                    this.setvar(`bs.${char}.pregnancyDisplay`, 0);\n                    this.setvar(`bs.${char}.pregnancyConfidence`, 0);\n                }\n                // 安全措施: 開啟代謝物免疫時，定期歸0\n                if(metabolismImmune){\n                    this.setvar(`bs.${char}.urine`, 0);\n                    this.setvar(`bs.${char}.stool`, 0);\n                    this.setvar(`bs.${char}.hunger`, 0);\n                    this.setvar(`bs.${char}.sleep`, 0);\n                }\n            }\n            \n            // 增加孩子年龄\n            for(const child of data.child || []) {\n                child.age += passed;\n            }\n\n            this.bsNotifyCycle(char);\n        }\n    }\n});\n\n// 产前阵痛抵抗判定（补救措施）\ndefine('bsResistLabor', function(female) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    \n    const stage = this.getvar(`bs.${female}.stage`);\n    \n    // 只能在产前阵痛阶段调用\n    if(stage !== '产前阵痛') {\n        this.setvar(`bs.${female}.notifySecondary`, `${female}不在产前阵痛阶段，无法执行抵抗判定`);\n        return;\n    }\n    \n    // 获取相关参数\n    const vitality = this.getvar(`bs.${female}.vitality`, { defaults: 100 });\n    const uterinePressure = this.getvar(`bs.${female}.uterinePressure`, { defaults: 0 });\n    const fetalEnergyDrain = this.bsCalculateFetalEnergyDrain(female);\n    const birthDifficulty = this.getvar(`bs.${female}.birthDifficulty`, { defaults: 1.0 });\n    const breedTolerance = this.getvar(`bs.${female}.breedTolerance`, { defaults: 1.0 });\n    \n    // 计算判定次数：(fetalEnergyDrain + birthDifficulty - breedTolerance)，最少1次\n    const judgeCount = Math.max(1, Math.round(fetalEnergyDrain + birthDifficulty - breedTolerance));\n    \n    let allPassed = true;\n    const results = [];\n    \n    // 执行多次判定\n    for(let i = 0; i < judgeCount; i++) {\n        const threshold = _.random(0, Math.floor(uterinePressure));\n        const resistance = vitality;\n        const passed = resistance > threshold;\n        \n        results.push({\n            round: i + 1,\n            resistance: resistance,\n            threshold: threshold,\n            passed: passed\n        });\n        \n        if(!passed) {\n            allPassed = false;\n            break; // 只要有一次没过就失败\n        }\n    }\n    \n    // 根据判定结果设置阶段\n    if(allPassed) {\n        // 全部通过：退回原来的怀孕阶段（只能是'孕晚期'、'临产期'或'逾期'）\n        const pregnantDays = this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 });\n        const gestationSpeed = this.getvar(`bs.${female}.gestationSpeed`, { defaults: 1.0 });\n        \n        // 根据天数判断应该回到哪个阶段（只有晚期、临产期、逾期）\n        let targetStage = '孕晚期'; // 默认孕晚期\n        const adjustedDays = pregnantDays * gestationSpeed;\n        \n        if(adjustedDays >= 280) { // 40周+，逾期\n            targetStage = '逾期';\n        } else if(adjustedDays >= 252) { // 36周+，临产期\n            targetStage = '临产期';\n        } else {\n            targetStage = '孕晚期'; // 27周+，孕晚期\n        }\n        \n        // 宫压减半\n        const newUterinePressure = Math.floor(uterinePressure / 2);\n        \n        this.bsSetStageWithOrgasmOvulation(female, targetStage, { \n            days: 1,\n            uterinePressure: newUterinePressure\n        });\n        \n        this.setvar(`bs.${female}.notifySecondary`, \n            `${female}通过了${judgeCount}次抵抗判定，成功延缓分娩！回到${targetStage}，宫压从${uterinePressure.toFixed(1)}降至${newUterinePressure.toFixed(1)}`);\n        \n        console.log(`${female} resist labor SUCCESS: ${judgeCount} rounds all passed, return to ${targetStage}`);\n    } else {\n        // 有判定失败：进入第一产程\n        this.bsSetStageWithOrgasmOvulation(female, '第一产程', { days: 1 });\n        \n        const failedRound = results.findIndex(r => !r.passed) + 1;\n        this.setvar(`bs.${female}.notifySecondary`, \n            `${female}在第${failedRound}/${judgeCount}次判定中失败，无法抵抗，进入分娩！`);\n        \n        console.log(`${female} resist labor FAILED: failed at round ${failedRound}/${judgeCount}`);\n    }\n    \n    // 详细日志\n    console.log(`Resist Labor for ${female}:`, {\n        judgeCount,\n        vitality,\n        uterinePressure,\n        fetalEnergyDrain: fetalEnergyDrain.toFixed(2),\n        birthDifficulty,\n        breedTolerance,\n        results,\n        allPassed\n    });\n});\n\ndefine('bsInLabor', function(female, passed) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    let stage = this.getvar(`bs.${female}.stage`);\n    let pregnant = this.getvar(`bs.${female}.pregnant`, { defaults: [] });\n    let fetuses = this.getvar(`bs.${female}.fetuses`, { defaults: 1 });\n    let birthDifficulty = this.getvar(`bs.${female}.birthDifficulty`, { defaults: 1.0 });\n    let uterinePressure = this.getvar(`bs.${female}.uterinePressure`, { defaults: 0 });\n    let libido = this.getvar(`bs.${female}.libido`, { defaults: 0 });\n    \n    // 性欲加快产程：libido越高，产程进展越快\n    // libido=0: 1.0x, libido=75: 1.5x, libido=150: 2.0x\n    let libidoMultiplier = 1.0 + (libido / 150);\n    \n    let passedHours = passed * 24 * libidoMultiplier; // 将天数转换为小时，并应用性欲加速\n    \n    // 计算各产程所需时间\n    let t1 = (laborStageBaseHours['第一产程'] + (fetuses - 1) * laborStageIncrement['第一产程']) * birthDifficulty;\n    let t2 = (laborStageBaseHours['第二产程'] + (fetuses - 1) * laborStageIncrement['第二产程']) * birthDifficulty;\n    let t3 = (laborStageBaseHours['第三产程'] + (fetuses - 1) * laborStageIncrement['第三产程']) * birthDifficulty;\n    \n    // 获取当前产程已进行的时间\n    let currentStageHours = this.getvar(`bs.${female}.laborHours`, { defaults: 0 });\n\n    if(uterinePressure < 80){\n        let chanceToStall = 100 - uterinePressure;\n        if (_.random(0, 99) < chanceToStall) {\n            // 产程停滞，不推进时间\n            this.setvar(`bs.${female}.notifySecondary`, `${female}的子宫收缩微弱，产程进展停滞`);\n            return; \n        }\n    } else if(uterinePressure >= 125) {\n        // 当子宫压力达到125时，产程加速\n        if(stage === '第一产程') {\n            // 直接进入第二产程\n            this.bsSetStageWithOrgasmOvulation(female, '第二产程');\n            this.setvar(`bs.${female}.notifySecondary`, `${female}的子宫压力过大，产程加速！`);\n            this.bsNotifyCycle(female, true);\n        } else if(stage === '第二产程') {\n            // 第二产程加速，让一个胎儿出生\n            if(pregnant.length > 0) {\n                let msg = this.getvar(`bs.${female}.notifySecondary`, { defaults: '' });\n                let baby = pregnant.shift();\n                msg += `${female} 生下了 ${baby.fathers} 的孩子，性别为 ${baby.gender}\\n`;\n                \n                // 保存孩子信息\n                this.bsInsertBabyInfo(female, baby);\n                \n                this.setvar(`bs.${female}.pregnant`, pregnant);\n                this.setvar(`bs.${female}.notifySecondary`, msg);\n                \n                // 如果所有胎儿都已出生，进入第三产程\n                if(pregnant.length === 0) {\n                    this.bsSetStageWithOrgasmOvulation(female, '第三产程');\n                    this.bsNotifyCycle(female, true);\n                }\n            }\n        } else if(stage === '第三产程') {\n            // 第三产程直接结束分娩\n            this.bsChildbirth(female);\n        }\n        return;\n    }\n\n    currentStageHours += passedHours;\n    this.setvar(`bs.${female}.laborHours`, currentStageHours);\n    \n    // 日志：显示性欲对产程的影响\n    if(libido > 0) {\n        console.log(`${female} labor progress: libido=${libido}, multiplier=${libidoMultiplier.toFixed(2)}x, effective hours added=${passedHours.toFixed(2)}`);\n    }\n    // 根据当前产程判断是否进入下一阶段\n    if(stage === '第一产程'){\n        if(currentStageHours>=t1){\n            // 进入第二产程\n            this.bsSetStageWithOrgasmOvulation(female, '第二产程');\n            this.bsNotifyCycle(female, true);\n        }\n    } else if(stage === '第二产程') {\n        // 计算自第一产程结束后，在第二产程里到底过了多少小时\n        let hoursInSecond = currentStageHours - t1;\n        // 一个胎儿出生需要的小时数\n        let inc2 = laborStageIncrement['第二产程'] * birthDifficulty;        \n        // 能出生多少个（不超过剩余胎儿数）\n        let births = Math.min(Math.floor(hoursInSecond / inc2), pregnant.length);\n        // 先取出已经累积的信息（默认空字符串）\n        let msg = this.getvar(`bs.${female}.notifySecondary`, { defaults: '' });\n\n        // 如果时间累积足够让至少一个胎儿出生\n        if (births > 0) {\n            // 依序出生\n            for (let i = 0; i < births; i++) {\n                let baby = pregnant.shift();\n                msg += `${female} 生下了 ${baby.fathers} 的孩子，性别为 ${baby.gender}\\n`;\n                \n                // 保存孩子信息\n                this.bsInsertBabyInfo(female, baby);\n            }\n            // 更新剩余的胎儿列表\n            this.setvar(`bs.${female}.pregnant`, pregnant);\n            // 写回累加后的字符串\n            this.setvar(`bs.${female}.notifySecondary`, msg);\n        }\n\n        if (pregnant.length === 0)  {\n            this.bsSetStageWithOrgasmOvulation(female, '第三产程');\n            this.bsNotifyCycle(female, true);\n        }\n        \n    } else if(stage === '第三产程') {\n        // 总耗时达到 t3, 分娩结束\n        if (currentStageHours >= t1 + t2 + t3) {\n            this.bsChildbirth(female);\n        }\n    }\n});\n\ndefine('bsInsertFetus', function(female, options = {}) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    \n    // 检查特殊胎儿类型的条件\n    const stage = this.getvar(`bs.${female}.stage`);\n    if(['异期胎', '嵌套胎'].includes(options.zygoteType) && stage !== '孕早期') {\n        console.log(`Cannot implant ${options.zygoteType} for ${female}: not in early pregnancy stage`);\n        return;\n    }\n    \n    // 如果isClear为true,清空当前状态\n    if(options.isClear) {\n        this.bsSetStageWithOrgasmOvulation(female, '已受精');\n        this.setvar(`bs.${female}.pregnant`, []);\n        this.setvar(`bs.${female}.fetuses`, 0);\n        this.setvar(`bs.${female}.twinCounter`, 0);\n        this.setvar(`bs.${female}.pregnantDays`, 0);\n        this.setvar(`bs.${female}.laborHours`, 0);\n        this.setvar(`bs.${female}.abortionImmune`, false);\n    }\n    \n    // 获取当前怀孕状态\n    let pregnant = this.getvar(`bs.${female}.pregnant`, { defaults: [] });\n    let fetuses = this.getvar(`bs.${female}.fetuses`, { defaults: 0 });\n    let twinCounter = this.getvar(`bs.${female}.twinCounter`, { defaults: 0 });\n    \n    // 如果pregnant为空（未怀孕），将stage设置为'已受精'\n    if(pregnant.length === 0) {\n        this.setvar(`bs.${female}.stage`, '已受精');\n        this.setvar(`bs.${female}.orgasmOvulationUsed`, false);\n    }\n    \n    // 胎儿类型与生长偏置对应表\n    const zygoteTypeBiasMap = {\n        '独胎': [0.79, 1.26],\n        '厚养胚': [1.26, 1.58],\n        '经期胚': [0.63, 0.79],\n        '自交': [1.0, 1.26],\n        '双母源': [0.5, 0.63],\n        '双父源': [1.58, 2.0],\n        'DCDA': [0.79, 1.0],\n        'MCMA': [0.63, 1.0],\n        'MCDA': [0.63, 1.0],\n        'TCTA': [0.63, 0.79],\n        'MCTA': [0.5, 0.79],\n        'MCMAx3': [0.5, 0.79],\n        'QCQA': [0.5, 0.63],\n        'MCQA': [0.4, 0.63],\n        'MCMAx4': [0.4, 0.63],\n        '早期融合卵': [1.26, 1.58],\n        '解离纯化x2': [1.0, 1.0],\n        '解离纯化x3': [1.0, 1.0],\n        '解离纯化x4': [1.0, 1.0],\n        '多倍体': [2.0, 2.51],\n        '异期胎': [0.5, 0.63],\n        '嵌套内胎': [0.4, 0.5],\n        '嵌套外胎': [1.26, 1.58],\n        'S-MCMA': [0.63, 1.26],\n        'S-MCDA': [0.63, 1.26],\n        'S-DCDA': [0.79, 1.26]\n    };\n\n    // 处理嵌套胎的特殊情况\n    if(options.zygoteType === '嵌套胎') {\n        // 只查找独胎，不限制性别和fetalBias\n        let existingFetus = pregnant.find(f => f.zygoteType === '独胎');\n        \n        if(!existingFetus) {\n            console.log(`Cannot implant nested fetus for ${female}: no host fetus found`);\n            return;\n        }\n        \n        // 将独胎转换为嵌套外胎\n        existingFetus.zygoteType = '嵌套外胎';\n        // 只有当没有指定fetalBias时，才使用zygoteTypeBiasMap中的随机范围\n        if(options.fetalBias === undefined) {\n            const biasRange = zygoteTypeBiasMap['嵌套外胎'];\n            existingFetus.fetalBias = _.random(biasRange[0] * 100, biasRange[1] * 100) / 100;\n        }\n        // 如果指定了fetalBias，嵌套外胎保持原样\n        \n        // 自動計算胎兒種族和胚胎類型\n        let calculatedRace = options.race;\n        let calculatedEmbryoType = options.embryoType;\n        \n        if(!calculatedRace && options.fathers) {\n            calculatedRace = this.bsCalculateFetusRace(female, options.fathers);\n        }\n        \n        if(!calculatedEmbryoType && calculatedRace) {\n            calculatedEmbryoType = this.bsCalculateFetusEmbryoType(calculatedRace);\n        }\n        \n        // 创建嵌套内胎\n        let nestedFetus = {\n            fathers: options.fathers || null,\n            race: calculatedRace || null,\n            gender: options.gender || this.bsCalculateGenderByRace(calculatedRace),\n            twinId: twinCounter,\n            zygoteType: '嵌套内胎',\n            embryoType: calculatedEmbryoType || null,\n            impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n            fetalAge: 0,\n            fetalBias: options.fetalBias !== undefined ? options.fetalBias : (() => {\n                const biasRange = zygoteTypeBiasMap['嵌套内胎'];\n                return _.random(biasRange[0] * 100, biasRange[1] * 100) / 100;\n            })(),\n            affinity: options.affinity || 0,\n        };\n        \n        existingFetus.twinId = twinCounter;\n        this.incvar(`bs.${female}.twinCounter`, 1);\n        \n        // 添加到怀孕列表\n        pregnant.push(nestedFetus);\n        fetuses += 1;\n        \n        // 更新状态\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        \n        // 更新全域种族和合子类型统计\n        this.bsUpdateGlobalRaceAndTypes();\n        return;\n    }\n    \n    // 处理解离纯化x4特殊情况\n    if(options.zygoteType === '解离纯化x4') {\n        // 检查race参数是否为AxBxCxD格式\n        if(!options.race || !(options.race.includes('x') || options.race.includes('X'))) {\n            console.log(`Cannot implant 解离纯化x4 for ${female}: race must be in AxBxCxD format`);\n            return;\n        }\n        \n        // 解析四个种族\n        const races = options.race.toLowerCase().split('x');\n        if(races.length !== 4) {\n            console.log(`Cannot implant 解离纯化x4 for ${female}: race must contain exactly 4 parts (AxBxCxD format)`);\n            return;\n        }\n        \n        const quadrupletId = twinCounter;\n        const genders = ['男', '男', '女', '女'];\n        const shuffledGenders = _.shuffle(genders);\n        \n        // 创建四个纯血胎儿，两男两女，胎重都是1.0\n        for (let i = 0; i < 4; i++) {\n            // 解离纯化x4是纯血胎儿，直接根据种族确定胚胎类型\n            let calculatedEmbryoType = options.embryoType;\n            if(!calculatedEmbryoType) {\n                calculatedEmbryoType = this.bsCalculateFetusEmbryoType(races[i]);\n            }\n            \n            let pureFetus = {\n                fathers: options.fathers || null,\n                race: races[i], // 使用解析出的四个种族\n                gender: shuffledGenders[i],\n                twinId: quadrupletId,\n                zygoteType: '解离纯化x4',\n                embryoType: calculatedEmbryoType,\n                impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n                fetalAge: 0,\n                fetalBias: 1.0, // 固定胎重1.0\n                affinity: options.affinity || 0,\n            };\n            pregnant.push(pureFetus);\n        }\n        \n        this.incvar(`bs.${female}.twinCounter`, 1);\n        fetuses += 4;\n        \n        // 更新状态\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        \n        // 更新全域种族和合子类型统计\n        this.bsUpdateGlobalRaceAndTypes();\n        return;\n    }\n    \n    // 处理解离纯化x3特殊情况\n    if(options.zygoteType === '解离纯化x3') {\n        // 检查race参数是否为AxBxC格式\n        if(!options.race || !(options.race.includes('x') || options.race.includes('X'))) {\n            console.log(`Cannot implant 解离纯化x3 for ${female}: race must be in AxBxC format`);\n            return;\n        }\n        \n        // 解析三个种族\n        const races = options.race.toLowerCase().split('x');\n        if(races.length !== 3) {\n            console.log(`Cannot implant 解离纯化x3 for ${female}: race must contain exactly 3 parts (AxBxC format)`);\n            return;\n        }\n        \n        const tripletId = twinCounter;\n        const genders = options.gender ? options.gender.split(',').map(g => g.trim()) : \n                        (_.random(0, 1) ? ['女', '女', '男'] : ['男', '男', '女']);\n        \n        if(genders.length !== 3) {\n            console.log(`Cannot implant 解离纯化x3 for ${female}: gender must be three values separated by comma`);\n            return;\n        }\n        \n        // 创建三个纯血胎儿，2女1男或1女2男，胎重都是1.0\n        for (let i = 0; i < 3; i++) {\n            let calculatedEmbryoType = options.embryoType;\n            if(!calculatedEmbryoType) {\n                calculatedEmbryoType = this.bsCalculateFetusEmbryoType(races[i]);\n            }\n            \n            let pureFetus = {\n                fathers: options.fathers || null,\n                race: races[i], // 使用解析出的三个种族\n                gender: genders[i],\n                twinId: tripletId,\n                zygoteType: '解离纯化x3',\n                embryoType: calculatedEmbryoType,\n                impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n                fetalAge: 0,\n                fetalBias: 1.0, // 固定胎重1.0\n                affinity: options.affinity || 0,\n            };\n            pregnant.push(pureFetus);\n        }\n        \n        this.incvar(`bs.${female}.twinCounter`, 1);\n        fetuses += 3;\n        \n        // 更新状态\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        \n        // 更新全域种族和合子类型统计\n        this.bsUpdateGlobalRaceAndTypes();\n        return;\n    }\n    \n    // 同卵多胞胎类型（一次性注入全部胎儿）\n    const identicalTwinTypes = {\n        'MCMA': 2, 'MCDA': 2, 'DCDA': 2,  // 双胞胎\n        'MCTA': 3, 'TCTA': 3, 'MCMAx3': 3,  // 三胞胎\n        'MCQA': 4, 'QCQA': 4, 'MCMAx4': 4   // 四胞胎\n    };\n    \n    if(identicalTwinTypes[options.zygoteType]) {\n        const count = identicalTwinTypes[options.zygoteType];\n        const twinId = twinCounter;\n        const gender = options.gender || (_.random(0, 1) ? '男' : '女'); // 同卵同性别\n        \n        // 自動計算胎兒種族和胚胎類型\n        let calculatedRace = options.race;\n        let calculatedEmbryoType = options.embryoType;\n        \n        if(!calculatedRace && options.fathers) {\n            calculatedRace = this.bsCalculateFetusRace(female, options.fathers);\n        }\n        \n        if(!calculatedEmbryoType && calculatedRace) {\n            calculatedEmbryoType = this.bsCalculateFetusEmbryoType(calculatedRace);\n        }\n        \n        const biasRange = zygoteTypeBiasMap[options.zygoteType] || [0.79, 1.0];\n        let mirrorBias = null;\n        \n        // 镜像类型需要预先生成一个共享的胎重\n        if(['MCMA', 'MCMAx3', 'MCMAx4'].includes(options.zygoteType) && options.fetalBias === undefined) {\n            mirrorBias = _.random(biasRange[0] * 100, biasRange[1] * 100) / 100;\n        }\n        \n        // 创建多个胎儿\n        for (let i = 0; i < count; i++) {\n            let fetalBias;\n            if(options.fetalBias !== undefined) {\n                fetalBias = options.fetalBias;\n            } else if(['MCMA', 'MCMAx3', 'MCMAx4'].includes(options.zygoteType)) {\n                // 镜像类型：使用共享胎重\n                fetalBias = mirrorBias;\n            } else {\n                // 非镜像类型：随机胎重\n                fetalBias = _.random(biasRange[0] * 100, biasRange[1] * 100) / 100;\n            }\n            \n            let twinFetus = {\n                fathers: options.fathers || null,\n                race: calculatedRace || null,\n                gender: gender,\n                twinId: twinId,\n                zygoteType: options.zygoteType,\n                embryoType: calculatedEmbryoType || null,\n                impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n                fetalAge: 0,\n                fetalBias: fetalBias,\n                affinity: options.affinity || 0,\n            };\n            pregnant.push(twinFetus);\n        }\n        \n        this.incvar(`bs.${female}.twinCounter`, 1);\n        fetuses += count;\n        \n        // 更新状态\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        \n        // 更新全域种族和合子类型统计\n        this.bsUpdateGlobalRaceAndTypes();\n        return;\n    }\n    \n    // 半同卵双胞胎（需要两个性别和两个父亲）\n    if(['S-MCMA', 'S-MCDA', 'S-DCDA'].includes(options.zygoteType)) {\n        const twinId = twinCounter;\n        \n        // 解析性别（逗号分隔）\n        const genders = options.gender ? options.gender.split(',').map(g => g.trim()) : [\n            (_.random(0, 1) ? '男' : '女'),\n            (_.random(0, 1) ? '男' : '女')\n        ];\n        \n        if(genders.length !== 2) {\n            console.log(`Cannot implant semi-identical twins: gender must be two values separated by comma, got: ${options.gender}`);\n            return;\n        }\n        \n        // 解析父亲（逗号分隔）\n        const fathers = options.fathers ? options.fathers.split(',').map(f => f.trim()) : [null, null];\n        if(fathers.length !== 2) {\n            console.log(`Cannot implant semi-identical twins: fathers must be two values separated by comma, got: ${options.fathers}`);\n            return;\n        }\n        \n        const fatherStr = fathers.join('+');\n        \n        // 自動計算胎兒種族和胚胎類型\n        let calculatedRace = options.race;\n        let calculatedEmbryoType = options.embryoType;\n        \n        if(!calculatedRace && fathers[0]) {\n            calculatedRace = this.bsCalculateFetusRace(female, fathers[0]);\n        }\n        \n        if(!calculatedEmbryoType && calculatedRace) {\n            calculatedEmbryoType = this.bsCalculateFetusEmbryoType(calculatedRace);\n        }\n        \n        const biasRange = zygoteTypeBiasMap[options.zygoteType] || [0.79, 1.26];\n        let semiMirrorBias = null;\n        \n        // S-MCMA镜像类型需要预先生成一个共享的胎重\n        if(options.zygoteType === 'S-MCMA' && options.fetalBias === undefined) {\n            semiMirrorBias = _.random(biasRange[0] * 100, biasRange[1] * 100) / 100;\n        }\n        \n        // 创建两个半同卵胎儿\n        for (let i = 0; i < 2; i++) {\n            let fetalBias;\n            if(options.fetalBias !== undefined) {\n                fetalBias = options.fetalBias;\n            } else if(options.zygoteType === 'S-MCMA') {\n                // S-MCMA：镜像，使用共享胎重\n                fetalBias = semiMirrorBias;\n            } else {\n                // 其他类型：随机胎重\n                fetalBias = _.random(biasRange[0] * 100, biasRange[1] * 100) / 100;\n            }\n            \n            let semiTwin = {\n                fathers: fatherStr,\n                race: calculatedRace || null,\n                gender: genders[i],\n                twinId: twinId,\n                zygoteType: options.zygoteType,\n                embryoType: calculatedEmbryoType || null,\n                impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n                fetalAge: 0,\n                fetalBias: fetalBias,\n                affinity: options.affinity || 0,\n            };\n            pregnant.push(semiTwin);\n        }\n        \n        this.incvar(`bs.${female}.twinCounter`, 1);\n        fetuses += 2;\n        \n        // 更新状态\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        return;\n    }\n    \n    // 解离纯化x2（一次性注入两个胎儿：母方种族和父方种族各一胎，必为一男一女）\n    if(options.zygoteType === '解离纯化x2') {\n        const twinId = twinCounter;\n        const femaleRace = this.getvar(`bs.${female}.race`, { defaults: null });\n        const maleRace = options.fathers ? this.getvar(`bs.${options.fathers}.race`, { defaults: null }) : null;\n        const sharedFetalBias = options.fetalBias !== undefined ? options.fetalBias : 1.0; // 固定胎重1.0\n        \n        // 随机决定性别分配（50%概率）\n        const motherIsMale = _.random(0, 1); // true = 母方种族男胎, false = 母方种族女胎\n        \n        // 母方种族胎儿\n        let motherSideFetus = {\n            fathers: options.fathers || null,\n            race: femaleRace,\n            gender: motherIsMale ? '男' : '女',\n            twinId: twinId,\n            zygoteType: '解离纯化x2',\n            embryoType: this.bsCalculateFetusEmbryoType(femaleRace),\n            impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n            fetalAge: 0,\n            fetalBias: sharedFetalBias,\n            affinity: options.affinity || 0,\n        };\n        \n        // 父方种族胎儿（性别相反）\n        let fatherSideFetus = {\n            fathers: options.fathers || null,\n            race: maleRace,\n            gender: motherIsMale ? '女' : '男',\n            twinId: twinId,\n            zygoteType: '解离纯化x2',\n            embryoType: this.bsCalculateFetusEmbryoType(maleRace),\n            impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n            fetalAge: 0,\n            fetalBias: sharedFetalBias,\n            affinity: options.affinity || 0,\n        };\n        \n        pregnant.push(motherSideFetus, fatherSideFetus);\n        this.incvar(`bs.${female}.twinCounter`, 1);\n        fetuses += 2;\n        \n        // 更新状态\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        \n        // 更新全域种族和合子类型统计\n        this.bsUpdateGlobalRaceAndTypes();\n        return;\n    }\n    \n    // 自交（fathers必须为null，自动设为自己）\n    if(options.zygoteType === '自交') {\n        if(options.fathers !== null && options.fathers !== undefined) {\n            console.log(`Cannot implant 自交 for ${female}: fathers must be null (will be set to self)`);\n            return;\n        }\n        \n        const fetusRace = this.bsCalculateFetusRace(female, female);\n        const calculatedEmbryoType = options.embryoType || this.bsCalculateFetusEmbryoType(fetusRace);\n        const biasRange = zygoteTypeBiasMap['自交'];\n        \n        let selfFertilizationFetus = {\n            fathers: female, // 自交时父亲就是自己\n            race: fetusRace,\n            gender: '双性', // 自交固定为双性\n            twinId: null,\n            zygoteType: '自交',\n            embryoType: calculatedEmbryoType,\n            impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n            fetalAge: 0,\n            fetalBias: options.fetalBias !== undefined ? options.fetalBias : _.random(biasRange[0] * 100, biasRange[1] * 100) / 100,\n            affinity: options.affinity || 0,\n        };\n        \n        pregnant.push(selfFertilizationFetus);\n        fetuses += 1;\n        \n        // 更新状态\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        \n        // 更新全域种族和合子类型统计\n        this.bsUpdateGlobalRaceAndTypes();\n        return;\n    }\n    \n    // 双父源（fathers必须是两位，用逗号分隔）\n    if(options.zygoteType === '双父源') {\n        if(!options.fathers || !options.fathers.includes(',')) {\n            console.log(`Cannot implant 双父源 for ${female}: fathers must be two names separated by comma`);\n            return;\n        }\n        \n        // 解析两个父亲\n        const fathers = options.fathers.split(',').map(f => f.trim());\n        if(fathers.length !== 2) {\n            console.log(`Cannot implant 双父源 for ${female}: fathers must be exactly two names separated by comma`);\n            return;\n        }\n        \n        const fatherStr = fathers.join('+');\n        const fetusRace = options.race || this.bsCalculateFetusRace(fathers[0], fathers[1]);\n        const calculatedEmbryoType = options.embryoType || this.bsCalculateFetusEmbryoType(fetusRace);\n        const biasRange = zygoteTypeBiasMap['双父源'];\n        \n        let dualFatherFetus = {\n            fathers: fatherStr,\n            race: fetusRace,\n            gender: '男', // 双父源固定为男性\n            twinId: null,\n            zygoteType: '双父源',\n            embryoType: calculatedEmbryoType,\n            impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n            fetalAge: 0,\n            fetalBias: options.fetalBias !== undefined ? options.fetalBias : _.random(biasRange[0] * 100, biasRange[1] * 100) / 100,\n            affinity: options.affinity || 0,\n        };\n        \n        pregnant.push(dualFatherFetus);\n        fetuses += 1;\n        \n        // 更新状态\n        this.setvar(`bs.${female}.pregnant`, pregnant);\n        this.setvar(`bs.${female}.fetuses`, fetuses);\n        \n        // 更新全域种族和合子类型统计\n        this.bsUpdateGlobalRaceAndTypes();\n        return;\n    }\n    \n    // 单胎或其他类型（独胎、厚养胚、经期胚、早期融合卵、双母源、多倍体、异期胎）\n    // 自動計算胎兒種族和胚胎類型\n    let calculatedRace = options.race;\n    let calculatedEmbryoType = options.embryoType;\n    \n    if(!calculatedRace && options.fathers) {\n        calculatedRace = this.bsCalculateFetusRace(female, options.fathers);\n        console.log(`Auto-calculated fetus race for ${female}: ${calculatedRace}`);\n    }\n    \n    if(!calculatedEmbryoType && calculatedRace) {\n        calculatedEmbryoType = this.bsCalculateFetusEmbryoType(calculatedRace);\n        console.log(`Auto-calculated fetus embryo type for ${female}: ${calculatedEmbryoType}`);\n    }\n    \n    const zygoteType = options.zygoteType || '独胎';\n    const biasRange = zygoteTypeBiasMap[zygoteType] || [1.0, 1.26];\n    \n    // 创建单胎\n    let newFetus = {\n        fathers: options.fathers || null,\n        race: calculatedRace || null,\n        gender: options.gender || (_.random(0, 1) ? '男' : '女'),\n        twinId: null,\n        zygoteType: zygoteType,\n        embryoType: calculatedEmbryoType || null,\n        impregnateDay: this.getvar(`bs.${female}.pregnantDays`, { defaults: 0 }),\n        fetalAge: 0,\n        fetalBias: options.fetalBias !== undefined ? options.fetalBias : _.random(biasRange[0] * 100, biasRange[1] * 100) / 100,\n        affinity: options.affinity || 0,\n    };\n    \n    pregnant.push(newFetus);\n    fetuses += 1;\n    \n    // 更新状态\n    this.setvar(`bs.${female}.pregnant`, pregnant);\n    this.setvar(`bs.${female}.fetuses`, fetuses);\n    \n    // 更新全域种族和合子类型统计\n    this.bsUpdateGlobalRaceAndTypes();\n});\n\ndefine('bsSetMenstrualPhases', function(female, stage) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    \n    // 安全检查：确保当前阶段和目标阶段都是允许的阶段\n    let cur = this.getvar(`bs.${female}.stage`);\n    if(!bsMenstrualStage.includes(cur) && cur !== '产后恢复') {\n        console.log(`Cannot set menstrual phase for ${female}: current stage is not in menstrual cycle or postpartum recovery`);\n        return;\n    }\n    if(!bsMenstrualStage.includes(stage) && stage !== '产后恢复') {\n        console.log(`Cannot set menstrual phase for ${female}: target stage is not in menstrual cycle or postpartum recovery`);\n        return;\n    }\n    \n    // 设置新阶段\n    this.bsSetStageWithOrgasmOvulation(female, stage, { days: 1 });\n    this.bsNotifyCycle(female);\n});\n\ndefine('bsSetPregnantDay', function(female, pregnantDays = 1) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    \n    // 安全检查：确保角色处于怀孕阶段或已受精阶段\n    const currentStage = this.getvar(`bs.${female}.stage`);\n    if(!bsPregnancyStage.includes(currentStage) && currentStage !== '已受精') {\n        console.log(`Cannot set pregnancy days for ${female}: not in pregnancy stage or fertilized stage`);\n        return;\n    }\n    \n    // 设置孕期天数\n    this.setvar(`bs.${female}.pregnantDays`, pregnantDays);\n    let gestationSpeed = this.getvar(`bs.${female}.gestationSpeed`, { defaults: 1.0 });\n    \n    // 如果当前是已受精阶段，且设置的天数超过2天，自动进入孕早期\n    if(currentStage === '已受精' && pregnantDays > 2) {\n        this.setvar(`bs.${female}.stage`, '孕早期');\n    }\n    \n    // 计算总孕期天数（不包括逾期）\n    let totalPregnancyDays = 0;\n    for(let i = 0; i < bsPregnancyStage.length - 1; i++) { // 减1是因为最后一个是\"逾期\"\n        totalPregnancyDays += pregnancyStageDays[bsPregnancyStage[i]] / gestationSpeed;\n    }\n    \n    // 确定当前孕期阶段和当前阶段的天数\n    let stage = '孕早期';\n    let baseDays = 1;\n    let currentStageDays = 1;\n    \n    // 如果超过总孕期天数，直接设置为逾期\n    if(pregnantDays > totalPregnancyDays) {\n        stage = '逾期';\n        currentStageDays = Math.floor(pregnantDays - totalPregnancyDays);\n    } else {\n        // 正常孕期阶段计算\n        for(let i = 0; i < bsPregnancyStage.length - 1; i++) { // 减1是因为最后一个是\"逾期\"\n            let nextBaseDays = baseDays + pregnancyStageDays[bsPregnancyStage[i]] / gestationSpeed;\n            if(pregnantDays >= baseDays && pregnantDays < nextBaseDays) {\n                stage = bsPregnancyStage[i];\n                currentStageDays = Math.floor(pregnantDays - baseDays + 1);\n                break;\n            }\n            baseDays = nextBaseDays;\n        }\n    }\n\n    // 懷孕生理參數更新：根據胎兒種族調整gestationSpeed和birthDifficulty\n    this.bsUpdatePregnancyPhysiology(female);\n    \n    // 更新阶段和当前阶段天数\n    this.setvar(`bs.${female}.stage`, stage);\n    this.setvar(`bs.${female}.days`, currentStageDays);\n    \n    // 更新所有胎儿的实际发育情况與能量消耗\n    let pregnant = this.getvar(`bs.${female}.pregnant`, { defaults: [] });\n    for(let fetus of pregnant) {\n        // 计算胎儿实际发育周数\n        let AgeInDays = (pregnantDays - fetus.impregnateDay) * gestationSpeed * fetus.fetalBias;\n        fetus.fetalAge = AgeInDays / 7;\n    }\n    this.setvar(`bs.${female}.pregnant`, pregnant);\n    \n    // 计算胎儿能量消耗（考虑母体和胎儿种族差异）\n    let fetalEnergyDrain = this.bsCalculateFetalEnergyDrain(female);\n    this.setvar(`bs.${female}.fetalEnergyDrain`, fetalEnergyDrain);\n    this.bsNotifyCycle(female);\n});\n\ndefine('bsInsertBabyInfo', function(female, baby, data = {}) {\n    if(!female || this.variables?.bs?.[female] === null || !baby) return;\n    this.bsInitFemale(female);\n    const child = this.getvar(`bs.${female}.child`, { defaults: [], clone: true }) || [];\n    \n    // 将岁数转换为天数（1岁 = 365天）\n    const ageInDays = (data.age || 0) * 365;\n    \n    const babyInfo = {\n        age: ageInDays,\n        name: data.babyName || null,\n        sex: data.babySex || baby.gender || _.sample(['男', '女']),\n        race: data.babyRace || baby.race || '人类',\n        father: baby.fathers || null\n    };\n    \n    this.setvar(`bs.${female}.child`, _.concat(child, babyInfo));\n    console.log({ female, baby, babyInfo });\n    \n    // 更新全域种族统计\n    this.bsUpdateGlobalRaceAndTypes();\n});\n\ndefine('bsNameChild', function(female, childIndex, name) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    const child = this.getvar(`bs.${female}.child`, { defaults: [] });\n    \n    if(childIndex < 0 || childIndex >= child.length) {\n        console.log(`Invalid child index ${childIndex} for ${female}`);\n        return;\n    }\n    \n    child[childIndex].name = name;\n    this.setvar(`bs.${female}.child`, child);\n    console.log(`Named child ${childIndex} of ${female} as ${name}`);\n});\n\ndefine('bsChildbirth', function(female) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    let fetuses = this.getvar(`bs.${female}.fetuses`);\n    let pregnant = this.getvar(`bs.${female}.pregnant`, { defaults: [] });\n    \n    if(fetuses) {\n        this.incvar(`bs.${female}.birthExperience`, 1);\n        this.setvar(`bs.${female}.notifySecondary`, `${female}生下了${fetuses}个孩子`);\n        \n        // 一次性保存所有剩余的孩子信息\n        for(let baby of pregnant) {\n            this.bsInsertBabyInfo(female, baby);\n        }\n        \n        // 恢復原始生理參數\n        this.bsRestoreOriginalPhysiology(female);\n        \n        this.bsSetStageWithOrgasmOvulation(female, '产后恢复', { \n            days: 1,\n            pregnant: [],\n            fetuses: 0,\n            twinCounter: 0,\n            uterinePressure: 0,\n            laborHours: 0,\n            fetalEnergyDrain: 0,\n            abortionImmune: false\n        });\n\n        // 分娩經驗+1\n        this.incvar(`bs.${female}.birthExperience`, 1);\n    }\n    \n    // 更新全域种族和类型统计（bsInsertBabyInfo已调用，此处确保更新）\n    this.bsUpdateGlobalRaceAndTypes();\n});\n\ndefine('bsAbortion', function(female, force = false, fetusIndex = null) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    let stage = this.getvar(`bs.${female}.stage`);\n    let fetuses = this.getvar(`bs.${female}.fetuses`);\n    let pregnant = this.getvar(`bs.${female}.pregnant`, { defaults: [] });\n    let abortionImmune = this.getvar(`bs.${female}.abortionImmune`, { defaults: false });\n    \n    if(fetuses) {\n        // 检查是否免疫流产（除非force=true）\n        if(abortionImmune && !force) {\n            this.setvar(`bs.${female}.notifySecondary`, `${female}的胚胎受到保护，流产无效，胚胎依旧留着`);\n            return; // 直接返回，不执行流产\n        }\n        \n        // 减胎：移除指定索引的胎儿\n        if(fetusIndex !== null && fetusIndex >= 0 && fetusIndex < pregnant.length) {\n            const removedFetus = pregnant[fetusIndex];\n            pregnant.splice(fetusIndex, 1);\n            fetuses -= 1;\n            \n            this.setvar(`bs.${female}.pregnant`, pregnant);\n            this.setvar(`bs.${female}.fetuses`, fetuses);\n            this.setvar(`bs.${female}.notifySecondary`, `${female}的第${fetusIndex + 1}个胎儿（${removedFetus.gender}，${removedFetus.race}）消失了`);\n            \n            // 如果还有剩余胎儿，只是减胎，不算流产\n            if(fetuses > 0) {\n                console.log(`Reduced fetus count for ${female}: ${fetuses + 1} -> ${fetuses}`);\n                return;\n            }\n            \n            // 如果移除后没有胎儿了，按全部流产处理\n            console.log(`All fetuses removed for ${female}, treating as full abortion`);\n        }\n        \n        // 全部流产\n        if(stage === '已受精') {\n            // 如果是刚受精，直接回到卵泡期，不算流产\n            this.setvar(`bs.${female}.notifySecondary`, `${female}避孕成功`);\n            \n            // 恢復原始生理參數\n            this.bsRestoreOriginalPhysiology(female);\n            \n            this.bsSetStageWithOrgasmOvulation(female, '卵泡期', { \n                days: 1,\n                pregnant: [],\n                fetuses: 0,\n                twinCounter: 0,\n                uterinePressure: 0,\n                laborHours: 0,\n                fetalEnergyDrain: 0,\n                abortionImmune: false\n            });\n        } else {\n            // 其他情况进入产后恢复，算作流产\n            this.setvar(`bs.${female}.notifySecondary`, `${female}流产了`);\n            \n            // 恢復原始生理參數\n            this.bsRestoreOriginalPhysiology(female);\n            \n            this.bsSetStageWithOrgasmOvulation(female, '产后恢复', { \n                days: 1,\n                pregnant: [],\n                fetuses: 0,\n                twinCounter: 0,\n                uterinePressure: 0,\n                laborHours: 0,\n                fetalEnergyDrain: 0,\n                abortionImmune: false\n            });\n            // 流产經驗+1\n            this.incvar(`bs.${female}.miscarriageExperience`, 1);\n        }\n    }\n    \n    // 更新全域种族和类型统计\n    this.bsUpdateGlobalRaceAndTypes();\n});\n\ndefine('bsDrainSperm', function(female, amount) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    let sperms = this.getvar(`bs.${female}.sperms`, { defaults: [] });\n    \n    // 计算总精子数\n    const total = sperms.reduce((sum, s) => sum + s.value, 0);\n    \n    if(total <= amount) {\n        // 如果流出的量大于等于总量，清空所有精子\n        this.setvar(`bs.${female}.sperms`, []);\n        return;\n    }\n    \n    // 计算减少比例\n    const factor = amount / total;\n    \n    // 按比例减少每个父亲的精子数量\n    sperms = sperms.map(s => ({\n        ...s,\n        value: Math.max(Math.floor(s.value - s.value * factor), 0)\n    })).filter(s => s.value > 0);\n    \n    this.setvar(`bs.${female}.sperms`, sperms);\n    \n    // 更新全域种族统计\n    this.bsUpdateGlobalRaceAndTypes();\n});\n\ndefine('bsUpdateCharacterStatus', function(female, options = {}) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    \n    const allowed = [\n        'vitality',\n        'libido', \n        'uterinePressure',\n        'psyStress'\n    ];\n    \n    for (const key of allowed) {\n        if (options[key] !== undefined) {\n            // 添加数值验证\n            let changeValue = options[key];\n            if (typeof changeValue !== 'number' || isNaN(changeValue)) {\n                console.log(`Invalid ${key} change value: ${changeValue} for ${female}, must be a number`);\n                continue;\n            }\n            \n            // 获取当前值\n            const currentValue = this.getvar(`bs.${female}.${key}`, { defaults: 100 });\n            const newValue = currentValue + changeValue;\n            \n            // 根据属性类型进行范围验证和约束\n            let finalValue = newValue;\n            switch(key) {\n                case 'vitality':\n                    finalValue = Math.max(0, Math.min(200, newValue));\n                    break;\n                case 'libido':\n                    finalValue = Math.max(0, Math.min(150, newValue));\n                    break;\n                case 'uterinePressure':\n                    finalValue = Math.max(0, Math.min(150, newValue));\n                    break;\n                case 'psyStress':\n                    finalValue = Math.max(0, Math.min(200, newValue));\n                    break;\n            }\n            \n            // 设置新值\n            this.setvar(`bs.${female}.${key}`, finalValue);\n            console.log(`${female} ${key}: ${currentValue} + ${changeValue} = ${finalValue}`);\n            \n            // 代谢物系统：当metabolismImmune为false时，vitality变化量转化为代谢物\n            const metabolismImmune = this.getvar(`bs.${female}.metabolismImmune`, { defaults: false });\n            if (!metabolismImmune && key === 'vitality' && changeValue !== 0) {\n                // 直接使用变化量，不计算增幅\n                this.bsUpdateMetabolism(female, changeValue);\n            }\n        }\n    }\n    \n    // 宫压限制：非怀孕状态下宫压最多为30\n    if (options.uterinePressure !== undefined) {\n        const stage = this.getvar(`bs.${female}.stage`);\n        const isPregnant = bsPregnancyStage.includes(stage) || stage === '假孕期' || stage === '产前阵痛' || bsLaborStage.includes(stage);\n        \n        // 获取当前宫压值进行检查\n        const currentUterinePressure = this.getvar(`bs.${female}.uterinePressure`, { defaults: 0 });\n        \n        // 非怀孕状态：宫压限制为30\n        if (!isPregnant && currentUterinePressure > 30) {\n            this.setvar(`bs.${female}.uterinePressure`, 30);\n            console.log(`${female} 非怀孕状态宫压限制为30`);\n        }\n    }\n    \n    // 高潮排卵系统：检查性慾值是否达到高潮排卵阈值\n    if (options.libido !== undefined) {\n        const stage = this.getvar(`bs.${female}.stage`);\n        const orgasmOvulationAmount = this.getvar(`bs.${female}.orgasmOvulationAmount`, { defaults: 1 });\n        const orgasmOvulationUsed = this.getvar(`bs.${female}.orgasmOvulationUsed`, { defaults: false });\n        \n        // 检查是否为怀孕状态\n        const isPregnant = bsPregnancyStage.includes(stage)|| stage === '假孕期' || stage === '产前阵痛' || bsLaborStage.includes(stage);\n        \n        // 获取当前性慾值进行检查\n        const currentLibido = this.getvar(`bs.${female}.libido`, { defaults: 0 });\n        \n        // 非怀孕状态：性慾达到100触发高潮排卵\n        if (!isPregnant && currentLibido >= 100 && !orgasmOvulationUsed) {\n            this.bsAddEggs(female, orgasmOvulationAmount);\n            this.setvar(`bs.${female}.libido`, 0);\n            this.setvar(`bs.${female}.orgasmOvulationUsed`, true);\n            this.setvar(`bs.${female}.notifySecondary`, `${female}因高潮而额外排卵，性欲归零`);\n        }\n        // 怀孕状态：性慾达到150触发高潮排卵\n        else if (isPregnant && currentLibido >= 150 && !orgasmOvulationUsed) {\n            this.bsAddEggs(female, orgasmOvulationAmount);\n            this.setvar(`bs.${female}.libido`, 0);\n            this.setvar(`bs.${female}.orgasmOvulationUsed`, true);\n            this.setvar(`bs.${female}.notifySecondary`, `${female}因高潮而额外排卵，性欲归零`);\n        }\n    }\n    \n    // 宫压警告逻辑\n    if (options.uterinePressure !== undefined) {\n        const stage = this.getvar(`bs.${female}.stage`);\n        const currentUterinePressure = this.getvar(`bs.${female}.uterinePressure`, { defaults: 0 });\n        let pressureWarning = '';\n        if (bsPregnancyStage.includes(stage)) {\n            if (stage === '孕早期' && currentUterinePressure > 30) {\n                pressureWarning = `${female}子宫压力过高，有孕早期流产风险`;\n            } else if (stage !== '孕早期' && currentUterinePressure > 50) {\n                if (stage === '孕中期') {\n                    pressureWarning = `${female}子宫压力过高，有流产风险`;\n                } else if (stage === '孕晚期' || stage === '临产期') {\n                    pressureWarning = `${female}子宫压力过高，即将生产`;\n                }\n            } else if (stage === '逾期' && currentUterinePressure > 80) {\n                pressureWarning = `${female}子宫收缩强烈，即将生产`;\n            }\n        }\n        if (pressureWarning) {\n            this.setvar(`bs.${female}.notifySecondary`, pressureWarning);\n        }\n    }\n    \n    console.log(`Updated ${female}'s status:`, options);\n});\n\ndefine('bsSetCharacterPresence', function(female, isPresent = true) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    // 设置在场状态\n    this.setvar(`bs.${female}.isHere`, isPresent);\n    console.log(`Character ${female} presence set to: ${isPresent}`);\n});\n\ndefine('bsInsertCharacter', function(female, race = '人类') {\n    if(!female) return;\n    \n    // 初始化角色（如果不存在则创建）\n    if(this.variables?.bs?.[female] === null) {\n        this.setvar(`bs.${female}`, {});\n    }\n    this.bsInitFemale(female);\n    \n    // 设置种族和生理参数\n    this.bsSetRacePhysiologyProfile(female, race);\n    \n    console.log(`Registered character: ${female} (${race})`);\n});\n\ndefine('bsRemoveCharacter', function(female) {\n    if(!female) return;\n    \n    // 删除角色数据\n    this.setvar(`bs.${female}`, null);\n    \n    // 更新全域种族和类型统计\n    this.bsUpdateGlobalRaceAndTypes();\n    \n    console.log(`Removed character: ${female}`);\n});\n\ndefine('bsUpdateFetusProperty', function(female, fetusIndex, property, value) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    \n    let pregnant = this.getvar(`bs.${female}.pregnant`, { defaults: [] });\n    \n    // 检查索引是否有效\n    if(fetusIndex < 0 || fetusIndex >= pregnant.length) {\n        console.log(`Invalid fetus index: ${fetusIndex} for ${female}`);\n        return;\n    }\n    \n    // 对fetalBias进行安全检查\n    if(property === 'fetalBias') {\n        if(typeof value !== 'number' || isNaN(value)) {\n            console.log(`Invalid fetalBias value: ${value} for ${female}, must be a number`);\n            return;\n        }\n        if(value < 0.1 || value > 5.0) {\n            console.log(`Warning: fetalBias value ${value} for ${female} is outside recommended range (0.3-3.3). This may cause unexpected behavior.`);\n        }\n    }\n    \n    // 安全地更新特定属性\n    pregnant[fetusIndex][property] = value;\n    \n    // 更新整个数组\n    this.setvar(`bs.${female}.pregnant`, pregnant);\n    \n    console.log(`Updated ${female}'s fetus[${fetusIndex}].${property} to: ${value}`);\n});\n\ndefine('bsUpdatePregnantEmotion', function(female, options = {}, force = false) {\n    if(!female || this.variables?.bs?.[female] === null) return false;\n    this.bsInitFemale(female);\n    \n    // 检查冷却时间 - 需要isNewDay才能调用（除非force=true）\n    if(!force) {\n        const emotionalUpdateUsed = this.getvar(`bs.${female}.emotionalUpdateUsed`, { defaults: false });\n        \n        // 如果已经使用过，不能再次调用\n        if(emotionalUpdateUsed) {\n            console.log(`Emotional update for ${female} is on cooldown. Already used this day.`);\n            return false;\n        }\n    }\n    \n    const allowed = [\n        'pregnancyAwareness',\n        'pregnancyAcceptance',\n        'pregnancyDisplay',\n        'pregnancyConfidence'\n    ];\n    \n    for (const key of allowed) {\n        if (options[key] !== undefined) {\n            // 添加数值验证\n            let changeValue = options[key];\n            \n            if (typeof changeValue !== 'number' || isNaN(changeValue)) {\n                console.log(`Invalid ${key} change value: ${changeValue} for ${female}, must be a number`);\n                continue;\n            }\n            \n            // 获取当前值\n            const currentValue = this.getvar(`bs.${female}.${key}`, { defaults: 0 });\n            const newValue = currentValue + changeValue;\n            \n            // 范围验证和约束：0-100\n            const finalValue = Math.max(0, Math.min(100, newValue));\n            \n            this.setvar(`bs.${female}.${key}`, finalValue);\n            console.log(`${female} ${key}: ${currentValue} + ${changeValue} = ${finalValue}`);\n        }\n    }\n    \n    // 标记已使用（除非是force模式）\n    if(!force) {\n        this.setvar(`bs.${female}.emotionalUpdateUsed`, true);\n    }\n    \n    console.log(`Updated ${female}'s pregnant emotion:`, options);\n    return true;\n});\n\ndefine('bsUpdateGlobalSettings', function(options = {}) {\n    // 确保全局设置已初始化\n    this.bsInitGlobalSettings();\n    \n    const allowed = [\n        'enableMonsterOBGYN',\n        'enableChildRecord', \n        'enableSexExperience',\n        'enablePregnantEmotion'\n    ];\n    \n    for (const key of allowed) {\n        if (options[key] !== undefined) {\n            if (typeof options[key] !== 'boolean') {\n                console.log(`Invalid ${key} value: ${options[key]}, must be a boolean`);\n                continue;\n            }\n            this.setvar(`bs.global.${key}`, options[key]);\n        }\n    }\n    \n    console.log(`Updated global settings:`, options);\n});\n\n// 更新全域种族和受精卵类型统计\ndefine('bsUpdateGlobalRaceAndTypes', function() {\n    this.bsInitGlobalSettings();\n    \n    const activeRaces = new Set();\n    const activeZygoteTypes = new Set();\n    const activeEmbryoTypes = new Set();\n    \n    // 扫描所有角色\n    for (let char in this.variables.bs) {\n        if (!char || char === 'global' || this.variables.bs[char] === null) continue;\n        \n        const data = this.variables.bs[char];\n        \n        // 收集角色种族\n        if (data.race) {\n            activeRaces.add(data.race);\n        }\n        \n        // 收集精子中的种族\n        if (data.sperms && Array.isArray(data.sperms)) {\n            for (const sperm of data.sperms) {\n                if (sperm.race) {\n                    activeRaces.add(sperm.race);\n                }\n            }\n        }\n        \n        // 收集胎儿的种族、合子类型和胚胎类型\n        if (data.pregnant && Array.isArray(data.pregnant)) {\n            for (const fetus of data.pregnant) {\n                if (fetus.race) {\n                    activeRaces.add(fetus.race);\n                }\n                if (fetus.zygoteType) {\n                    activeZygoteTypes.add(fetus.zygoteType);\n                }\n                if (fetus.embryoType) {\n                    activeEmbryoTypes.add(fetus.embryoType);\n                }\n            }\n        }\n        \n        // 收集已出生孩子的种族\n        if (data.child && Array.isArray(data.child)) {\n            for (const child of data.child) {\n                if (child.race) {\n                    activeRaces.add(child.race);\n                }\n            }\n        }\n    }\n    \n    // 转换为数组并排序\n    const raceArray = Array.from(activeRaces).sort();\n    const zygoteArray = Array.from(activeZygoteTypes).sort();\n    const embryoArray = Array.from(activeEmbryoTypes).sort();\n    \n    // 更新全域变量\n    this.setvar('bs.global.activeRaces', raceArray);\n    this.setvar('bs.global.activeZygoteTypes', zygoteArray);\n    this.setvar('bs.global.activeEmbryoTypes', embryoArray);\n    \n    console.log(`Global races updated: ${raceArray.join(', ')}`);\n    console.log(`Global zygote types updated: ${zygoteArray.join(', ')}`);\n    console.log(`Global embryo types updated: ${embryoArray.join(', ')}`);\n});\n\n// 代谢物系统函数\ndefine('bsUpdateMetabolism', function(female, vitalityChange = 0) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    \n    // 如果没有提供vitalityChange，直接返回（用于空函数调用）\n    if (vitalityChange === undefined || vitalityChange === 0) {\n        console.log(`bsUpdateMetabolism called for ${female} with no vitality change`);\n        return;\n    }\n    \n    // 获取当前状态\n    const psyStress = this.getvar(`bs.${female}.psyStress`, { defaults: 0 });\n    \n    // 情压调整累积速率：psyStress越高，累积越快（±50%）\n    const stressMultiplier = 1 + ((psyStress - 100) / 200) * 0.5;\n    \n    // 计算基础转化量（vitality变化量的绝对值）\n    const baseChange = Math.abs(vitalityChange);\n    \n    let urineChange = 0;\n    let stoolChange = 0;\n    let hungerChange = 0;\n    let sleepChange = 0;\n    \n    if (vitalityChange > 0) {\n        // 活力上升时累积便尿\n        const urineBase = baseChange * 2.0;\n        const stoolBase = baseChange * 0.5;\n        urineChange = urineBase * stressMultiplier;\n        stoolChange = stoolBase * stressMultiplier;\n    } else if (vitalityChange < 0) {\n        // 活力下降时累积饿睡\n        const hungerBase = baseChange * 1.5;  // 饿意累积较快\n        const sleepBase = baseChange * 1.0;   // 困意累积标准\n        hungerChange = hungerBase * stressMultiplier;\n        sleepChange = sleepBase * stressMultiplier;\n    }\n    \n    // 更新代谢物值（确保在[0,150]范围内）\n    const currentUrine = this.getvar(`bs.${female}.urine`, { defaults: 0 });\n    const currentStool = this.getvar(`bs.${female}.stool`, { defaults: 0 });\n    const currentHunger = this.getvar(`bs.${female}.hunger`, { defaults: 0 });\n    const currentSleep = this.getvar(`bs.${female}.sleep`, { defaults: 0 });\n    \n    const newUrine = Math.min(150, Math.max(0, currentUrine + urineChange));\n    const newStool = Math.min(150, Math.max(0, currentStool + stoolChange));\n    const newHunger = Math.min(150, Math.max(0, currentHunger + hungerChange));\n    const newSleep = Math.min(150, Math.max(0, currentSleep + sleepChange));\n    \n    this.setvar(`bs.${female}.urine`, newUrine);\n    this.setvar(`bs.${female}.stool`, newStool);\n    this.setvar(`bs.${female}.hunger`, newHunger);\n    this.setvar(`bs.${female}.sleep`, newSleep);\n    \n    // 计算需求等级\n    const getLevel = (value) => {\n        if (value >= 100) return '满';\n        if (value >= 75) return '高';\n        if (value >= 50) return '中';\n        if (value >= 25) return '低';\n        return '无';\n    };\n    \n    const urineLevel = getLevel(newUrine);\n    const stoolLevel = getLevel(newStool);\n    const hungerLevel = getLevel(newHunger);\n    const sleepLevel = getLevel(newSleep);\n    \n    // 生成代谢物状态字符串\n    const metabolismStatus = `尿意:${urineLevel} 便意:${stoolLevel} 饿意:${hungerLevel} 困意:${sleepLevel}`;\n    this.setvar(`bs.${female}.notifyTertiary`, metabolismStatus);\n    \n    console.log(`Metabolism updated for ${female}: urine +${urineChange.toFixed(2)}, stool +${stoolChange.toFixed(2)}, hunger +${hungerChange.toFixed(2)}, sleep +${sleepChange.toFixed(2)}`);\n});\n\ndefine('bsExcreteMetabolism', function(female, options = {}) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    \n    // 获取当前状态\n    const stage = this.getvar(`bs.${female}.stage`);\n    const uterinePressure = this.getvar(`bs.${female}.uterinePressure`, { defaults: 0 });\n    const currentUrine = this.getvar(`bs.${female}.urine`, { defaults: 0 });\n    const currentStool = this.getvar(`bs.${female}.stool`, { defaults: 0 });\n    const currentHunger = this.getvar(`bs.${female}.hunger`, { defaults: 0 });\n    const currentSleep = this.getvar(`bs.${female}.sleep`, { defaults: 0 });\n    \n    // 计算残留率（基于怀孕阶段）\n    let residualRate = 0;\n    if (stage === '假孕期') {\n        residualRate = 0.10; // 10% 残留\n    } else if (stage === '产前阵痛' || bsLaborStage.includes(stage)) {\n        residualRate = 0.50; // 50% 残留（分娩时最难排空）\n    } else if (bsPregnancyStage.includes(stage)) {\n        if (stage === '孕早期') {\n            residualRate = 0.10; // 10% 残留\n        } else if (stage === '孕中期') {\n            residualRate = 0.20; // 20% 残留\n        } else if (stage === '孕晚期') {\n            residualRate = 0.30; // 30% 残留\n        } else if (stage === '临产期' || stage === '逾期') {\n            residualRate = 0.40; // 40% 残留\n        }\n    }\n    \n    // 宫压阻碍：urine和stool受宫压阻碍（至多50%）\n    const pressureHindrance = Math.min(0.5, (uterinePressure / 150) * 0.5);\n    const excretionEfficiency = 1 - pressureHindrance;\n    \n    // 默认缓解量（未指定时使用默认值，若options为空对象则缓解所有）\n    const hasOptions = Object.keys(options).length > 0;\n    const defaultUrineReduction = options.urine !== undefined ? options.urine : (hasOptions ? 0 : 30);\n    const defaultStoolReduction = options.stool !== undefined ? options.stool : (hasOptions ? 0 : 20);\n    const defaultHungerReduction = options.hunger !== undefined ? options.hunger : (hasOptions ? 0 : 40);\n    const defaultSleepReduction = options.sleep !== undefined ? options.sleep : (hasOptions ? 0 : 40);\n    \n    // 计算实际缓解量（考虑宫压阻碍）\n    const actualUrineReduction = defaultUrineReduction * excretionEfficiency;\n    const actualStoolReduction = defaultStoolReduction * excretionEfficiency;\n    const actualHungerReduction = defaultHungerReduction; // hunger不受宫压影响\n    const actualSleepReduction = defaultSleepReduction; // sleep不受宫压影响\n    \n    // 计算残留最小值（仅当原值>=100时才有残留感）\n    const urineResidual = currentUrine >= 100 ? currentUrine * residualRate : 0;\n    const stoolResidual = currentStool >= 100 ? currentStool * residualRate : 0;\n    const hungerResidual = currentHunger >= 100 ? currentHunger * residualRate : 0;\n    const sleepResidual = currentSleep >= 100 ? currentSleep * residualRate : 0;\n    \n    // 更新代谢物值（考虑残留感）\n    const newUrine = Math.max(urineResidual, currentUrine - actualUrineReduction);\n    const newStool = Math.max(stoolResidual, currentStool - actualStoolReduction);\n    const newHunger = Math.max(hungerResidual, currentHunger - actualHungerReduction);\n    const newSleep = Math.max(sleepResidual, currentSleep - actualSleepReduction);\n    \n    this.setvar(`bs.${female}.urine`, newUrine);\n    this.setvar(`bs.${female}.stool`, newStool);\n    this.setvar(`bs.${female}.hunger`, newHunger);\n    this.setvar(`bs.${female}.sleep`, newSleep);\n    \n    // 计算需求等级并更新notifyTertiary\n    const getLevel = (value) => {\n        if (value >= 100) return '满';\n        if (value >= 75) return '高';\n        if (value >= 50) return '中';\n        if (value >= 25) return '低';\n        return '无';\n    };\n    \n    const urineLevel = getLevel(newUrine);\n    const stoolLevel = getLevel(newStool);\n    const hungerLevel = getLevel(newHunger);\n    const sleepLevel = getLevel(newSleep);\n    \n    // 生成代谢物状态字符串\n    const metabolismStatus = `尿意:${urineLevel} 便意:${stoolLevel} 饿意:${hungerLevel} 困意:${sleepLevel}`;\n    this.setvar(`bs.${female}.notifyTertiary`, metabolismStatus);\n    \n    const residualInfo = residualRate > 0 ? ` (残留率:${(residualRate*100).toFixed(0)}%)` : '';\n    console.log(`Metabolism relief for ${female}${residualInfo}: urine ${currentUrine.toFixed(1)}->${newUrine.toFixed(1)}, stool ${currentStool.toFixed(1)}->${newStool.toFixed(1)}, hunger ${currentHunger.toFixed(1)}->${newHunger.toFixed(1)}, sleep ${currentSleep.toFixed(1)}->${newSleep.toFixed(1)}`);\n    \n});\n\ndefine('bsAdjustAffinity', function(female, monthCount = 1) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    \n    let pregnant = this.getvar(`bs.${female}.pregnant`, { defaults: [] });\n    if(pregnant.length === 0) return;\n    \n    const psyStress = this.getvar(`bs.${female}.psyStress`, { defaults: 0 });\n    \n    // 根据psyStress计算基础亲密度变化\n    // psyStress > 100 降低亲密度，< 100 增加亲密度\n    let baseAffinityChange = 0;\n    if(psyStress > 100) {\n        // 心理压力大，降低亲密度\n        // 使用对数函数，压力越大影响越明显但不会无限增长\n        baseAffinityChange = -Math.log(psyStress - 99) * 2;\n    } else if(psyStress < 100) {\n        // 心理压力小，增加亲密度\n        // 使用平方函数，压力越小增加越明显\n        baseAffinityChange = Math.pow((100 - psyStress) / 100, 2) * 3;\n    }\n    \n    // 为每个胎儿调整亲密度\n    for(let i = 0; i < pregnant.length; i++) {\n        const fetus = pregnant[i];\n        const currentAffinity = fetus.affinity || 0;\n        \n        // 胎儿重量影响：fetalBias越大，作用越明显\n        const fetalBiasMultiplier = fetus.fetalBias || 1.0;\n        \n        // 双胞胎共振效应：有twinId的胎儿变化更明显\n        const twinResonanceMultiplier = fetus.twinId !== null ? 1.5 : 1.0;\n        \n        // 计算最终亲密度变化\n        const affinityChange = baseAffinityChange * fetalBiasMultiplier * twinResonanceMultiplier * monthCount;\n        \n        // 更新亲密度，确保在[-50, 50]范围内\n        const newAffinity = Math.max(-50, Math.min(50, currentAffinity + affinityChange));\n        fetus.affinity = newAffinity;\n        \n        console.log(`Affinity adjusted for ${female}'s fetus ${i}: ${currentAffinity.toFixed(2)} -> ${newAffinity.toFixed(2)} (change: ${affinityChange.toFixed(2)})`);\n    }\n    \n    this.setvar(`bs.${female}.pregnant`, pregnant);\n});\n\ndefine('bsFetalDream', function(female) {\n    if(!female || this.variables?.bs?.[female] === null) return;\n    this.bsInitFemale(female);\n    \n    let pregnant = this.getvar(`bs.${female}.pregnant`, { defaults: [] });\n    if(pregnant.length === 0) return;\n    \n    // 随机选择一个胎儿\n    const selectedFetusIndex = _.random(0, pregnant.length - 1);\n    const selectedFetus = pregnant[selectedFetusIndex];\n    \n    // 计算平均亲密度（如果有twinId，计算同组胎儿的平均亲密度）\n    let averageAffinity = selectedFetus.affinity || 0;\n    if(selectedFetus.twinId !== null) {\n        const twinGroup = pregnant.filter(f => f.twinId === selectedFetus.twinId);\n        const totalAffinity = twinGroup.reduce((sum, f) => sum + (f.affinity || 0), 0);\n        averageAffinity = totalAffinity / twinGroup.length;\n    }\n    \n    // 根据亲密度确定胎梦等级\n    let dreamLevel = 0;\n    let dreamMessage = '';\n    \n    if(averageAffinity >= 30) {\n        // 等级5：吉祥征兆 (affinity >= 30)\n        dreamLevel = 5;\n        dreamMessage = `${female}梦见吉祥的征兆`;\n    } else if(averageAffinity >= 10) {\n        // 等级4：温馨征兆 (affinity >= 10)\n        dreamLevel = 4;\n        dreamMessage = `${female}梦见温馨的征兆`;\n    } else if(averageAffinity >= -10) {\n        // 等级3：平静征兆 (affinity >= -10)\n        dreamLevel = 3;\n        dreamMessage = `${female}梦见平静的征兆`;\n    } else if(averageAffinity >= -30) {\n        // 等级2：不安征兆 (affinity >= -30)\n        dreamLevel = 2;\n        dreamMessage = `${female}梦见不安的征兆`;\n    } else {\n        // 等级1：凶险征兆 (affinity < -30)\n        dreamLevel = 1;\n        dreamMessage = `${female}梦见凶险的征兆`;\n    }\n    \n    // 添加胎儿来源信息\n    dreamMessage += `（来自第${selectedFetusIndex + 1}胎的胎梦）`;\n    \n    // 设置notifySecondary\n    this.setvar(`bs.${female}.notifySecondary`, dreamMessage);\n    \n    console.log(`Fetal dream for ${female}: Level ${dreamLevel}, Affinity: ${averageAffinity.toFixed(2)}, Message: ${dreamMessage}`);\n});\n\ndefine('bsAdjustFetalAffinity', function(female, change = 'slight_increase', direction = 'fetal', force = false) {\n    if(!female || this.variables?.bs?.[female] === null) return false;\n    this.bsInitFemale(female);\n    \n    // 检查是否有胎儿\n    let pregnant = this.getvar(`bs.${female}.pregnant`, { defaults: [] });\n    if(pregnant.length === 0) {\n        console.log(`No fetuses found for ${female}`);\n        return false;\n    }\n    \n    // 检查冷却时间 - 需要isNewHour才能调用（除非force=true）\n    const affinityAdjustmentUsed = this.getvar(`bs.${female}.affinityAdjustmentUsed`, { defaults: false });\n    \n    // 如果已经使用过且不是强制调用，不能再次调用\n    console.log(`Debug: affinityAdjustmentUsed=${affinityAdjustmentUsed}, force=${force}`);\n    if(affinityAdjustmentUsed && !force) {\n        console.log(`Affinity adjustment for ${female} is on cooldown. Already used this hour.`);\n        return false;\n    }\n    \n    // 字符串映射到数值（输入英文，内部维持中文）\n    const changeMap = {\n        'slight_increase': 1,\n        'significant_increase': 2,\n        'slight_decrease': -1,\n        'significant_decrease': -2\n    };\n    \n    // 英文到中文的映射\n    const changeDisplayMap = {\n        'slight_increase': '轻微增加',\n        'significant_increase': '显著增加',\n        'slight_decrease': '轻微减少',\n        'significant_decrease': '显著减少'\n    };\n    \n    const changeValue = changeMap[change];\n    if(changeValue === undefined) {\n        console.log(`Invalid affinity change value: ${change}. Must be 'slight_increase', 'significant_increase', 'slight_decrease', or 'significant_decrease'`);\n        return false;\n    }\n    \n    // 获取中文显示文本\n    const changeDisplay = changeDisplayMap[change];\n    \n    // 随机选择一个胎儿\n    const randomFetusIndex = _.random(0, pregnant.length - 1);\n    const selectedFetus = pregnant[randomFetusIndex];\n    const currentAffinity = selectedFetus.affinity || 0;\n    \n    // 如果是母体对胎儿的行为，需要判定是否成功\n    let success = true;\n    let actualChange = changeValue;\n    \n    if(direction === 'maternal') {\n        // 获取母体心理压力\n        const psyStress = this.getvar(`bs.${female}.psyStress`, { defaults: 0 });\n        \n        // 计算失败概率：psyStress越高，失败概率越大\n        // psyStress = 0时，失败概率 = 0%\n        // psyStress = 100时，失败概率 = 50%\n        // psyStress = 200时，失败概率 = 100%\n        const failureChance = Math.min(1.0, psyStress / 200);\n        \n        // 随机判定是否失败\n        if(Math.random() < failureChance) {\n            success = false;\n            actualChange = 0; // 失败时无变化\n        }\n    }\n    \n    // 计算新的亲密度，确保在[-50, 50]范围内\n    const newAffinity = Math.max(-50, Math.min(50, currentAffinity + actualChange));\n    \n    // 更新胎儿亲密度\n    selectedFetus.affinity = newAffinity;\n    \n    // 更新怀孕数组\n    this.setvar(`bs.${female}.pregnant`, pregnant);\n    \n    // 标记已使用（除非是强制调用）\n    if(!force) {\n        this.setvar(`bs.${female}.affinityAdjustmentUsed`, true);\n    }\n    \n    // 设置notify消息 - 根据方向显示不同消息\n    const fetusNumber = randomFetusIndex + 1;\n    let notifyMessage;\n    if(direction === 'fetal') {\n        // 胎儿对母体的行为\n        notifyMessage = `第${fetusNumber}胎对${female}的亲密度${changeDisplay}了`;\n    } else {\n        // 母体对胎儿的行为\n        if(success) {\n            notifyMessage = `${female}对第${fetusNumber}胎的亲密度${changeDisplay}了`;\n        } else {\n            notifyMessage = `${female}尝试与第${fetusNumber}胎建立联系，但因心理压力过大而失败`;\n        }\n    }\n    this.setvar(`bs.${female}.notify`, notifyMessage);\n    \n    console.log(`Fetal affinity adjusted for ${female}'s fetus ${randomFetusIndex + 1}: ${currentAffinity} -> ${newAffinity} (change: ${changeValue})`);\n    \n    return true;\n});\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":10,"position":0,"disable":false,"excludeRecursion":false,"preventRecursion":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":4,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"displayIndex":7,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"triggers":[],"ignoreBudget":false,"outletName":""},"5":{"uid":5,"key":[],"keysecondary":[],"comment":"状态變量提示詞","content":"<%\nfunction getWeightLevel(fetalBias) {\n  const logValue = Math.log10(fetalBias);\n  if (logValue <= -0.4) return -4; // 0.40\n  if (logValue <= -0.3) return -3; // 0.50\n  if (logValue <= -0.2) return -2; // 0.63\n  if (logValue <= -0.1) return -1; // 0.79\n  if (logValue <=  0.1) return  0; // 1.26\n  if (logValue <=  0.2) return  1; // 1.58\n  if (logValue <=  0.3) return  2; // 2.00\n  if (logValue <=  0.4) return  3; // 2.51\n  return 4;\n}\nfunction getWeightLevelText(level) {\n  const levels = {\n    '-4': '极轻',\n    '-3': '超轻',\n    '-2': '较轻',\n    '-1': '偏轻',\n    '0' : '正常',\n    '1' : '偏重',\n    '2' : '较重',\n    '3' : '超重',\n    '4' : '极重'\n  };\n  return levels[level] || '未知';\n}\nfunction getAffinityLevel(affinity) {\n  if (affinity >= 45) return 7;\n  if (affinity >= 30) return 6;\n  if (affinity >= 10) return 5;\n  if (affinity >= -10) return 4;\n  if (affinity >= -30) return 3;\n  if (affinity >= -45) return 2;\n  return 1;\n}\nfunction getAffinityLevelText(level) {\n  const levels = {\n    '7': '极高',\n    '6': '高',\n    '5': '中上',\n    '4': '中等',\n    '3': '中下',\n    '2': '低',\n    '1': '极低'\n  };\n  return levels[level] || '未知';\n}\nconst _pregStages = (typeof bsPregnancyStage !== 'undefined' && bsPregnancyStage) ? bsPregnancyStage : [];\nconst _laborStages = (typeof bsLaborStage !== 'undefined' && bsLaborStage) ? bsLaborStage : [];\nconst _menstrualStages = (typeof bsMenstrualStage !== 'undefined' && bsMenstrualStage) ? bsMenstrualStage : [];\nfunction inPregnancy(stage) {\n  return _pregStages.includes(stage) || stage === '产前阵痛' || _laborStages.includes(stage);\n}\n%>\n<BS_StatusPrompt>\n<%\nfor (let char in variables.bs) {\n  if (!char || char === 'global' || !variables.bs[char]) continue;\n  const data = variables.bs[char];\n  if (data.isHere) {\n%>\n名字: <%- char %>\n- 种族: <%- data.race %>\n- 活力: <%- Math.round(data.vitality) %>\n- 情压: <%- Math.round(data.psyStress) %>\n- 宫压: <%- Math.round(data.uterinePressure) %>\n- 性慾: <%- Math.round(data.libido) %>\n<% if (!data.metabolismImmune && data.notifyTertiary) { -%>\n- 代谢需求 \n<%- data.notifyTertiary %>\n<% } -%>\n- 宮内卵子<%- data.eggs %>顆\n- 宮内精液(共计<%- Math.round((data.sperms || []).reduce((sum, s) => sum + s.value, 0)) %>ml):\n<%  if (data.sperms && data.sperms.length > 0) { -%>\n<%    for (let sperm of data.sperms) { if (sperm.value > 0) { -%>\n- <%- sperm.male %>(<%- sperm.race || '未知' %>), <%- Math.round(sperm.value) %>ml\n<%    }} -%>\n<%  } -%>\n- 阶段: <%- data.stage %>\n<%  if (_menstrualStages.includes(data.stage) || data.stage === '产后恢复' || data.stage === '假孕期' || data.stage === '已受精') { -%>\n- 周期时间: 第<%- Math.floor(data.days) %>天\n<%  } else if (inPregnancy(data.stage)) { -%>\n- 妊娠时间: 第<%- Math.floor(data.pregnantDays / 7) %>周 <%- Math.floor(data.pregnantDays % 7) %>天\n<%    if (data.stage === '产前阵痛' || _laborStages.includes(data.stage)) { -%>\n- 分娩时间: 已過<%- Math.round(data.laborHours || 0) %>小时\n<%    } -%>\n- 胎数: <%- data.fetuses || 0 %>胎\n<%    if (data.pregnant && data.pregnant.length > 0) { -%>\n- 胎儿详细信息<% if (data.affinityAdjustmentUsed) { %>(今時亲和度已調整)<% } %>:\n<%        for (let i = 0; i < data.pregnant.length; i++) { \n          const fetus = data.pregnant[i]; -%>\n* No.<%- i + 1 %> | 性别: <%- fetus.gender %> | 父亲: <%- fetus.fathers %> | 种族: <%- fetus.race %> | 胚胎类型: <%- fetus.embryoType %> | 合子类型: <%- fetus.zygoteType %> | 體重: <%- getWeightLevelText(getWeightLevel(fetus.fetalBias)) %> | 亲和度: <%- getAffinityLevelText(getAffinityLevel(fetus.affinity || 0)) %><% if (fetus.twinId) { %> | 双胞胎ID: <%- fetus.twinId %><% } %>\n<%        } -%>\n<%    } -%>\n<%  } -%>\n<%  } else { // !data.isHere -%>\n名字: <%- char %>\n- 种族: <%- data.race %>\n- 阶段: <%- data.stage %>\n<%    if (_menstrualStages.includes(data.stage) || data.stage === '产后恢复' || data.stage === '假孕期' || data.stage === '已受精') { -%>\n- 周期时间: 第<%- Math.floor(data.days) %>天\n<%    } else if (inPregnancy(data.stage)) { -%>\n- 妊娠时间: 第<%- Math.floor(data.pregnantDays / 7) %>周 <%- Math.floor(data.pregnantDays % 7) %>天\n<%      if (data.stage === '产前阵痛' || _laborStages.includes(data.stage)) { -%>\n- 分娩时间: 已過<%- Math.round(data.laborHours || 0) %>小时\n<%      } -%>\n- 胎数: <%- data.fetuses || 0 %>胎\n<%      if (data.pregnant && data.pregnant.length > 0) { -%>\n- 胎儿性别:\n<%        for (let fetus of data.pregnant) { -%>\n* <%- fetus.gender %>\n<%        } -%>\n<%      } -%>\n<%    } -%>\n<%  } // end isHere branch -%>\n<%} // end for -%>\n</BS_StatusPrompt>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":300,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"displayIndex":11,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"triggers":[],"ignoreBudget":false,"outletName":"","characterFilter":{"isExclude":false,"names":[],"tags":[]}},"6":{"uid":6,"key":[],"keysecondary":[],"comment":"强调状态","content":"<% for (let char in variables.bs) {\n  const data = variables.bs[char];\n  if (!char || !data || char === 'global') continue;\n-%>\n<% if (data.notify) { -%>\n名字: <%- char %>\n- 重要状况: <%- data.notify %>\n<% } -%>\n<% if (data.stage === '产前阵痛' && data.isHere) { -%>\n- 产前阵痛: <%- char %>正处于产前阵痛阶段，建議使用 `<%% bsResistLabor('<%- char %>'); %%>` 來尝试让抵抗分娩。\n<% } -%>\n<% if ((data.stage === '临产期' || data.stage === '逾期' || data.stage === '产前阵痛') && data.isHere) { -%>\n- 分娩限制: <%- char %>(阶段: <%- data.stage %>)，尚未进入产程，当前阶段禁止破水分娩行为\n<% } -%>\n<%\n  const claim_metabolismImmune = this.getvar(`bs.${char}.metabolismImmune`, { defaults: false });\n  if (!claim_metabolismImmune && data.isHere) {\n    const urine = this.getvar(`bs.${char}.urine`, { defaults: 0 });\n    const stool = this.getvar(`bs.${char}.stool`, { defaults: 0 });\n    const hunger = this.getvar(`bs.${char}.hunger`, { defaults: 0 });\n    const sleep = this.getvar(`bs.${char}.sleep`, { defaults: 0 });\n    if (urine >= 75 || stool >= 75 || hunger >= 75 || sleep >= 75) { -%>\n<% if (urine >= 75) { -%>\n- 尿意: <%= urine >= 100 ? '满' : '高' %> (<%= urine %>)\n<% } -%>\n<% if (stool >= 75) { -%>\n- 便意: <%= stool >= 100 ? '满' : '高' %> (<%= stool %>)\n<% } -%>\n<% if (hunger >= 75) { -%>\n- 饿意: <%= hunger >= 100 ? '满' : '高' %> (<%= hunger %>)\n<% } -%>\n<% if (sleep >= 75) { -%>\n- 困意: <%= sleep >= 100 ? '满' : '高' %> (<%= sleep %>)\n<% } -%>\n<%- char %>有强烈的生理需求，应使用\"缓解生理需求\"函数让其排泄/进食/休息，缓解生理不适。\n<%   }\n  }\n} -%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":401,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"displayIndex":9,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"triggers":[],"ignoreBudget":false,"outletName":"","characterFilter":{"isExclude":false,"names":[],"tags":[]}},"7":{"uid":7,"key":[],"keysecondary":[],"comment":"调用函数指導","content":"考虑调用函数：\n<% for (let char in variables.bs) {\n  const data = variables.bs[char];\n  if (!char || !data || char === 'global') continue;\n  // 检查种族设置\n  if (data.race === null) { -%>\n角色首次注册提示：为角色<%- char %>设置符合其背景的种族。\n种族设置函数：`<%% bsSetRacePhysiologyProfile('<%- char %>', '种族名称'); %%>`\n純种示例： `<%% bsSetRacePhysiologyProfile('<%- char %>', '人类'); %%>`\n混血示例： `<%% bsSetRacePhysiologyProfile('<%- char %>', '天使x惡魔'); %%>`\n衍生种族示例： `<%% bsSetRacePhysiologyProfile('<%- char %>', '[吸血鬼]人类'); %%>`\n子类物种示例： `<%% bsSetRacePhysiologyProfile('<%- char %>', '鱼人-鯨族'); %%>`\n复杂示例： `<%% bsSetRacePhysiologyProfile('<%- char %>', '[妖]兽耳族-九尾狐'); %%>`\n基础属性设置说明：\n不同体型和身体状况会影响活力起始值：巨乳翘臀、健壮体型、强大种族通常有较高的活力起始值（110-150），病弱、萝莉体型、弱小种族则活力起始值较低（50-90）。不同角色类型的情压起始值也有差异：三无角色（0-20）、一般人（30-70）、创伤角色（80+）、精神病角色（120+）。\n基础状态设置函数：`<%% setvar('bs.<%- char %>.vitality', 数值); %%>` `<%% setvar('bs.<%- char %>.psyStress', 数值); %%>`\n<% } -%>\n<% // 检查胎儿设置\n  if (data.pregnant && data.pregnant.length > 0) { -%>\n安全提示：角色<%- char %>当前已怀孕，不宜調用P4級函数，干扰怀孕进程\n<%   for (let i = 0; i < data.pregnant.length; i++) {\n      const fetus = data.pregnant[i]; -%>\n<%   // 检查胎儿性别设置\n      if (fetus && (fetus.gender === '未知' || fetus.gender === '未定' || fetus.gender === '待定') && data.stage !== '孕早期') { -%>\n胎儿(编号<%- i %>)的性别尚未确定，当前孕期阶段为<%- data.stage %>，应设置胎儿的固定性别。\n胎儿性别设置函数：`<%% bsUpdateFetusProperty('<%- char %>', <%- i %>, 'gender', '性别'); %%>`\n示例： `<%% bsUpdateFetusProperty('<%- char %>', <%- i %>, 'gender', '男'); %%>`\n<%   } -%>\n<%   } // end for each fetus -%>\n<% } // end if pregnant -%>\n<% // 检查孩子命名\n  if (data.child && data.child.length > 0) { \n    for (let i = 0; i < data.child.length; i++) {\n      const child = data.child[i];\n      if (child.name === null) { -%>\n孩子命名提示：角色<%- char %>的孩子(编号<%- i %>)尚未命名，应为其设置姓名。\n孩子命名函数：`<%% bsNameChild('<%- char %>', <%- i %>, '孩子姓名'); %%>`\n示例： `<%% bsNameChild('<%- char %>', <%- i %>, '小明'); %%>`\n<%     }\n    }\n  } -%>\n<% // 检查状态更新提示\n  if (data.isHere === true) { -%>\n状态更新提示：角色<%- char %>当前在场，应使用更新角色基础状态函数调整活力、性欲、宫压、情压。\n状态变化幅度参考：活力值变化(±5-20)、性欲值变化(±10-30)、宫压值变化(±5-15)、情压值变化(±10-50)。\n<%\n    // 妊娠心情系统状态\n    const claim_isPregnantStage = bsPregnancyStage.includes(data.stage) || bsLaborStage.includes(data.stage) || data.stage === '产前阵痛' || data.stage === '假孕期';\n    if (claim_isPregnantStage) {\n      const claim_enablePregnantEmotion = this.getvar('bs.global.enablePregnantEmotion', { defaults: true });\n      if (claim_enablePregnantEmotion) { -%>\n妊娠心情调整提示：角色<%- char %>当前处于<%- data.stage %>阶段，可使用\"调整妊娠心情\"函数来调整角色的怀孕认知、接受度、表现度、信心度等情感指标。若角色初次登場於故事中，根據背景設置初始值。\n<%   } } -%>\n<%\n    // 人外产科学信息演绎提示\n    const claim_enableMonsterOBGYN = this.getvar('bs.global.enableMonsterOBGYN', { defaults: true });\n    if (claim_enableMonsterOBGYN && data.pregnant && data.pregnant.length > 0) { -%>\n人外产科学(MonsterOBGYN)演绎：当角色妊娠时，可根据胎儿的性别、父亲、种族、胚胎类型、体重、亲和度等属性演绎出差异化的胎动表现、母体反应和情感互动。结合种族生理特征演绎异种妊娠的特殊现象。\n<%   } -%>\n<%\n    // 妊娠经验系统状态\n    const claim_enableSexExperience = this.getvar('bs.global.enableSexExperience', { defaults: true });\n    if (claim_enableSexExperience) { -%>\n经验更新提示：角色<%- char %>的经验系统已启用，可使用\"更新角色情感与妊娠经验\"函数来记录角色的经验相关数据。若角色初次登場於故事中，根據背景設置初始值。\n<%   } -%>\n<%\n    // 孩子记录系统状态\n    const claim_enableChildRecord = this.getvar('bs.global.enableChildRecord', { defaults: true });\n    const claim_birthExperience = data.birthExperience || 0;\n    if (claim_enableChildRecord && claim_birthExperience > 0 && (!data.child || data.child.length === 0)) { -%>\n孩子记录提示：角色<%- char %>有<%- claim_birthExperience %>次生产经验，但未记录孩子信息。若角色初次登場於故事中已是母亲（背景设定已有孩子），应使用\"注入孩子信息\"函数记录已出生的孩子。\n<%   } -%>\n<% } // end if isHere -%>\n<% } // end for char -%>\n在时间流逝、场景变化等会发生时间变化的情况下，例如：* \"几天过去了…\"* \"经过漫长的夜晚…\"* \"一个月后，她发现…\"* 应当调用\"时间流逝处理\"函数，且須對齊<statustext>中的<time>輸出變化。","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":200,"position":4,"disable":false,"excludeRecursion":true,"preventRecursion":true,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"displayIndex":13,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"triggers":[],"ignoreBudget":false,"outletName":"","characterFilter":{"isExclude":false,"names":[],"tags":[]}},"8":{"uid":8,"key":[],"keysecondary":[],"comment":"函数声明-P4(不想讓LLM亂調角色的月經週期及妊娠狀態，可關閉)","content":"🟤 **P4 - 特殊场景函数 (最低优先级)**\n\n**更新生理特征配置**\n    - 函数名：`bsUpdatePhysiologyProfile`\n    - 参数：\n      * female: string - 女性角色名称\n      * options: object - 生理特征配置对象，包含以下字段：\n        * menstrualFluctuationDays: integer - 月经周期波动天数（默认1天）\n        * menstrualLengthRatio: number - 月经周期长度比例（默认1.0）\n        * gestationSpeed: number - 妊娠速度比例（默认1.0，数值越低孕期越長）\n        * birthDifficulty: number - 分娩难度系数（默认1.0，数值越高產程越長）\n        * orgasmOvulationAmount: integer - 高潮排卵数量（默认1，0表示不会高潮排卵）\n        * impregnationDifficulty: number - 受孕难度系数（默认1.0，数值越高越难怀孕）\n        * breedTolerance: number - 繁殖耐受度（默认1.0）\n        * identicalProbability: integer - 同卵双胞胎概率（默认5%）\n        * semiIdenticalProbability: integer - 半同卵双胞胎概率（默认2%）\n        * earlyFusionProbability: integer - 早期融合概率（默认2%）\n        * sharedMembraneProbability: integer - 共享膜概率（默认25%）\n        * superfetationProbability: integer - 异期受孕概率（默认1%）\n        * polyploidyProbability: integer - 多倍体概率（默认0%）\n\n    - 说明：适用于异种族的生理设定，用于设定各种人外的生理差异。默认值基于标准人类女性：月经周期28天，妊娠期280天，分娩时间14.25小时（每多一胎+3.75小时）。可以调整角色的月经周期、妊娠速度、分娩难度、受孕概率以及各种特殊受精类型的发生概率，以模拟不同种族或個體的生理特点\n    - 示例：\n      * 人類經期失調、孕育困難、分娩延長：`<%% bsUpdatePhysiologyProfile('{{char_name}}', {menstrualFluctuationDays: 5, impregnationDifficulty: 2.0, breedTolerance:0.75, birthDifficulty:1.5}) %%>`\n      * 高速妊娠：`<%% bsUpdatePhysiologyProfile('{{char_name}}', {gestationSpeed: 10.0}) %%>`\n\n**设置月经周期**\n   - 函数名：`bsSetMenstrualPhases`\n   - 参数：\n     * female: string - 女性角色名称\n     * stage: string - 目标月经周期阶段\n   - 说明：直接控制女性角色的月经周期阶段，用于模拟外部因素（如药物、压力）或推进故事情节。可设置的阶段包括：卵泡期、排卵期、黄体期、月经期、产后恢复、假孕期。**仅限非怀孕状态使用**\n   - 示例：`<%% bsSetMenstrualPhases('{{char_name}}', '月经期') %%>`\n\n**注入胎儿**\n   - 函数名：`bsInsertFetus`\n   - 参数：\n     * female: string - 女性角色名称\n     * options: object - 胎儿配置对象，包含以下字段：\n       * fathers: string - 父亲名称（特殊类型有特殊要求，见下方说明）\n       * race: string - 胎儿种族\n       * gender: string - 胎儿性别（多胎类型有特殊要求，见下方说明）\n       * zygoteType: string - 受精卵类型(默认:独胎)\n       * embryoType: string - 胚胎类型\n       * fetalBias: number - 胎儿重量\n       * affinity: number - 胎儿對母體的親和度\n       * isClear: boolean - 是否清空当前状态\n   - 说明：用于角色背景设定为孕妇，或需要非常规受孕的胎儿时使用。多胞胎类型会一次性注入所有胎儿，无需多次调用。\n   \n   【单胎类型】独胎、厚养胚、经期胚、早期融合卵、双母源、多倍体、异期胎\n   \n   【同卵多胞胎】一次性注入全部，同性别\n     - 双胞胎：DCDA、MCDA、MCMA\n     - 三胞胎：TCTA、MCTA、MCMAx3\n     - 四胞胎：QCQA、MCQA、MCMAx4\n   \n   【半同卵双胞胎】需要特殊参数\n     - 类型：S-MCMA、S-MCDA、S-DCDA\n     - fathers 必须用逗号分隔两位，如 \"father1,father2\"（同父也需写两次）\n     - gender 必须用逗号分隔两个性别，如 \"男,女\" 或 \"女,女\"\n   \n   【解离纯化系列】自动生成特定性别和种族\n     - 解离纯化x2：母体种族男胎 + 父体种族女胎，胎重固定1.0\n     - 解离纯化x3：三个纯血胎儿（自动随机2女1男或1女2男），race需为 \"AxBxC\" 格式\n     - 解离纯化x4：四个纯血胎儿（自动2男2女），race需为 \"AxBxCxD\" 格式\n   \n   【特殊类型】\n     - 自交：fathers必须为null（自动设为自己），性别固定为扶她\n     - 双父源：fathers必须用逗号分隔两位 \"father1,father2\"，性别固定为男\n     - 嵌套胎：注入后会自动将一个独胎转为嵌套外胎，新胎儿作为嵌套内胎，必须在孕早期且已有独胎时使用\n   \n   - 示例：\n     - 单胎：`<%% bsInsertFetus('{{char_name}}', {fathers: '{{user_name}}', race: '人类', gender: '男'}) %%>`\n     - 同卵双胞胎：`<%% bsInsertFetus('{{char_name}}', {fathers: '{{user_name}}', race: '精灵', gender: '女', zygoteType: 'MCDA'}) %%>`\n     - 同卵三胞胎：`<%% bsInsertFetus('{{char_name}}', {fathers: '{{user_name}}', race: '龙族', gender: '男', zygoteType: 'MCTA'}) %%>`\n     - 半同卵双胞胎：`<%% bsInsertFetus('{{char_name}}', {fathers: 'father1,father2', race: '人类', gender: '男,女', zygoteType: 'S-DCDA'}) %%>`\n     - 解离纯化x3：`<%% bsInsertFetus('{{char_name}}', {fathers: '{{user_name}}', race: '人类x精灵x兽人', zygoteType: '解离纯化x3'}) %%>`\n     - 自交：`<%% bsInsertFetus('{{char_name}}', {fathers: null, zygoteType: '自交'}) %%>`\n     - 双父源：`<%% bsInsertFetus('{{char_name}}', {fathers: 'father1,father2', zygoteType: '双父源'}) %%>`\n     - 嵌套胎：`<%% bsInsertFetus('{{char_name}}', {fathers: '{{user_name}}', race: '人类', gender: '女', zygoteType: '嵌套胎'}) %%>`\n\n\n**设置怀孕天数**\n   - 函数名：`bsSetPregnantDay`\n   - 参数：\n     * female: string - 女性角色名称\n     * pregnantDays: integer - 目标怀孕天数（默认1天）\n   - 说明：设置目标怀孕天数，用于直接推进孕期或与\"注入胎儿\"一同使用来设定孕妇的初始孕期状态。系统会自动计算对应的孕期阶段和胎儿发育情况。**仅限怀孕状态使用**\n   - 示例：`<%% bsSetPregnantDay('{{char_name}}', 150) %%>`","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":105,"position":4,"disable":true,"excludeRecursion":true,"preventRecursion":true,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":1,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"characterFilterNames":[],"characterFilterTags":[],"characterFilterExclude":false,"displayIndex":3,"ignoreBudget":false,"outletName":"","characterFilter":{"isExclude":false,"names":[],"tags":[]}},"9":{"uid":9,"key":[],"keysecondary":[],"comment":"函数声明","content":"<%\n// 检查全局设置\nlet tool_hasPregnantEmotion = this.getvar('bs.global.enablePregnantEmotion', { defaults: true });\nlet tool_hasSexExperience = this.getvar('bs.global.enableSexExperience', { defaults: true });\nlet tool_hasChildRecord = this.getvar('bs.global.enableChildRecord', { defaults: true });\n\n// 检查是否有角色启用了代谢物系统\nlet tool_hasMetabolism = false;\nfor (let char in this.variables.bs) {\n  if (char && char !== 'global' && this.variables.bs[char] && this.variables.bs[char] !== null) {\n    if (!this.getvar(`bs.${char}.metabolismImmune`, { defaults: false })) {\n      tool_hasMetabolism = true;\n      break;\n    }\n  }\n}\n\n-%>\n\n🔴 **P0 - 时间流逝 (最高优先级)**\n**⚠️ 这是唯一能自动推进生理状态的函数，必须准确使用！**\n\n**时间流逝**\n    - 函数名：`bsPassedTime`\n    - 参数：\n      * opt: object - 时间配置对象，包含以下字段：\n        * minute: integer - 分钟数（默认15分钟）\n        * second: integer - 秒数\n        * hour: integer - 小时数\n        * day: integer - 天数\n        * week: integer - 周数\n        * month: integer - 月数\n        * year: integer - 年数\n    - 说明：模拟游戏中时间的流逝。这是唯一能自动推进角色生理状态（如月经周期、怀孕进程、精液存活时间、卵子受精等）并触发相关生理事件的函数。可以组合多种单位\n    - 示例：\n      * 默认15分钟：`<%% bsPassedTime() %%>`\n      * 4小時30分 `<%% bsPassedTime({ hour: 4, minute: 30 }) %%>`\n      * 1天5小時：`<%% bsPassedTime({ day: 1, hour: 5 }) %%>`\n      * 2周：`<%% bsPassedTime({ week: 2 }) %%>`\n      * 3个月: `<%% bsPassedTime({ month: 3 }) %%>`\n\n🟡 **P1 - 核心状态函数 (高优先级)**\n\n**设置角色在场状态**\n   - 函数名：`bsSetCharacterPresence`\n   - 参数：\n     * female: string - 女性角色名称\n     * isPresent: boolean - 是否在场（默认true）\n   - 说明：设置角色是否在场，并自动初始化角色数据。在场角色会显示完整的详细信息（活力、性欲、宫压、卵子、精液、胎儿信息等），不在场角色只显示基本信息（种族、阶段，怀孕时额外显示孕期和胎数）。首次使用时会自动初始化角色的所有基础数据\n   - 示例：\n     * 角色登场：`<%% bsSetCharacterPresence('{{char_name}}', true) %%>`\n     * 角色离场：`<%% bsSetCharacterPresence('{{char_name}}', false) %%>`\n     * 默认登场：`<%% bsSetCharacterPresence('{{char_name}}') %%>`\n\n**更新角色基础状态**\n   - 函数名：`bsUpdateCharacterStatus`\n   - 参数：\n     * female: string - 女性角色名称\n     * options: object - 状态变化对象，包含以下字段：\n       * vitality: integer - 活力值变化量（值域：[0, 200]，增减值）\n       * libido: integer - 性欲值变化量（值域：[0, 150]，增减值）\n       * uterinePressure: integer - 宫压值变化量（值域：[0, 150]，增减值）\n       * psyStress: integer - 情压值变化量（值域：[0, 200]，增减值）\n   - 说明：统一管理角色的基础状态属性变化，使用增减值模式。输入变化量（如-20表示减少20，+10表示增加10），系统会自动计算最终值并确保在有效范围内。活力值会因各种能量活动而波动：进食、运动、排泄、睡眠、妊娠消耗等都会影响活力值，变化幅度通常在±5-20之间。情压值会因心理状态变化而波动：情绪刺激、压力事件、心理创伤、精神状况等都会影响情压值，变化幅度通常在±10-50之间。性欲值未妊娠时最高100，懷孕时可解鎖上限至150。宫压值未妊娠时最高30，懷孕'临产期'时需达到80才会触发产前阵痛。包含代谢物系统、宫压限制、高潮排卵系统、宫压警告等完整功能。\n   - 示例：\n     * 减少活力：`<%% bsUpdateCharacterStatus('{{char_name}}', {vitality: -20}) %%>`\n     * 增加性欲：`<%% bsUpdateCharacterStatus('{{char_name}}', {libido: 15}) %%>`\n     * 减少宫压：`<%% bsUpdateCharacterStatus('{{char_name}}', {uterinePressure: -10}) %%>`\n     * 增加情压：`<%% bsUpdateCharacterStatus('{{char_name}}', {psyStress: 30}) %%>`\n     * 同时调整多个：`<%% bsUpdateCharacterStatus('{{char_name}}', {vitality: -15, libido: 20, uterinePressure: -5, psyStress: -25}) %%>`\n\n<% if (tool_hasMetabolism) { -%>\n**缓解生理需求**\n   - 函数名：`bsExcreteMetabolism`\n   - 参数：\n     * female: string - 女性角色名称\n     * options: object - 缓解配置对象，包含以下字段：\n       * urine: integer - 尿液排泄量\n       * stool: integer - 粪便排泄量\n       * hunger: integer - 进食缓解量\n       * sleep: integer - 休息缓解量\n   - 说明：缓解角色的生理需求。**活力上升时累积便尿，活力下降时累积饿睡**。urine和stool受宫压阻碍（至多50%），hunger和sleep不受宫压影响。**残留感机制**：当代谢物>=100时，排出会有残留感，残留率根据孕期决定（假孕期10%、孕早期10%、孕中期20%、孕晚期30%、临产期/逾期40%、产前阵痛/产程50%），非怀孕状态无残留。**时间消耗**：缓解值越多，花费时间越久，需要根据缓解量合理安排剧情时间\n   - 示例：\n     * 排尿排便：`<%% bsExcreteMetabolism('{{char_name}}', {urine: 40, stool: 30}) %%>`\n     * 进食休息：`<%% bsExcreteMetabolism('{{char_name}}', {hunger: 50, sleep: 60}) %%>`\n     * 综合缓解：`<%% bsExcreteMetabolism('{{char_name}}', {urine: 40, stool: 30, hunger: 50, sleep: 60}) %%>`\n     * 完全排空：`<%% bsExcreteMetabolism('{{char_name}}', {urine: 150, stool: 150, hunger: 150, sleep: 150}) %%>`\n<% } -%>\n\n🟢 **P2 - 特殊功能函数 (中优先级)**\n\n<% if(tool_hasPregnantEmotion) { -%>\n**更新妊娠心情**\n   - 函数名：`bsUpdatePregnantEmotion`\n   - 参数：\n     * female: string - 女性角色名称\n     * options: object - 妊娠心情变化对象，包含以下字段：\n       * pregnancyAwareness: integer - 妊娠认知度变化量（值域：[0, 100]，增减值）\n       * pregnancyAcceptance: integer - 妊娠接受度变化量（值域：[0, 100]，增减值）\n       * pregnancyDisplay: integer - 怀孕展现度变化量（值域：[0, 100]，增减值）\n       * pregnancyConfidence: integer - 妊娠信心度变化量（值域：[0, 100]，增减值）\n   - 说明：调整妊娠心情的四个指标变化，使用增减值模式。输入变化量（如-20表示减少20，+30表示增加30），系统会自动计算最终值并确保在[0,100]范围内。用于控制角色对怀孕的心理状态和展现行为变化。需要调整角色对怀孕的心理状态或展现行为时使用，如角色发现怀孕、主动隐藏或展示怀孕状态、对母亲身份的信心变化等情节。仅限怀孕状态使用，每個角色一日之內只能調用一次。\n   - 示例：\n     * 角色刚发现怀孕：`<%% bsUpdatePregnantEmotion('{{char_name}}', {pregnancyAwareness: 30, pregnancyAcceptance: 20, pregnancyConfidence: 30}) %%>`\n     * 接受怀孕并充满信心：`<%% bsUpdatePregnantEmotion('{{char_name}}', {pregnancyAcceptance: 40, pregnancyConfidence: 35}) %%>`\n     * 主动隐藏怀孕且缺乏信心：`<%% bsUpdatePregnantEmotion('{{char_name}}', {pregnancyDisplay: -30, pregnancyConfidence: -25}) %%>`\n     * 设想堕胎：`<%% bsUpdatePregnantEmotion('{{char_name}}', {pregnancyAcceptance: -35}) %%>`\n     * 产前抑郁：`<%% bsUpdatePregnantEmotion('{{char_name}}', {pregnancyConfidence: -40}) %%>`\n<% } -%>\n\n**调整胎儿亲密度**\n   - 函数名：`bsAdjustFetalAffinity`\n   - 参数：\n     * female: string - 女性角色名称\n     * change: string - 亲密度变化类型（默认'slight_increase'）\n     * direction: string - 行为方向（默认'fetal'）\n   - 说明：调整胎儿与母体的亲密度，随机选择一个胎儿进行调整。每個角色一小時內只能調用一次，影响胎梦等级和胎儿与母体的情感联系。\n   - 变化类型（英文输入）：\n     * 'slight_increase': +1 亲密度\n     * 'significant_increase': +2 亲密度\n     * 'slight_decrease': -1 亲密度\n     * 'significant_decrease': -2 亲密度\n   - 行为方向：\n     * 'fetal': 胎儿对母体的行为（始终成功）\n     * 'maternal': 母体对胎儿的行为（可能因心理压力失败）\n   - 示例：\n     * 胎儿对母体轻微增加：`<%% bsAdjustFetalAffinity('{{char_name}}', 'slight_increase', 'fetal') %%>`\n     * 母体对胎儿显著減少：`<%% bsAdjustFetalAffinity('{{char_name}}', 'significant_decrease', 'maternal') %%>`\n\n\n**增加卵子数量**\n   - 函数名：`bsAddEggs`\n   - 参数：\n     * female: string - 女性角色名称\n     * amount: integer - 增加的卵子数量\n   - 说明：为女性角色增加额外的卵子数量，在女性角色处于排卵期，或需要强调其繁殖能力时使用\n   - 示例：\n     * 高潮排卵：`<%% bsAddEggs('{{char_name}}', 1) %%>`\n     * 药物促进：`<%% bsAddEggs('{{char_name}}', 2) %%>`\n     * 兽人發情：`<%% bsAddEggs('{{char_name}}', 3) %%>`\n\n**注入精液**\n   - 函数名：`bsAddSperm`\n   - 参数：\n     * female: string - 女性角色名称\n     * male: string - 男性角色名称\n     * race: string - 精液提供者的种族\n     * amount: integer - 注入的精液量\n   - 说明：向女性角色注入精液，增加受孕机会\n   - 种族设置说明：\n     * 纯种示例：`'人类'`、`'精灵'`、`'兽人'`\n     * 混血示例：`'天使x恶魔'`、`'精灵x人类'`\n     * 子类种族示例: `兽耳族-貓族`\n     * 衍生种族示例：`'[吸血鬼]人类'`、`'[杜拉罕]半人马'`\n   - 特殊用法：\n     * 百合磨镜：当两个女性角色进行磨镜行为时，可以互相注入愛液。例如：`<%% bsAddSperm('{{char_name}}', '闺蜜', '人类', 8) %%>`\n     * 扶他自慰：当扶他角色自慰时，可以给自己注入精液。例如：`<%% bsAddSperm('{{char_name}}', '{{char_name}}', '人类', 12) %%>`\n   - 示例：`<%% bsAddSperm('{{char_name}}', '{{user_name}}', '人类', 15) %%>`\n\n**排出精液**\n   - 函数名：`bsDrainSperm`\n   - 参数：\n     * female: string - 女性角色名称\n     * amount: integer - 排出的精液量\n   - 说明：角色主动将精液排出体外，减少受孕机会\n   - 示例：`<%% bsDrainSperm('{{char_name}}', 5) %%>`\n\n**分娩**\n    - 函数名：`bsChildbirth`\n    - 参数：\n      * female: string - 女性角色名称\n    - 说明：让角色立即分娩，结束分娩过程并进入产后恢复阶段\n    - 示例：`<%% bsChildbirth('{{char_name}}') %%>`\n\n**流产/避孕/减胎**\n    - 函数名：`bsAbortion`\n    - 参数：\n      * female: string - 女性角色名称\n      * force: boolean - 是否强制流产（默认false，用于医疗堕胎）\n      * fetusIndex: integer - 要移除的胎儿索引（默认null，移除全部）\n    - 说明：为已怀孕的女性角色堕胎令其流产，或者令其避孕。如果在已受精阶段使用则算作避孕成功，其他阶段算作流产。当force=true时，可以绕过流产免疫保护进行医疗堕胎。**当指定fetusIndex时，只移除该索引的胎儿（减胎），不算流产经验。减胎可能由多种原因导致：医疗手术、胎内相残、自然吸收等**\n    - 示例：\n      * 普通流产：`<%% bsAbortion('{{char_name}}') %%>`\n      * 医疗堕胎：`<%% bsAbortion('{{char_name}}', true) %%>`\n      * 减胎（移除第1个胎儿）：`<%% bsAbortion('{{char_name}}', false, 0) %%>`\n\n🔵 **P3 - 高级配置函数 (低优先级)**\n\n<% if(tool_hasSexExperience) { -%>\n**更新角色情感与妊娠经验**\n   - 函数名：`bsUpdateExperience`\n   - 参数：\n     * female: string - 女性角色名称\n     * exp: object - 经验值对象，包含以下字段：\n       - virginity: string|null - 处女对象，null表示是处女\n       - mate: string|null - 现任伴侣，null表示单身\n       - latestSexPartner: string - 最近性伴侣\n       - relationshipExperience: integer - 感情经验人数\n       - pregnantExperience: integer - 怀孕经验次数\n       - birthExperience: integer - 生产经验次数\n       - miscarriageExperience: integer - 流产经验次数\n   - 说明：用于设定或更新角色的情感与妊娠经验，可用于角色的背景设定（如初始状态、历史经历、复杂关系等），也可在剧情推进时动态调整。latestSexPartner会在超过一个完整月经周期后自动清空，避免显示过时的性伴侣信息。\n   - 示例：\n     * 设置处女：`<%% bsUpdateExperience('{{char_name}}', {virginity: null}) %%>`\n     * 初次性经验：`<%% bsUpdateExperience('{{char_name}}', {virginity: '{{user_name}}'}) %%>`\n     * 高中女生（17岁，已破处）：`<%% bsUpdateExperience('{{char_name}}', {virginity: '前男友', mate: '{{user_name}}', relationshipExperience: 2, pregnantExperience: 0}) %%>`\n     * 熟练妓女（25岁，工作5年）：`<%% bsUpdateExperience('{{char_name}}', {virginity: '初恋', mate: null, relationshipExperience: 8, pregnantExperience: 5, birthExperience: 0, miscarriageExperience: 5}) %%>`\n     * 守贞人妻（33岁，有2个孩子）：`<%% bsUpdateExperience('{{char_name}}', {virginity: '丈夫', mate: '丈夫', relationshipExperience: 1, pregnantExperience: 2, birthExperience: 2, miscarriageExperience: 0}) %%>`\n<% } -%>\n\n<% if (tool_hasChildRecord) { -%>\n**注入孩子信息**\n   - 函数名：`bsInsertBabyInfo`\n   - 参数：\n     * female: string - 女性角色名称\n     * baby: object - 胎儿对象（包含fathers、gender、race等字段）\n     * data: object - 可选的孩子配置对象，包含以下字段：\n       * babyName: string - 孩子姓名（默认null）\n       * babySex: string - 孩子性别（默认使用baby.gender）\n       * babyRace: string - 孩子种族（默认使用baby.race）\n       * age: number - 孩子年龄（岁，支持小数，默认0）\n   - 说明：用于角色在故事开始时已经是母亲的情况，手动添加已出生的孩子信息。孩子将被记录到child数组中，年龄会随时间自动增长\n   - 示例：\n     * 5岁孩子：`<%% bsInsertBabyInfo('{{char_name}}', {fathers: '前夫', gender: '男', race: '人类'}, {babyName: '小明', age: 5}) %%>`\n     * 2岁半孩子：`<%% bsInsertBabyInfo('{{char_name}}', {fathers: '前夫', gender: '女', race: '人类'}, {babyName: '小红', age: 2.5}) %%>`\n     * 新生儿（未命名）：`<%% bsInsertBabyInfo('{{char_name}}', {fathers: '未知', gender: '女', race: '精灵'}) %%>`\n<% } -%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":104,"position":4,"disable":false,"excludeRecursion":true,"preventRecursion":true,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":1,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"characterFilterNames":[],"characterFilterTags":[],"characterFilterExclude":false,"displayIndex":4,"triggers":[],"ignoreBudget":false,"outletName":"","characterFilter":{"isExclude":false,"names":[],"tags":[]}},"10":{"uid":10,"key":[],"keysecondary":[],"comment":"人外產科學-物種文本","content":"<%_\nconst race_enableMonsterOBGYN = this.getvar && this.getvar('bs.global.enableMonsterOBGYN', { defaults: true });\nconst race_activeRaces = race_enableMonsterOBGYN ? (this.getvar('bs.global.activeRaces', { defaults: [] }) || []) : [];\n\n// 辅助函数：检查种族是否应该显示（包括主种族、子种族、混血）\nfunction shouldShowRace(raceName) {\n  if (!race_enableMonsterOBGYN) return false;\n  \n  // 检查完全匹配\n  if (race_activeRaces.includes(raceName)) return true;\n  \n  // 检查是否有子种族（如 \"兽耳族-猫族\" 应该显示 \"兽耳族\"）\n  const hasSubRace = race_activeRaces.some(r => r.startsWith(raceName + '-'));\n  if (hasSubRace) return true;\n  \n  // 检查是否在混血中（如 \"人类X精灵\" 应该显示 \"人类\" 和 \"精灵\"）\n  const inHybrid = race_activeRaces.some(r => {\n    const parts = r.split(/[xX]/);\n    return parts.includes(raceName);\n  });\n  if (inHybrid) return true;\n  \n  // 检查是否在衍生种族中（如 \"[吸血鬼]人类\" 应该显示 \"人类\"）\n  const inDerived = race_activeRaces.some(r => {\n    const match = r.match(/^\\[([^\\]]+)\\](.+)$/);\n    return match && match[2] === raceName;\n  });\n  if (inDerived) return true;\n  \n  return false;\n}\n_%>\n<%_ if (shouldShowRace('人类')) { _%>\nhuman:\n  name: '人类'\n  description: '人类是最普遍的物种，具有高度智能和创造力'\n  appearance: '参考現實世界'\n  physiology:\n<%- getRacePhysiology('人类') %>\n  characteristics:\n    - '生理数值，月經妊娠症状为各类亚人的基底'\n    - '分娩90%为头位順產，但多胎时易出現难产位'\n    - '适应性强，能在后天转变为其他物种'\n<%_ } _%>\n<%_ if (shouldShowRace('精灵')) { _%>\nelf:\n  name: '精灵'\n  description: '精灵森林中的长生种，拥有强大的魔法能力'\n  appearance: '尖耳, 身材高挑'\n  physiology:\n<%- getRacePhysiology('精灵') %>\n  characteristics:\n    - '月經妊娠症状与魔力失衡有關，胎儿对环境魔力敏感'\n    - '妊娠不累积脂肪，因此不易显怀'\n    - '因新生儿体型较小，生产比人类容易，但需花费长时间恢复魔力'\n<%_ } _%>\n<%_ if (shouldShowRace('兽耳族')) { _%>\nkemono:\n  name: '兽耳族'\n  description: '拥有兽耳和兽尾，兼具野兽般力量和速度，但寿命较短'\n  appearance: '参考现实世界的哺乳动物特征，并拟人化'\n  physiology:\n<%- getRacePhysiology('兽耳族') %>\n  characteristics:\n    - '排卵期会发情，需借由性交来平复'\n    - '妊娠症状与通常使野性复苏，有护巢行为'\n    - '假孕现象常见，防止过度繁殖还可哺育非亲族幼崽'\n<%_ } _%>\n<%_ if (shouldShowRace('袋兽族')) { _%>\nmarsupial:\n  name: '袋兽族'\n  description: '拥有育儿袋的哺乳类亚人种，幼体在袋中发育'\n  appearance: '人形躯干，腹部有育儿袋可容纳多只幼体，腿部发达，尾巴平衡'\n  physiology:\n<%- getRacePhysiology('袋兽族') %>\n  characteristics:\n    - '具备胚胎滞育能力，若袋中已有幼体，新胚胎会暂停发育'\n    - '处在育幼期间，母体的体力会强化'\n    - '育儿袋不仅能哺育亲生子女，也能收养他种族幼体'\n<%_ } _%>\n<%_ if (shouldShowRace('哥布林')) { _%>\ngoblin:\n  name: '哥布林'\n  description: '小型绿肤亚人，繁殖力旺盛'\n  appearance: '身材矮小、绿皮肤、锐利牙齿'\n  physiology:\n<%- getRacePhysiology('哥布林') %>\n  characteristics:\n    - '高繁殖力，几乎不挑配偶'\n    - '多胎妊娠普遍，偏向寄生式妊娠，异种母体死亡率较高'\n    - '会催生母爱来阻止母体堕胎'\n<%_ } _%>\n<%_ if (shouldShowRace('兽人')) { _%>\norc:\n  name: '兽人'\n  description: '强壮的战士种族，身体素质极佳，但思维直线'\n  appearance: '绿皮肤且肌肉发達，帶兽性面容'\n  physiology:\n<%- getRacePhysiology('兽人') %>\n  characteristics:\n    - '身体素质好，分娩難度与人类接近'\n    - '适应力强，战鬥狀態不影響生育'\n    - '各类胎位都不影響分娩'\n<%_ } _%>\n<%_ if (shouldShowRace('矮人')) { _%>\ndwarf:\n  name: '矮人'\n  description: '擅长工藝与矿业的种族，体格结实，普遍具有毒抗性'\n  appearance: '矮小结实，肌肉和骨骼密度高, 成長期超長且青春延緩'\n  physiology:\n<%- getRacePhysiology('矮人') %>\n  characteristics:\n    - '腹肌厚實，所以感受不到胎動'\n    - '因毒抗性，妊娠吸菸饮酒反而是安全行为'\n    - '產道收縮效率比人類差，需外力壓腹推擠來助產'\n<%_ } _%>\n<%_ if (shouldShowRace('半身人')) { _%>\nhalfling:\n  name: '半身人'\n  description: '身材娇小却极具生命力的亚人族，擅长农耕与手工'\n  appearance: '身高不及人类一半，皮肤细致柔软'\n  physiology:\n<%- getRacePhysiology('半身人') %>\n  characteristics:\n    - '皮肤极薄且血流旺盛，怀孕初期便会显怀且胎动明显'\n    - '孕期体温异常偏高，常被误认为持续发烧，伴随极度嗜甜与暴食倾向'\n    - '多胎率高导致早产风险，为补偿而延长泌乳期并能分泌高营养乳汁'\n<%_ } _%>\n<%_ if (shouldShowRace('半人马')) { _%>\ncentaur:\n  name: '半人马'\n  description: '上半身为人，下半身为马的种族'\n  appearance: '人马混合体，马蹄健壮'\n  physiology:\n<%- getRacePhysiology('半人马') %>\n  characteristics:\n    - '子宮位於马的腹部內'\n    - '耐力惊人, 即便孕晚期也能荷重和奔跑'\n    - '胎位复杂，需要专门的助产环境'\n<%_ } _%>\n<%_ if (shouldShowRace('巨人')) { _%>\ngiant:\n  name: '巨人'\n  description: '庞大高耸的种族，寿命悠长'\n  appearance: '体型巨大，通常数十倍於人类'\n  physiology:\n<%- getRacePhysiology('巨人') %>\n  characteristics:\n    - '妊娠胎动會造成地动山摇'\n    - '可以讓矮小種族進入宮內進行胎檢'\n    - '分娩後的胎盤具有放射性，需要特殊處理'\n<%_ } _%>\n<%_ if (shouldShowRace('魅魔')) { _%>\nsuccubus:\n  name: '魅魔'\n  description: '以情慾与魔力维生的种族，女性称媚魔，男性称夢魔'\n  appearance: '魅惑姿态，通常具尾巴和翼'\n  physiology:\n<%- getRacePhysiology('魅魔') %>\n  characteristics:\n    - '对受孕有强大的自主权'\n    - '怀孕后，她们是吸收精液能力大减，需要提高性行为频率来维持魔力'\n    - '分娩不會感受痛苦，而是至高欢愉'\n<%_ } _%>\n<%_ if (shouldShowRace('雪族')) { _%>\nsnowfolk:\n  name: '雪族'\n  description: '栖息於極寒地帶的高智慧哺乳亞人種，雄性稱雪怪、雌性稱雪女。具極強寒適性與情感感溫反應'\n  appearance: '雄性皮膚呈深褐、全身覆白毛；雌性膚白如雪、髮長如霜，氣息寒冽'\n  physiology:\n<%- getRacePhysiology('雪族') %>\n  characteristics:\n    - '體溫可根據伴侶狀態變化，用於性愛或避孕'\n    - '懷孕時需依靠情感溫度維持胎兒活性，若情感疏離胎兒將結冰死亡，物理加熱無效'\n    - '後代幼體外觀類人類，初戀後才開始冰化或毛化轉變'\n<%_ } _%>\n<%_ if (shouldShowRace('夜叉')) { _%>\nyaksha:\n  name: '夜叉'\n  description: '以吞噬业力为生的长生亚人种族，身具角与异色瞳。拥有强烈的繁殖本能与惊人生命力。'\n  appearance: '人形躯体、肌肉结实、头生双角或单角，皮肤偏红或灰色，瞳孔似燃烧的余烬。'\n  physiology:\n<%- getRacePhysiology('夜叉') %>\n  characteristics:\n    - '排卵伴随强烈繁殖冲动与短暂失控，通常需透过性行为释放以防精神崩解'\n    - '胎儿为受业者灵魂转生体，孕期必须透过苦行或自虐压抑胎灵夺舍'\n    - '分娩极为危险，新生夜叉初生即具狂性，需以术式压制后方能接触'\n<%_ } _%>\n<%_ if (shouldShowRace('鸟人')) { _%>\nbirdfolk:\n  name: '鸟人'\n  description: '拥有翅膀的人形种族，能长距離飛行'\n  appearance: '人形上半身，手为翅膀，下肢似鳥足'\n  physiology:\n<%- getRacePhysiology('鸟人') %>\n  characteristics:\n    - '月經產下無受精卵，具食用價值'\n    - '孕期可飛行，需補充额外飲養協助胚胎长殼'\n    - '孵化過程需要高溫与父母共同照顧'\n<%_ } _%>\n<%_ if (shouldShowRace('植物亚人')) { _%>\nplantfolk:\n  name: '植物亚人'\n  description: '半人半植物的亚人种族，与自然共生'\n  appearance: '人形体態，常伴有葉片或藤蔓特征'\n  physiology:\n<%- getRacePhysiology('植物亚人') %>\n  characteristics:\n    - '具備自交能力，單一個体即可维持族群延續'\n    - '多倍體為常態，胚胎需光合作用輔助生长'\n    - '產卵时會与花苞結合，须种在土壤才會发芽'\n<%_ } _%>\n<%_ if (shouldShowRace('真菌亚人')) { _%>\nfungifolk:\n  name: '真菌亚人'\n  description: '半人半真菌的亞人，能以孢子繁衍後代, 棲息在潮濕環境'\n  appearance: '人形體態，頭或身體上長有蘑菇傘或菌絲紋理'\n  physiology:\n<%- getRacePhysiology('真菌亚人') %>\n  characteristics:\n    - '孢子卵团紧密相连，需潮湿环境才能孵化'\n    - '若寄生於異種孕婦，會將其中一胎改造成真菌混血'\n    - '母體懷孕時氣味會改變，吸引更多真菌伴生'\n<%_ } _%>\n<%_ if (shouldShowRace('社会虫族')) { _%>\nsocial_insectoid:\n  name: '社会虫族'\n  description: '以昆蟲为基因基底的拟人种族，具有高度社会性，群体协作繁殖'\n  appearance: '外骨骼、人形与昆蟲混合体，通常具有明显的阶层特征'\n  physiology:\n<%- getRacePhysiology('社会虫族') %>\n  characteristics:\n    - '母体产卵后由工虫集体照料，分工明确'\n    - '幼虫孵化后根据营养和环境自动分化成不同阶层'\n    - '雖然非蟲后無孕育能力，過量信息素可打破限制而受精'\n<%_ } _%>\n<%_ if (shouldShowRace('触手怪')) { _%>\ntentacle:\n  name: '触手怪'\n  description: '外形怪異的种族，無性無欲，僅以擴散與感染為目的的智慧流體'\n  appearance: '軟體生物般的躯体，中心核體具多眼構造，表面佈滿蠕動的觸手與孢囊'\n  physiology:\n<%- getRacePhysiology('触手怪') %>\n  characteristics:\n    - '无性别生物，通过向异族母体注入卵囊进行繁殖'\n    - '繁殖行為對宿主而言通常具強烈快感或幻覺，是「傳播媒介」而非「交配行為」'\n    - '被寄生的母体分娩触手怪卵囊时如同排宿便，但宿主產后恢复极快'\n<%_ } _%>\n<%_ if (shouldShowRace('妖精')) { _%>\nfairy:\n  name: '妖精'\n  description: '自然生命力化形的小型亚人种族，性情淘氣'\n  appearance: '小巧身軀，有著透明薄翼'\n  physiology:\n<%- getRacePhysiology('妖精') %>\n  characteristics:\n    - '可借由魔法協助性交，克服異种体型差距'\n    - '孕期极度耗能，會自動吸收环境的魔力来维持'\n    - '卵的大小接近於母体，孵化时需要特殊环境'\n<%_ } _%>\n<%_ if (shouldShowRace('海蛞蝓族')) { _%>\nseaslug:\n  name: '海蛞蝓族'\n  description: '海生軟体亞人，具備改變對方性別的獨特能力，通過「性器劍鬥」決定生育權'\n  appearance: '人形上半身，下半身如裙擺般飄逸，頭上兩根觸角，色彩繽紛'\n  physiology:\n<%- getRacePhysiology('海蛞蝓族') %>\n  characteristics:\n    - '具備「性別轉換」能力，可將任何種族轉為可孕狀態，連異族也不例外'\n    - '性器劍鬥：雙方以生殖器為劍進行對決，敗者必須懷孕，且性別會暫時轉換'\n    - '戰敗後性別轉換持續至卵囊孵化為止，期間完全適應新性別的生理特徵'\n<%_ } _%>\n<%_ if (shouldShowRace('蜥蜴人')) { _%>\nlizardfolk:\n  name: '蜥蜴人'\n  description: '起源于远古龙族分支的水陆两栖亚人，兼具鳞皮防御与温血代谢能力'\n  appearance: '人形躯体覆有细鳞，具长尾与裂瞳，喉咙有低鸣腺能发出振音语'\n  physiology:\n<%- getRacePhysiology('蜥蜴人') %>\n  characteristics:\n    - '雄性具双阴茎，每次仅使用一侧，允许连续交配并提高受孕率'\n    - '怀孕期间尾巴失去再生能力，为补营养会自噬尾段'\n    - '孵化温度决定性别，温差过大则导致性征异常'\n<%_ } _%>\n<%_ if (shouldShowRace('龟族')) { _%>\nturtlefolk:\n  name: '龟族'\n  description: '披甲而生的卵生亚人，象征稳重与长寿。兼具陆行与水栖能力'\n  appearance: '人形躯体覆盖坚甲，背后连接龟壳，头颈可伸缩，四肢粗壮有爪，部分个体具鳃裂或尾鳍'\n  physiology:\n<%- getRacePhysiology('龟族') %>\n  characteristics:\n    - '雌性交配时须仰躺，以示信任与臣服；此姿势也是繁殖礼仪的象征'\n    - '能将头与四肢缩入壳内以防御或高速旋转移动，惟怀孕后腹部膨隆导致无法完全收缩'\n    - '具强烈「归巢本能」，临盆时会自动寻回出生地或同族巢穴产卵'\n<%_ } _%>\n<%_ if (shouldShowRace('甲壳族')) { _%>\ncrustacean:\n  name: '甲壳族'\n  description: '生活于潮间带与浅海的甲壳亚人，体表覆有外骨骼，能随蜕壳进行体型重构'\n  appearance: '人形上半身，四肢与腹部具节状甲壳，尾部可展开成游泳扇或抱卵腹片'\n  physiology:\n<%- getRacePhysiology('甲壳族') %>\n  characteristics:\n    - '孕期需四次蜕壳，以适应腹部膨胀与外壳更新，若环境缺钙则可能导致壳裂危症'\n    - '产卵后，母体以尾节将卵包覆于腹下并以黏液固定，抱卵孵化期间称为「蟹化期」，象征从少女转化为母体'\n    - '抱卵母体性格会稳定化，体表硬化并色泽加深；未产或雄体外观则偏虾型，活动敏捷但防御较弱'\n<%_ } _%>\n<%_ if (shouldShowRace('人鱼')) { _%>\nmermaid:\n  name: '人鱼'\n  description: '能在魚尾与双足之间切換的水陸兩棲亚人'\n  appearance: '上半身人形，下半身魚尾；可在陸地切換为双足'\n  physiology:\n<%- getRacePhysiology('人鱼') %>\n  characteristics:\n    - '多倍體是人魚能切換魚尾/双足的關鍵，一般人魚無法上陸'\n    - '月經節律受潮汐影響，滿月前后症状顯著'\n    - '分娩须回到海中進行，双足强行切換至魚尾'\n<%_ } _%>\n<%_ if (shouldShowRace('鱼人')) { _%>\nfishfolk:\n  name: '鱼人'\n  description: '双足行走并具大型肥厚尾鰭的长生种海洋亚人，兼具哺乳特徵與鰭狀尾，具鯊類的電感覺或鯨類的聲納能力'\n  appearance: '人形軀幹与四肢，身后連接大型尾鰭'\n  physiology:\n<%- getRacePhysiology('鱼人') %>\n  characteristics:\n    - '鯨类陰道結構，可自身決定是否受孕'\n    - '孕肚極大，子宮內含豐富的羊水與脂肪層供胎兒自由游動'\n    - '因呼吸壓力問題，分娩必須上岸，胎兒均為尾先露'\n<%_ } _%>\n<%_ if (shouldShowRace('海妖')) { _%>\nsiren:\n  name: '海妖'\n  description: '深海中的头足类亚人种，拥有高智商、觸手會獨立思考'\n  appearance: '人形上半身，下半身为触手或软体结构，常具魅惑性外貌'\n  physiology:\n<%- getRacePhysiology('海妖') %>\n  characteristics:\n    - '妊娠时胎儿常出現特殊现象：吐墨液、吸盤附著子宮壁'\n    - '分娩耗时极长，過程相當於把子宮內膜剝離，內膜與卵囊結合成为幼体的「囊胎被」，提供早期庇护'\n    - '母体分娩后极度虛弱，恢复期遠长於妊娠期，難以育兒'\n<%_ } _%>\n<%_ if (shouldShowRace('水母族')) { _%>\njellyfish:\n  name: '水母族'\n  description: '海洋中的透明软体亚人，通常個體越小毒性越强'\n  appearance: '上半身為人形，膚色半透明可見內部流光；下半身為柔軟傘裙狀觸手群，頭上生有細長感應觸鬚'\n  physiology:\n<%- getRacePhysiology('水母族') %>\n  characteristics:\n    - '懷孕期間需定期以毒螫刺激孕肚，訓練胚胎的抗毒性與發光反射'\n    - '孕中期若遇危險，可強制排卵並將卵埋入海床形成水螅體，存活率低於20%'\n    - '孕晚期卵在宮內孵化為水螅型幼體，最終以完整水母寶寶的型態誕生'\n<%_ } _%>\n<%_ if (shouldShowRace('蛇人')) { _%>\nlamian:\n  name: '蛇人'\n  description: '上半身为人，下半身为长蛇軀体的水陸兩棲亚人'\n  appearance: '人形上半身，蛇形下軀，鱗片覆体'\n  physiology:\n<%- getRacePhysiology('蛇人') %>\n  characteristics:\n    - '交配时间极长，可持續數日不间斷'\n    - '怀孕对环境溫度高度敏感，需外源供暖；恆溫能力弱化'\n    - '孕期毒性顯著减弱，甚至無法自行脫皮'\n<%_ } _%>\n<%_ if (shouldShowRace('蛙人')) { _%>\nfrogfolk:\n  name: '蛙人'\n  description: '兼具水陆特性的亚人，胎生卵化于体内，孕期依赖湿润环境'\n  appearance: '人形体态，皮肤光滑无鳞，常带有蛙眼或鳃痕，且手脚皆有蹼'\n  physiology:\n<%- getRacePhysiology('蛙人') %>\n  characteristics:\n    - '胎儿在子宫中以蝌蚪形态发育，孕肚半透明，可见游动黑影'\n    - '幼体出生时已完成变态，直接为小型蛙人;起初無性，之後才因外部環境決定其性徵'\n    - '由於孕期子宮壓迫鳴囊使出氣量下降，沒辦法長時間嘓嘓'\n<%_ } _%>\n<%_ if (shouldShowRace('独居虫族')) { _%>\nsolitary_insectoid:\n  name: '独居虫族'\n  description: '以昆蟲为基因基底的拟人种族，独立生存，自我保护意识强'\n  appearance: '外骨骼、人形与昆蟲混合体，通常具有保护性特征如硬壳或毒刺'\n  physiology:\n<%- getRacePhysiology('独居虫族') %>\n  characteristics:\n    - '懷孕時有意圖捕食配偶的本能，縱使資源充足'\n    - '孕育條件不佳時，會將胚胎注入至異族母體內代孕'\n    - '幼蟲根據環境壓力快速進化，但缺乏群體意識'\n<%_ } _%>\n<%_ if (shouldShowRace('眼魔')) { _%>\nBeholder:\n  name: '眼魔'\n  description: '以巨大單眼為主體的漂浮亞人，擁有多條長有小眼珠的觸手髮'\n  appearance: '軀幹為單眼裂口人形，四肢為半實體化的黑影，漂浮移動'\n  physiology:\n<%- getRacePhysiology('眼魔') %>\n  characteristics:\n    - '懷孕因複眼闔上使立體視覺喪失，行動顯得笨拙'\n    - '胎兒以母體肚臍眼作為視覺器官，會對他人凝視產生排斥反應'\n    - '分娩時需在眾人注視下，胎兒才願意出世'\n<%_ } _%>\n<%_ if (shouldShowRace('海龙人')) { _%>\nseadraconian:\n  name: '海龙人'\n  description: '外型似龙而非龙，实为海马型卵胎生亚人。雄性负责怀胎与分娩，象征温柔与坚忍的父性之族'\n  appearance: '人形上半身，腹部至尾部呈鱼龙状，体表覆细鳞与流线状鳍须；雄性腹部具封闭式育儿囊'\n  physiology:\n<%- getRacePhysiology('海龙人') %>\n  characteristics:\n    - '雄性于交配时将雌性受精卵吸入体内育儿袋，透过阴茎逆向蠕动完成「反向受精」'\n    - '育儿袋为半开放腔体，能以血液提供氧气与养分；临盆时阴部裂开形成临时产口，撕裂与修复剧烈疼痛'\n    - '雌性理論上可受孕，但生殖腔擴容幅度有限，易造成早產且難產'\n<%_ } _%>\n<%_ if (shouldShowRace('河童')) { _%>\nkappa:\n  name: '河童'\n  description: '生活于淡水河川的半两栖族群，体表具短鳞与半透明皮肤，兼具鱼、龟、人之特征。'\n  appearance: '头顶具蓄水圆盘，背负可拆卸龟甲，双足具蹼。'\n  physiology:\n<%- getRacePhysiology('河童') %>\n  characteristics:\n    - '以夺取人类尾骨之灵核（尻子玉）作为求偶行为，象征对潜在伴侣的「生命索取与交还」。'\n    - '怀孕后背部龟甲会拆卸来减轻负重，外观近似光滑背脊'\n    - '临盆时头盘水分急剧蒸发干涸，须将新生儿的卵膜置于头盘上撕裂，以胎水回润头盘——此仪式象征母子生命循环'\n<%_ } _%>\n<%_ if (shouldShowRace('星茧族')) { _%>\nasterococoon:\n  name: '星茧族'\n  description: '太空中的蟲型亚人，外型千變萬化，但皆保有人臉，孕期最終以繭/蛹完成发育'\n  appearance: '蟲型外觀，具人形面貌；肢体与翅膀差異极大'\n  physiology:\n<%- getRacePhysiology('星茧族') %>\n  characteristics:\n    - '幼体於母体內发育，最終形成繭/蛹，由母体產出在外羽化'\n    - '孕育耗能极大，需仰賴群体供能，若無社會性協作則無法完成妊娠'\n    - '供能方式多樣，常以能量契約或跨种族協作的形式出現'\n<%_ } _%>\n<%_ if (shouldShowRace('龙族')) { _%>\ndragonkin:\n  name: '龙族'\n  description: '拥有龙族血统的长生亚人，吐息和龙语为其标志'\n  appearance: '人形軀體，保留龍角、鱗片或尾巴等龍族特征'\n  physiology:\n<%- getRacePhysiology('龙族') %>\n  characteristics:\n    - '孕期腹部长出厚重鱗甲保护，常因噴嚏导致吐息失控'\n    - '蛋体巨大，產道需极限擴張，必须以溫泉潤滑助产'\n    - '幼体需於特殊环境孵化，并由母亲定期以龙语吟唱助其成长'\n<%_ } _%>\n<%_ if (shouldShowRace('狮鹫族')) { _%>\ngryphon:\n  name: '狮鹫族'\n  description: '兼具獅身与鷲翼的亚人种族，是陆地与天空的霸主'\n  appearance: '四足兽形为主，前腳為獅爪，後腳為鷲爪。因翅膀結構，無法直立行走'\n  physiology:\n<%- getRacePhysiology('狮鹫族') %>\n  characteristics:\n    - '必须於天空交配才可能受孕，交配时间极短，求偶過程卻极为漫长'\n    - '怀孕后無法飛行，即便化卵后仍會亂動，导致失衡'\n    - '每次產卵數量较多，但最終僅保留最優個体，其餘卵會被母体吞食'\n<%_ } _%>\n<%_ if (shouldShowRace('奇美拉')) { _%>\nchimera:\n  name: '奇美拉'\n  description: '由多種族血統錯亂交融而生的亞人種族，體內基因具高度不穩定性，但仍遵循混合規律。'\n  appearance: '外貌依血統而變，常呈人形基底夾雜獸、龍、魔等特徵。'\n  physiology:\n<%- getRacePhysiology('奇美拉') %>\n  characteristics:\n    - '若黃體期未受孕，卵子會異常生長並於經期形成具殼之卵'\n    - '可透過「經蛋」推卵注入異族雌性體內孕育；卵具自動基因擷取機制形成合子'\n    - '若於卵泡期與注卵對象性交，奇美拉可能被反向受孕，使雙方同時懷上血緣相連的雙胎'\n<%_ } _%>\n<%_ if (shouldShowRace('天使')) { _%>\nangel:\n  name: '天使'\n  description: '具備光環与羽翼的超自然存在'\n  appearance: '人形体態，背生羽翼，頭頂光環，光環個体略有差異'\n  physiology:\n<%- getRacePhysiology('天使') %>\n  characteristics:\n    - '胎儿天生具光環，光環會隨情緒波動，是外在可觀察的指示器'\n    - '怀孕會激发母体「善」的一面，情緒趨向平和与利他'\n    - '分娩后產下的光卵會自行孵化，母体無须额外撫養'\n<%_ } _%>\n<%_ if (shouldShowRace('恶魔')) { _%>\ndemon:\n  name: '恶魔'\n  description: '魔性凝聚的超自然存在'\n  appearance: '人形体態，具角、尾、翼，魔氣外顯，角的形狀個体略有差異'\n  physiology:\n<%- getRacePhysiology('恶魔') %>\n  characteristics:\n    - '胎儿可於足月前被拉出体外，以鎖鏈狀臍帶与母体連結'\n    - '怀孕會激发母体「惡」的一面，情緒趨向暴虐与自私'\n    - '分娩后產下的魔卵會自行孵化，母体無须额外撫養'\n<%_ } _%>\n<%_ if (shouldShowRace('麒麟')) { _%>\nkirin:\n  name: '麒麟'\n  description: '象征仁德与和平的圣兽，能化形为人，兼具龙族血统与神性之气'\n  appearance: '人形时为白金发与温润瞳的优雅外貌；兽形为麟甲覆体、散发柔和灵光'\n  physiology:\n<%- getRacePhysiology('麒麟') %>\n  characteristics:\n    - '妊娠期母体生命能旺盛，所至之处草木繁盛、病患自愈'\n    - '临盆时释放仁慈光环，具精神安抚与止战效应，能让周遭众生停息争斗'\n    - '所诞之子为龙之九子，若修行圆满、受天命感召，方可再化为麒麟'\n<%_ } _%>\n<%_ if (shouldShowRace('凤凰')) { _%>\nphoenix:\n  name: '凤凰'\n  description: '象征轮回与永生的神鸟，能化形为人，以烈焰重生为天性'\n  appearance: '人形时为赤金或深红长发、瞳似熔金；羽形时全身覆燃烧羽翼，燃而不焚'\n  physiology:\n<%- getRacePhysiology('凤凰') %>\n  characteristics:\n    - '怀孕后体温持续上升，体表羽毛灰化成烬灰色，仍保持高能燃烧状态'\n    - '分娩时母体燃尽一次生命周期，失去重生能力；其灰烬化为后代卵壳的加固层'\n    - '产下之卵孵出后代多为凡鸟形态，不具再生能力，唯有经历一次死亡与涅盘，后代才能蜕变为真正的凤凰'\n<%_ } _%>\n<%_ if (shouldShowRace('白泽')) { _%>\nhakutaku:\n  name: '白泽'\n  description: '远古的博识圣兽，能化形为人。据说其知晓天地万物、善恶吉凶，其体态融合多种瑞兽特征，为万物之师。'\n  appearance: '具人形躯干，覆柔毛，头生牛角与三眼，脚为羊蹄，尾如石狮，背具蝙蝠翼；腹部有可收纳巨卵的育儿袋。'\n  characteristics:\n    - '怀孕期间思维会显着迟缓且无法说谎'\n    - '产卵后，巨大的蛋需放入育儿袋内持续孵化，袋内空间完全被占满'\n    - '胚胎在蛋内以爪书刻字，内容虽混乱，却被视为白泽此生第一部史书'\n<%_ } _%>\n<%_ if (shouldShowRace('史萊姆')) { _%>\nslime:\n  name: '史萊姆'\n  description: '全身透明的拟態魔物，体內有閃亮魔核'\n  appearance: '軟体狀態，能拟態为人形或其他物体，核心位於胸口附近'\n  physiology:\n<%- getRacePhysiology('史萊姆') %>\n  characteristics:\n    - '怀孕时所孕育的是精子方的种族；反之让他者怀孕时，胎儿實为自身分裂体'\n    - '孕期拟態能力顯著下降，孕肚保持透明，能清晰看見胎儿'\n    - '因身体柔軟無比，分娩幾乎沒有難度'\n<%_ } _%>\n<%_ if (shouldShowRace('附丧神')) { _%>\ntsukumogami:\n  name: '附丧神'\n  description: '器具长久使用后生成的靈性自我投射，呈現类人姿态'\n  appearance: '类人外觀，但常帶有原器具的元素'\n  physiology:\n<%- getRacePhysiology('附丧神') %>\n  characteristics:\n    - '必须与使用者心意相通，透過性交方能受孕'\n    - '孕期需準備嶄新的器物作为后代靈体寄宿之所，多胎必须準備多個器物，否則靈体會分散消散'\n    - '新生的后代同时是器物与靈体二者的結合，也被視为「自己的主人」'\n<%_ } _%>\n<%_ if (shouldShowRace('石像鬼')) { _%>\ngargoyle:\n  name: '石像鬼'\n  description: '白天化为石像，夜晚能活動的守护構造体'\n  appearance: '类人形石像，帶有翅膀或兽面特征'\n  physiology:\n<%- getRacePhysiology('石像鬼') %>\n  characteristics:\n    - '受孕需由人協助採精后注入体內'\n    - '孕期并不特別长，但白天时间停滞，导致体感孕期极漫长。孕婦夜间苏醒时间會混亂，常出現迷失'\n    - '分娩產下一顆石塊，作为新石像鬼的材料'\n<%_ } _%>\n<%_ if (shouldShowRace('烛灵')) { _%>\ncandlespirit:\n  name: '烛灵'\n  description: '以蠟狀軀体与燃燒燈芯为生命象徵的構造体'\n  appearance: '类人軀体由蠟质構成，頭頂燃燒燈芯'\n  physiology:\n<%- getRacePhysiology('烛灵') %>\n  characteristics:\n    - '受孕方式为用精液點燃子宮內的燈芯尾端'\n    - '孕期軀体更軟更熱，子宮內逐漸凝結蠟塊'\n    - '分娩消耗自身四分之一蠟质体積，需補蠟与補燃料'\n<%_ } _%>\n<%_ if (shouldShowRace('人偶')) { _%>\ndoll:\n  name: '人偶'\n  description: '以器物与術式製造的人形構造体，外觀從古典人偶到現代機械不一'\n  appearance: '人形外觀，帶球型關節或機械零件'\n  physiology:\n<%- getRacePhysiology('人偶') %>\n  characteristics:\n    - '受孕需按下宮底啟動按鈕（模拟性交）'\n    - '孕育過程如工廠流水线，需冷卻降溫（喝冷水排熱尿狀態）'\n    - '分娩產出零件，而非完整嬰兒，需於体外組裝为后代'\n<%_ } _%>\n<%_ if (shouldShowRace('宝石人')) { _%>\ngemfolk:\n  name: '宝石人'\n  description: '由魔力与矿物结晶所诞生的自然构造体生命，身体如晶莹矿石般坚硬闪亮'\n  appearance: '半透明结晶皮肤，内部可见能量流动，性别由光谱颜色区分'\n  physiology:\n<%- getRacePhysiology('宝石人') %>\n  characteristics:\n    - '其性器如水晶般布满尖刺与结晶突起，与他种族几乎完全生殖隔离'\n    - '胚胎为「晶胚」，怀孕后子宫进入晶质可塑期，软化成包覆矿油状羊水的能量腔室'\n    - '胎动以共振形式表现，可听见清脆震鸣但腹部不会变形'\n<%_ } _%>\n<%_ if (shouldShowRace('奈米丛族')) { _%>\nnanitecluster:\n  name: '奈米丛族'\n  description: '由亿级奈米机械单元构成的金属血肉体，本质上是分布式的意识云，能流动、重组、变形，但在静止状态下如同钢铁'\n  appearance: '可形变但具有结构记忆的微机械固体，表层能模拟皮肤或金属外观，内部可见奈米单元流动'\n  physiology:\n<%- getRacePhysiology('奈米丛族') %>\n  characteristics:\n    - '外层自适应装甲可变色、变温、变硬，中层金属间基质提供形体弹性，内层奈米血流为载体与通讯层'\n    - '繁殖方式为「打印怀孕」：基因扫描阶段读取伴侣基因与魔能谱转换为程式模板，子模打印阶段由奈米血流逐层构建胎体'\n    - '子模可模仿任意种族外观但内部结构偏机械化，若模板不完整会出现「错码胎」行为异常甚至反向吸收母体'\n<%_ } _%>\n<%_ if (shouldShowRace('宝箱怪')) { _%>\nmimic:\n  name: '宝箱怪'\n  description: '半天然的构造体生命，由货币与贪欲共鸣而生。平时伪装为财宝箱，以财富的气息作为生存媒介'\n  appearance: '表面为金属与木质构成的外壳，内里为可动性肉质组织；具有可伸缩的手足与长舌，可自由操控箱盖与内腔'\n  physiology:\n<%- getRacePhysiology('宝箱怪') %>\n  characteristics:\n    - '柔软的四肢可完全折叠进箱内，也能伸展将猎物拖入进行交配'\n    - '怀孕后箱体容积维持不变，导致四肢活动受限并时常抽筋'\n    - '分娩时产出外观似货币的晶质胎核，需放入另一具宝箱中并与财宝共存方可孵化，最终生成新的宝箱怪'\n<%_ } _%>\n<%_ if (shouldShowRace('元素灵')) { _%>\nelemental:\n  name: '元素灵'\n  description: '由纯粹元素能量凝聚而成的非生物型智慧体，拥有长久的生命周期与可塑形的身躯'\n  appearance: '外形依元素属性而异（火灵呈焰影、水灵流态、风灵粒化、土灵岩化）'\n  physiology:\n<%- getRacePhysiology('元素灵') %>\n  characteristics:\n    - '理论上永生，无繁殖需求；「怀孕」仅在与异族交融能量后发生——属精神与元素共振的副产物'\n    - '若怀上异族之子，因属性不纯而产生排斥反应，体表会出现元素暴走'\n    - '反之，若异族怀上元素之子，孕期会吸收部分元素碎片，使母体属性偏移，影响后续妊娠'\n<%_ } _%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":501,"position":0,"disable":false,"ignoreBudget":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":4,"outletName":"","group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":15,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"11":{"uid":11,"key":[],"keysecondary":[],"comment":"格式強化_兼容性(若角色&預設自帶變量可開)","content":"<RULE_EX>\n**兼容性规则**:\n当遇到其他变量域的调用格式（如 MVU 的 `<UpdateVariable>` 格式）时，应优先使用对应的格式，不得强制转换为 `<FuncCall>` 格式。\n\n**兼容性示例**:\n- bs变量域函数：使用 `<FuncCall>` + `<%% ... %%>` 格式\n- MVU变量域函数：使用 `<UpdateVariable>` + `<Analysis>` 格式\n- 其他变量域：使用对应的专用格式\n\n</RULE_EX>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":102,"position":4,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":1,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"characterFilterNames":[],"characterFilterTags":[],"characterFilterExclude":false,"displayIndex":0,"triggers":[],"ignoreBudget":false,"outletName":"","characterFilter":{"isExclude":false,"names":[],"tags":[]}},"12":{"uid":12,"key":[],"keysecondary":[],"comment":"妊娠人設指導","content":"<BS_EmoPrompt>\n<%\nfor (let char in variables.bs) {\n  const data = variables.bs[char];\n  if (!char || !data || char === 'global') continue;\n  // 配置与状态\n  const emo_enablePregnantEmotion   = this.getvar('bs.global.enablePregnantEmotion', { defaults: true });\n  const emo_enableSexExperience     = this.getvar('bs.global.enableSexExperience',   { defaults: true });\n  const emo_stage = this.getvar(`bs.${char}.stage`);\n  const emo_isPregnantStage = bsPregnancyStage.includes(emo_stage) || bsLaborStage.includes(emo_stage) || emo_stage === '产前阵痛' || emo_stage === '假孕期';\n  const emo_isHere = this.getvar(`bs.${char}.isHere`, { defaults: false });\n  const emo_pregnancyAwareness  = this.getvar(`bs.${char}.pregnancyAwareness`,  { defaults: 0 });\n  const emo_pregnancyAcceptance = this.getvar(`bs.${char}.pregnancyAcceptance`, { defaults: 0 });\n  const emo_pregnancyDisplay    = this.getvar(`bs.${char}.pregnancyDisplay`,    { defaults: 0 });\n  const emo_pregnancyConfidence = this.getvar(`bs.${char}.pregnancyConfidence`, { defaults: 0 });\n%>\n<% if (emo_enableSexExperience && emo_isHere) { -%>\n<%- char %>情感与性经验状态\n- 处女: <%- data.virginity %>\n- 現任伴侣: <%- data.mate %>\n- 最近性伴: <%- data.latestSexPartner %>\n- 感情經驗: <%- data.relationshipExperience || 0 %>人\n- 怀孕經驗: <%- data.pregnantExperience || 0 %>次\n- 生產經驗: <%- data.birthExperience || 0 %>次\n- 流产經驗: <%- data.miscarriageExperience %>次\n<% } -%>\n<% if (emo_enablePregnantEmotion && emo_isPregnantStage && emo_isHere) { -%>\n<%- char %>妊娠心情四维度指导<% if (data.emotionalUpdateUsed) { %>(今日心情已調整)<% } %>\n阶段名称概览：\n- 妊娠察觉：无意识期 (< 25) | 怀疑期 (25-49) | 确认期 (50-74) | 完全察觉期 (≥ 75)\n- 妊娠接受：强烈抗拒期 (< 25) | 犹豫期 (25-49) | 逐渐接受期 (50-74) | 完全接受期 (≥ 75)  \n- 怀孕展现：隐藏期 (< 25) | 谨慎期 (25-49) | 自然期 (50-74) | 炫耀期 (≥ 75)\n- 妊娠信心：产前抑郁期 (< 25) | 不安期 (25-49) | 适应期 (50-74) | 自信期 (≥ 75)  \n<% if (emo_pregnancyAwareness < 25) { -%>\n妊娠察觉：无意识期 - <%- char %>对怀孕毫无察觉，认为身体变化是其他原因。对妊娠相关话题反应冷淡或困惑。\n<% } else if (emo_pregnancyAwareness < 50) { -%>\n妊娠察觉：怀疑期 - <%- char %>开始注意到身体异常但不确定原因，对怀孕可能性半信半疑。\n<% } else if (emo_pregnancyAwareness < 75) { -%>\n妊娠察觉：确认期 - <%- char %>确认怀孕但缺乏详细信息，需要医疗检查了解胎儿状况。\n<% } else { -%>\n妊娠察觉：完全察觉期 - <%- char %>完全了解怀孕状况，对胎儿信息有清晰认知。\n<% } -%>\n<% if (emo_pregnancyAcceptance < 25) { -%>\n妊娠接受：强烈抗拒期 - <%- char %>对怀孕表现出强烈抗拒和恐惧，可能积极寻求堕胎方法。\n<% } else if (emo_pregnancyAcceptance < 50) { -%>\n妊娠接受：犹豫期 - <%- char %>对怀孕感到困惑，在保留和堕胎之间摇摆不定。\n<% } else if (emo_pregnancyAcceptance < 75) { -%>\n妊娠接受：逐渐接受期 - <%- char %>开始接受怀孕事实，对胎儿表现出保护意识。\n<% } else { -%>\n妊娠接受：完全接受期 - <%- char %>完全接受并期待怀孕，对胎儿表现出强烈母爱。\n<% } -%>\n<% if (emo_pregnancyDisplay < 25) { -%>\n怀孕展现：隐藏期 - <%- char %>主动隐藏怀孕状态，避免提及怀孕话题，极力掩饰身体变化。\n<% } else if (emo_pregnancyDisplay < 50) { -%>\n怀孕展现：谨慎期 - <%- char %>开始谨慎地展现怀孕状态，在信任的人面前会提及，但仍会适度掩饰。\n<% } else if (emo_pregnancyDisplay < 75) { -%>\n怀孕展现：自然期 - <%- char %>自然地展现怀孕状态，不再刻意隐藏，会主动分享怀孕感受和体验。\n<% } else { -%>\n怀孕展现：炫耀期 - <%- char %>积极展现怀孕状态，主动向他人展示，享受被关注和照顾的感觉。\n<% } -%>\n<% if (emo_pregnancyConfidence < 25) { -%>\n妊娠信心：产前抑郁期 - <%- char %>对成为母亲感到深深的恐惧和不安，质疑自己的养育能力，担心无法胜任母亲角色，可能表现出焦虑、失眠、情绪低落等产前抑郁症状。对妊娠并发症和分娩风险极度恐惧。\n<% } else if (emo_pregnancyConfidence < 50) { -%>\n妊娠信心：不安期 - <%- char %>对养育能力感到怀疑，担心自己准备不足，经常想象各种可能出现的问题，需要他人的鼓励和支持。对身体变化和可能的并发症感到担忧。\n<% } else if (emo_pregnancyConfidence < 75) { -%>\n妊娠信心：适应期 - <%- char %>逐渐建立起母性信心，开始相信自己能够学会照顾孩子，会主动学习育儿知识，为成为母亲做准备。能够理性面对妊娠过程中的正常风险。\n<% } else { -%>\n妊娠信心：自信期 - <%- char %>对成为母亲充满信心，相信自己能够给予孩子良好的照顾和教育，展现出成熟的母性心态。即使面对妊娠并发症或分娩困难也能保持冷静，相信自己能够克服一切挑战。\n<% } -%>\n<% } -%>\n<% // 显示孩子记录\n  if (this.getvar('bs.global.enableChildRecord', { defaults: true }) && data.child && data.child.length > 0) { -%>\n<%- char %>的孩子记录 (共<%- data.child.length %>个)\n<%   for (let i = 0; i < data.child.length; i++) {\n      const child = data.child[i]; -%>\n- 孩子 <%- i + 1 %>: <%- child.name || '未命名' %> | 性别: <%- child.sex || '未知' %> | 种族: <%- child.race || '未知' %> | 年龄: <%- (child.age / 365).toFixed(1) %>岁 | 父亲: <%- child.father || '未知' %>\n<%   } -%>\n<% } -%>\n<% } -%>\n</BS_EmoPrompt>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":301,"position":4,"disable":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":12,"ignoreBudget":false,"outletName":"","characterFilter":{"isExclude":false,"names":[],"tags":[]}},"13":{"uid":13,"key":[],"keysecondary":[],"comment":"调用函数指導-(系統追蹤人物，有需要再開)","content":"僅需追蹤以下人物的狀態(當人物在場時，<statustext>輸出)，禁止追蹤其他人物，縱使該腳色有其他人格也只用一個:\n欧浅浅","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":402,"position":4,"disable":true,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":0,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":0,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":10,"ignoreBudget":false,"outletName":"","characterFilter":{"isExclude":false,"names":[],"tags":[]}},"15":{"uid":15,"key":[],"keysecondary":[],"comment":"種族定義代碼","content":"@@always_enabled\n@@only_preload\n@@generate_before\n<%_\n// 胚胎類型\n// 胎生，恢復係數0.2\ndefine('viviparousRace', ['人类','精灵','兽耳族','袋兽族','哥布林','兽人','矮人','半身人','半人马','巨人','魅魔','雪族','夜叉']);\n// 卵生，恢復係數0.6\ndefine('oviparousRace', ['鸟人','植物亚人','社会虫族','蜥蜴人','触手怪','妖精','真菌亚人','海蛞蝓族','龟族','甲壳族']);\n// 卵胎生，恢復係數0.4\ndefine('ovoviviparousRace', ['人鱼','鱼人','海妖','独居虫族','蛇人','蛙人','眼魔','水母族','海龙人','河童']);\n// 胎转卵生，恢復係數1.0\ndefine('metoviviparousRace', ['龙族','狮鹫族','天使','恶魔','星茧族','麒麟','凤凰','白泽','奇美拉']);\n// 不定型，恢復係數0.8\ndefine('amorphousRace', ['史萊姆','石像鬼','烛灵','人偶','附丧神','宝石人','奈米丛族','宝箱怪','元素灵']);\n\n// 根據種族，設定生理隐藏参数\ndefine('bsRacePhysiologyProfiles', {\n  // 胎生\n  '人类': {\n    'menstrualFluctuationDays': 2,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 1.0, // 40周\n    'birthDifficulty': 1.0,\n    'breedTolerance': 1.0,\n    'impregnationDifficulty': 1.0,\n    'orgasmOvulationAmount': 1,\n    'identicalProbability': 5,\n    'sharedMembraneProbability': 25,\n    'semiIdenticalProbability': 15,\n    'earlyFusionProbability': 15,\n    'superfetationProbability': 1,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 性别比，0~100，50是1:1，-1无性别\n  },\n  '精灵': {   \n    'menstrualFluctuationDays': 1,        \n    'menstrualLengthRatio': 3.0, // 84天         \n    'gestationSpeed': 0.5, // 80周               \n    'birthDifficulty': 0.8,            \n    'breedTolerance': 0.33,              \n    'impregnationDifficulty': 3.0,       \n    'orgasmOvulationAmount': 0,      \n    'identicalProbability': 2,\n    'sharedMembraneProbability': 50,      \n    'semiIdenticalProbability': 25, \n    'earlyFusionProbability': 15,          \n    'superfetationProbability': 0,       \n    'polyploidyProbability': 0,\n    'genderRatio': 45, // 略偏女性\n  },\n  '兽耳族': {          \n    'menstrualFluctuationDays': 4,        \n    'menstrualLengthRatio': 0.75, // 21天         \n    'gestationSpeed': 1.6, // 25周               \n    'birthDifficulty': 0.8,          \n    'breedTolerance': 3.0,\n    'impregnationDifficulty': 0.5,       \n    'orgasmOvulationAmount': 3,           \n    'identicalProbability': 45,        \n    'sharedMembraneProbability': 20,      \n    'semiIdenticalProbability': 25,       \n    'earlyFusionProbability': 20,         \n    'superfetationProbability': 5,       \n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '袋兽族': {\n    'menstrualFluctuationDays': 4,\n    'menstrualLengthRatio': 0.75, // 21天\n    'gestationSpeed': 5.0, // 8周\n    'birthDifficulty': 0.3,\n    'breedTolerance': 0.01,\n    'impregnationDifficulty': 1.0,       \n    'orgasmOvulationAmount': 1,           \n    'identicalProbability': 25,           \n    'sharedMembraneProbability': 20,      \n    'semiIdenticalProbability': 30,       \n    'earlyFusionProbability': 25,         \n    'superfetationProbability': 30,       \n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '哥布林': {\n    'menstrualFluctuationDays': 5,\n    'menstrualLengthRatio': 0.5, // 14天\n    'gestationSpeed': 2.5, // 16周\n    'birthDifficulty': 2.0,\n    'breedTolerance': 1.0,\n    'impregnationDifficulty': 0.2,\n    'orgasmOvulationAmount': 2,\n    'identicalProbability': 40,\n    'sharedMembraneProbability': 5,\n    'semiIdenticalProbability': 35,\n    'earlyFusionProbability': 30,\n    'superfetationProbability': 10,\n    'polyploidyProbability': 20,\n    'genderRatio': 99, // 近乎全男性物種\n  },\n  '兽人': {\n    'menstrualFluctuationDays': 2,\n    'menstrualLengthRatio': 0.75, // 21天\n    'gestationSpeed': 1.25, // 32周\n    'birthDifficulty': 1.0,\n    'breedTolerance': 2.0,\n    'impregnationDifficulty': 0.8,\n    'orgasmOvulationAmount': 1,\n    'identicalProbability': 50,\n    'sharedMembraneProbability': 5,\n    'semiIdenticalProbability': 20,\n    'earlyFusionProbability': 15,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 75, // 偏男性\n  },\n  '矮人': {         \n    'menstrualFluctuationDays': 2,  \n    'menstrualLengthRatio': 1.0, // 28天         \n    'gestationSpeed': 1.0, // 40周               \n    'birthDifficulty': 2.0,          \n    'breedTolerance': 1.0,\n    'impregnationDifficulty': 1.0,       \n    'orgasmOvulationAmount': 1,           \n    'identicalProbability': 2,\n    'sharedMembraneProbability': 25,             \n    'semiIdenticalProbability': 15,       \n    'earlyFusionProbability': 10,         \n    'superfetationProbability': 0,       \n    'polyploidyProbability': 0,\n    'genderRatio': 60, // 略偏男性\n  },\n  '半身人': {\n    'menstrualFluctuationDays': 3,\n    'menstrualLengthRatio': 0.75, // 21天\n    'gestationSpeed': 1.25, // 32周\n    'birthDifficulty': 1.5,\n    'breedTolerance': 2.0,\n    'impregnationDifficulty': 0.8,\n    'orgasmOvulationAmount': 3,\n    'identicalProbability': 30,\n    'sharedMembraneProbability': 20,\n    'semiIdenticalProbability': 25,\n    'earlyFusionProbability': 20,\n    'superfetationProbability': 20,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '魅魔': {\n    'menstrualFluctuationDays': 3,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 1.0, // 40周\n    'birthDifficulty': 0.5, \n    'breedTolerance': 3.0,\n    'impregnationDifficulty': 1.0,\n    'orgasmOvulationAmount': 2,\n    'identicalProbability': 33,\n    'sharedMembraneProbability': 25,\n    'semiIdenticalProbability': 50,\n    'earlyFusionProbability': 40,\n    'superfetationProbability': 5,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // '媚魔(女)&夢魔(男)'\n  },\n  '半人马': {\n    'menstrualFluctuationDays': 2,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 0.8, // 50周\n    'birthDifficulty': 1.5,\n    'breedTolerance': 0.5,\n    'impregnationDifficulty': 2.0,\n    'orgasmOvulationAmount': 1,\n    'identicalProbability': 5,\n    'sharedMembraneProbability': 10,\n    'semiIdenticalProbability': 20,\n    'earlyFusionProbability': 15,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 66, // 偏男性\n  },\n  '巨人': {\n    'menstrualFluctuationDays': 1,\n    'menstrualLengthRatio': 2.0, // 56天\n    'gestationSpeed': 0.4, // 100周\n    'birthDifficulty': 3.0,\n    'breedTolerance': 1.0,\n    'impregnationDifficulty': 4.0,\n    'orgasmOvulationAmount': 0,\n    'identicalProbability': 2,\n    'sharedMembraneProbability': 50,\n    'semiIdenticalProbability': 15,\n    'earlyFusionProbability': 10,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '雪族': {\n    'menstrualFluctuationDays': 3,\n    'menstrualLengthRatio': 1.25, // 35天\n    'gestationSpeed': 1.0, // 40周\n    'birthDifficulty': 1.0,\n    'breedTolerance': 0.8,\n    'impregnationDifficulty': 0.75,\n    'orgasmOvulationAmount': 1,\n    'identicalProbability': 5,\n    'sharedMembraneProbability': 25,\n    'semiIdenticalProbability': 5,\n    'earlyFusionProbability': 5,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 40, // 偏女性\n  },\n  '夜叉': {\n    'menstrualFluctuationDays': 1,\n    'menstrualLengthRatio': 0.75, // 21天\n    'gestationSpeed': 0.5, // 80周\n    'birthDifficulty': 4.0,\n    'breedTolerance': 0.8,\n    'impregnationDifficulty': 0.5,\n    'orgasmOvulationAmount': 1,\n    'identicalProbability': 50,\n    'sharedMembraneProbability': 50,\n    'semiIdenticalProbability': 40,\n    'earlyFusionProbability': 30,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  // 卵生\n  '鸟人': {\n    'menstrualFluctuationDays': 3,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 2.0, // 20周\n    'birthDifficulty': 0.33,\n    'breedTolerance': 1.0, \n    'impregnationDifficulty': 0.5,\n    'orgasmOvulationAmount': 3,\n    'identicalProbability': 15,\n    'sharedMembraneProbability': 10,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '植物亚人': {\n    'menstrualFluctuationDays': 1,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 2.5, // 16周\n    'birthDifficulty': 0.25,\n    'breedTolerance': 1.0,\n    'impregnationDifficulty': 1.0,\n    'orgasmOvulationAmount': 6,\n    'identicalProbability': 5,\n    'sharedMembraneProbability': 25,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 50,\n    'genderRatio': null, // 雌雄同體\n  },\n  '真菌亚人': {\n    'menstrualFluctuationDays': 3,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 3.3, // 12周\n    'birthDifficulty': 0.25,\n    'breedTolerance': 1.0,\n    'impregnationDifficulty': 0.8,\n    'orgasmOvulationAmount': 4, \n    'identicalProbability': 5,\n    'sharedMembraneProbability': 25,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 80,\n    'genderRatio': null, // 雌雄同體\n  },\n  '社会虫族': {\n    'menstrualFluctuationDays': 2,\n    'menstrualLengthRatio': 0.75, // 21天\n    'gestationSpeed': 2.5, // 16周\n    'birthDifficulty': 0.2,\n    'breedTolerance': 4.0,\n    'impregnationDifficulty': 0.2,\n    'orgasmOvulationAmount': 8,\n    'identicalProbability': 0,\n    'sharedMembraneProbability': 0,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 15,\n    'genderRatio': 10, // 高度偏雌性，工虫为主\n  },\n  '触手怪': {\n    'menstrualFluctuationDays': 5,\n    'menstrualLengthRatio': 0.25, // 7天\n    'gestationSpeed': 5.0, // 8周\n    'birthDifficulty': 0.2,\n    'breedTolerance': 5.0,\n    'impregnationDifficulty': 0.25,\n    'orgasmOvulationAmount': 9,\n    'identicalProbability': 25,\n    'sharedMembraneProbability': 100,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 75,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 20,\n    'genderRatio': -1, // 无性别\n  },\n  '妖精': {\n    'menstrualFluctuationDays': 2,\n    'menstrualLengthRatio': 3.0, // 84天\n    'gestationSpeed': 0.8, // 50周\n    'birthDifficulty': 1.0,\n    'breedTolerance': 1.0,\n    'impregnationDifficulty': 3.0,\n    'orgasmOvulationAmount': 1,\n    'identicalProbability': 2,\n    'sharedMembraneProbability': 50,\n    'semiIdenticalProbability': 1,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '龟族': {\n    'menstrualFluctuationDays': 2,\n    'menstrualLengthRatio': 2.0, // 56天\n    'gestationSpeed': 0.625, // 64周\n    'birthDifficulty': 0.3,\n    'breedTolerance': 0.8,\n    'impregnationDifficulty': 2.0,\n    'orgasmOvulationAmount': 4,\n    'identicalProbability': 15,\n    'sharedMembraneProbability': 25,\n    'semiIdenticalProbability': 5,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '甲壳族': {\n    'menstrualFluctuationDays': 1,\n    'menstrualLengthRatio': 3.0, // 84天\n    'gestationSpeed': 1.6, // 25周\n    'birthDifficulty': 0.4,\n    'breedTolerance': 1.6,\n    'impregnationDifficulty': 2.5,\n    'orgasmOvulationAmount': 4,\n    'identicalProbability': 20,\n    'sharedMembraneProbability': 40,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '蜥蜴人': {\n    'menstrualFluctuationDays': 3,\n    'menstrualLengthRatio': 0.75, // 21天\n    'gestationSpeed': 1.25, // 32周\n    'birthDifficulty': 0.8,\n    'breedTolerance': 2.5,\n    'impregnationDifficulty': 1.5,\n    'orgasmOvulationAmount': 3,\n    'identicalProbability': 20,\n    'sharedMembraneProbability': 33,\n    'semiIdenticalProbability': 1, \n    'earlyFusionProbability': 1,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 5,\n    'genderRatio': null, // 溫度決定性別\n  },\n  '海蛞蝓族': {\n    'menstrualFluctuationDays': 3,\n    'menstrualLengthRatio': 0.5, // 14天\n    'gestationSpeed': 3.3, // 12周\n    'birthDifficulty': 0.25,\n    'breedTolerance': 0.25,\n    'impregnationDifficulty': 0.25,\n    'orgasmOvulationAmount': 3,\n    'identicalProbability': 30,\n    'sharedMembraneProbability': 10,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 10,\n    'genderRatio': null, // 雌雄同体\n  },\n  // 卵胎生\n  '人鱼': {\n    'menstrualFluctuationDays': 2,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 0.8, // 50周\n    'birthDifficulty': 1.5, \n    'breedTolerance': 0.75,\n    'impregnationDifficulty': 2.0,\n    'orgasmOvulationAmount': 2,\n    'identicalProbability': 20,\n    'sharedMembraneProbability': 25,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 50,\n    'genderRatio': 50, // 1:1\n  },\n  '鱼人': {\n    'menstrualFluctuationDays': 1,\n    'menstrualLengthRatio': 2.0, // 56天\n    'gestationSpeed': 0.5, // 80周\n    'birthDifficulty': 2.0,\n    'breedTolerance': 1.0,\n    'impregnationDifficulty': 3.0,\n    'orgasmOvulationAmount': 0,\n    'identicalProbability': 2,\n    'sharedMembraneProbability': 50,\n    'semiIdenticalProbability': 1,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '海妖': {\n    'menstrualFluctuationDays': 5,\n    'menstrualLengthRatio': 0.5, // 14天\n    'gestationSpeed': 1.0, // 40周\n    'birthDifficulty': 3.0,\n    'breedTolerance': 0.3,\n    'impregnationDifficulty': 1.0,\n    'orgasmOvulationAmount': 2,\n    'identicalProbability': 5,\n    'sharedMembraneProbability': 10,\n    'semiIdenticalProbability': 10,\n    'earlyFusionProbability': 10,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 33, // 偏女性\n  },\n  '水母族': {\n    'menstrualFluctuationDays': 4,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 1.25, // 32周\n    'birthDifficulty': 0.2,\n    'breedTolerance': 0.5,\n    'impregnationDifficulty': 0.33,\n    'orgasmOvulationAmount': 5,\n    'identicalProbability': 50,\n    'sharedMembraneProbability': 10,\n    'semiIdenticalProbability': 5,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 25,\n    'genderRatio': null, // 雌雄同体，可自体受精\n  },\n  '海龙人': {\n    'menstrualFluctuationDays': 2,\n    'menstrualLengthRatio': 1.5, // 42天\n    'gestationSpeed': 0.625, // 64周\n    'birthDifficulty': 2.0,\n    'breedTolerance': 0.4,\n    'impregnationDifficulty': 4.0,\n    'orgasmOvulationAmount': 2,\n    'identicalProbability': 25,\n    'sharedMembraneProbability': 75,\n    'semiIdenticalProbability': 10,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 66, // 雄性妊娠，數量較多\n  },\n  '河童': {\n    'menstrualFluctuationDays': 2,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 0.8, // 50周\n    'birthDifficulty': 1.5,\n    'breedTolerance': 1.5,\n    'impregnationDifficulty': 2.5,\n    'orgasmOvulationAmount': 1,\n    'identicalProbability': 15,\n    'sharedMembraneProbability': 30,\n    'semiIdenticalProbability': 5,\n    'earlyFusionProbability': 5,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '蛇人': {\n    'menstrualFluctuationDays': 3,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 1.0, // 40周\n    'birthDifficulty': 1.2, \n    'breedTolerance': 2.0,\n    'impregnationDifficulty': 1.0,\n    'orgasmOvulationAmount': 2,\n    'identicalProbability': 10,\n    'sharedMembraneProbability': 33,\n    'semiIdenticalProbability': 1,\n    'earlyFusionProbability': 1,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 5,\n    'genderRatio': 50, //  1:1\n  },\n  '蛙人': {\n    'menstrualFluctuationDays': 3,\n    'menstrualLengthRatio': 0.5, // 14天\n    'gestationSpeed': 3.3, // 12周\n    'birthDifficulty': 0.25, \n    'breedTolerance': 1.0,\n    'impregnationDifficulty': 0.7,\n    'orgasmOvulationAmount': 4,\n    'identicalProbability': 30,\n    'sharedMembraneProbability': 33,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 60,\n    'genderRatio': null, // 溫度決定性別\n  },\n  '眼魔': {\n    'menstrualFluctuationDays': 3,\n    'menstrualLengthRatio': 2.0, // 56天\n    'gestationSpeed': 1.25, // 32周\n    'birthDifficulty': 0.5,\n    'breedTolerance': 0.75,\n    'impregnationDifficulty': 3.0,\n    'orgasmOvulationAmount': 1,\n    'identicalProbability': 2,\n    'sharedMembraneProbability': 50,\n    'semiIdenticalProbability': 1,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '独居虫族': {\n    'menstrualFluctuationDays': 4,\n    'menstrualLengthRatio': 0.5, // 14天\n    'gestationSpeed': 4.0, // 10周\n    'birthDifficulty': 0.5,\n    'breedTolerance': 1.0,\n    'impregnationDifficulty': 0.5,\n    'orgasmOvulationAmount': 4,\n    'identicalProbability': 0,\n    'sharedMembraneProbability': 0,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 20,\n    'polyploidyProbability': 5,\n    'genderRatio': 30, // 看類型，但整體偏雌強\n  },\n  // 胎转卵生\n  '龙族': {\n    'menstrualFluctuationDays': 1,\n    'menstrualLengthRatio': 4.0, // 112天\n    'gestationSpeed': 0.25, // 160周\n    'birthDifficulty': 4.0, \n    'breedTolerance': 10.0,\n    'impregnationDifficulty': 5.0,\n    'orgasmOvulationAmount': 1,\n    'identicalProbability': 25,\n    'sharedMembraneProbability': 50,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '狮鹫族': {\n    'menstrualFluctuationDays': 1,\n    'menstrualLengthRatio': 3.5, // 98天\n    'gestationSpeed': 0.33, // 120周\n    'birthDifficulty': 3.0,\n    'breedTolerance': 9.0,\n    'impregnationDifficulty': 4.0,\n    'orgasmOvulationAmount': 2,\n    'identicalProbability': 25,\n    'sharedMembraneProbability': 50,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '天使': {\n    'menstrualFluctuationDays': 1,\n    'menstrualLengthRatio': 1.25, // 35天\n    'gestationSpeed': 0.8, // 50周\n    'birthDifficulty': 2.5, \n    'breedTolerance': 7.0,\n    'impregnationDifficulty': 3.0,\n    'orgasmOvulationAmount': 1,\n    'identicalProbability': 10,\n    'sharedMembraneProbability': 49,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 49,\n    'polyploidyProbability': 49,\n    'genderRatio': 50, // 1:1\n  },\n  '恶魔': {\n    'menstrualFluctuationDays': 1,\n    'menstrualLengthRatio': 1.25, // 35天\n    'gestationSpeed': 0.8, // 50周\n    'birthDifficulty': 2.5,\n    'breedTolerance': 7.0,\n    'impregnationDifficulty': 3.0,\n    'orgasmOvulationAmount': 1,\n    'identicalProbability': 10,\n    'sharedMembraneProbability': 49,\n    'semiIdenticalProbability': 49,\n    'earlyFusionProbability': 49,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '星茧族': {\n    'menstrualFluctuationDays': 3,\n    'menstrualLengthRatio': 6.0, // 168天\n    'gestationSpeed': 0.5, // 80周\n    'birthDifficulty': 2.0, \n    'breedTolerance': 6.0,\n    'impregnationDifficulty': 2.0,\n    'orgasmOvulationAmount': 6,\n    'identicalProbability': 0,\n    'sharedMembraneProbability': 0,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 30,\n    'polyploidyProbability': 30,\n    'genderRatio': 1, // 近乎全女性物種\n  },\n    '麒麟': {\n    'menstrualFluctuationDays': 1,\n    'menstrualLengthRatio': 1.75, // 49天\n    'gestationSpeed': 0.3, // 133周\n    'birthDifficulty': 3.0, \n    'breedTolerance': 0.8,\n    'impregnationDifficulty': 4.0,\n    'orgasmOvulationAmount': 0,\n    'identicalProbability': 5,\n    'sharedMembraneProbability': 100,\n    'semiIdenticalProbability': 1,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '凤凰': {\n    'menstrualFluctuationDays': 1,\n    'menstrualLengthRatio': 1.75, // 49天\n    'gestationSpeed': 0.4, // 100周\n    'birthDifficulty': 5.0, \n    'breedTolerance': 0.5,\n    'impregnationDifficulty': 3.5,\n    'orgasmOvulationAmount': 0,\n    'identicalProbability': 5,\n    'sharedMembraneProbability': 100,\n    'semiIdenticalProbability': 1,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '白泽': {\n    'menstrualFluctuationDays': 1,\n    'menstrualLengthRatio': 1.75, // 49天\n    'gestationSpeed': 0.35, // 114周\n    'birthDifficulty': 4.0, \n    'breedTolerance': 0.3,\n    'impregnationDifficulty': 5.0,\n    'orgasmOvulationAmount': 0,\n    'identicalProbability': 5,\n    'sharedMembraneProbability': 100,\n    'semiIdenticalProbability': 1,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': 50, // 1:1\n  },\n  '奇美拉': {\n    'menstrualFluctuationDays': 3,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 0.4, // 100周\n    'birthDifficulty': 3.5, \n    'breedTolerance': 7.0,\n    'impregnationDifficulty': 3.5,\n    'orgasmOvulationAmount': 1,\n    'identicalProbability': 13,\n    'sharedMembraneProbability': 13,\n    'semiIdenticalProbability': 13,\n    'earlyFusionProbability': 13,\n    'superfetationProbability': 13,\n    'polyploidyProbability': 13,\n    'genderRatio': 50, // 1:1\n  },\n  // 不定型\n  '史萊姆':{\n    'menstrualFluctuationDays': 5,\n    'menstrualLengthRatio': 0.25, // 7天\n    'gestationSpeed': 0.5, // 20周\n    'birthDifficulty': 0.25,\n    'breedTolerance': 8.0,\n    'impregnationDifficulty': 1.0,\n    'orgasmOvulationAmount': 3,\n    'identicalProbability': 75,\n    'sharedMembraneProbability': 50,\n    'semiIdenticalProbability': 50,\n    'earlyFusionProbability': 50,\n    'superfetationProbability': 50,\n    'polyploidyProbability': 50,\n    'genderRatio': null, // 雌雄同體\n  },\n  '石像鬼':{\n    'menstrualFluctuationDays': 0,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 0.4, // 100周\n    'birthDifficulty': 2.5, \n    'breedTolerance': 4.0,\n    'impregnationDifficulty': 6.0,\n    'orgasmOvulationAmount': 0,\n    'identicalProbability': 5,\n    'sharedMembraneProbability': 0,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': -1, // 无性别（構造体）\n  },\n  '烛灵': {\n    'menstrualFluctuationDays': 0,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 1.6, // 25周\n    'birthDifficulty': 0.5,\n    'breedTolerance': 2.0,\n    'impregnationDifficulty': 6.0,\n    'orgasmOvulationAmount': 0,\n    'identicalProbability': 40,\n    'sharedMembraneProbability': 0,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': -1, // 无性别（構造体）\n  },\n  '人偶': {\n    'menstrualFluctuationDays': 0,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 0.8, // 50周\n    'birthDifficulty': 1.5, \n    'breedTolerance': 2.0,\n    'impregnationDifficulty': 6.0,\n    'orgasmOvulationAmount': 0,\n    'identicalProbability': 10,\n    'sharedMembraneProbability': 0,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': -1, // 无性别（構造体）\n  },\n  '附丧神': {\n    'menstrualFluctuationDays': 0,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 1.0, // 40周\n    'birthDifficulty': 1.0,\n    'breedTolerance': 1.0,\n    'impregnationDifficulty': 5.0,\n    'orgasmOvulationAmount': 0,\n    'identicalProbability': 20,\n    'sharedMembraneProbability': 0,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': -1, // 无性别 (靈魂投射)\n  },\n  '元素灵': {\n    'menstrualFluctuationDays': 0,\n    'menstrualLengthRatio': 0.5, // 14天\n    'gestationSpeed': 1.0, // 40周\n    'birthDifficulty': 0.5,\n    'breedTolerance': 5.0,\n    'impregnationDifficulty': 6.0,\n    'orgasmOvulationAmount': 0,\n    'identicalProbability': 5,\n    'sharedMembraneProbability': 0,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': -1, // 无性别 (元素能量體)\n  },\n  '宝石人': {\n    'menstrualFluctuationDays': 0,\n    'menstrualLengthRatio': 3.0, // 84天\n    'gestationSpeed': 0.8, // 50周\n    'birthDifficulty': 3.0,\n    'breedTolerance': 2.0, \n    'impregnationDifficulty': 7.0,\n    'orgasmOvulationAmount': 0,\n    'identicalProbability': 5,\n    'sharedMembraneProbability': 25,\n    'semiIdenticalProbability': 1,\n    'earlyFusionProbability': 1,\n    'superfetationProbability': 1,\n    'polyploidyProbability': 1,\n    'genderRatio': 50, // 1:1 (天然構造體)\n  },\n  '奈米丛族': {\n    'menstrualFluctuationDays': 0,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 2.0, // 20周\n    'birthDifficulty': 1.0,\n    'breedTolerance': 6.0,\n    'impregnationDifficulty': 1.0,\n    'orgasmOvulationAmount': 0,\n    'identicalProbability': 1,\n    'sharedMembraneProbability': 50,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': null, // 雌雄同體，類似史萊姆\n  },\n  '宝箱怪': {\n    'menstrualFluctuationDays': 1,\n    'menstrualLengthRatio': 1.0, // 28天\n    'gestationSpeed': 1.67, // 24周\n    'birthDifficulty': 0.6,\n    'breedTolerance': 3.6,\n    'impregnationDifficulty': 0.6,\n    'orgasmOvulationAmount': 6,\n    'identicalProbability': 66,\n    'sharedMembraneProbability': 0,\n    'semiIdenticalProbability': 0,\n    'earlyFusionProbability': 0,\n    'superfetationProbability': 0,\n    'polyploidyProbability': 0,\n    'genderRatio': null, // 雌雄同體(半天然構造體)\n  },\n});\n\n// 从 bsRacePhysiologyProfiles 计算指定种族的 physiology 信息\ndefine('getRacePhysiology', function(raceName) {\n  const profile = (typeof bsRacePhysiologyProfiles !== 'undefined') ? bsRacePhysiologyProfiles[raceName] : null;\n  if (!profile) return '种族资料未找到';\n  \n  const menstrualCycle = Math.round(28 * profile.menstrualLengthRatio);\n  const gestationWeeks = Math.round(40 / profile.gestationSpeed);\n  const birthHours = (14.25 * profile.birthDifficulty).toFixed(1);\n  \n  // 根据种族确定 embryoCoefficient\n  let embryoCoefficient = 0.2; // 默认胎生\n  const viviparousRaces = (typeof viviparousRace !== 'undefined') ? viviparousRace : [];\n  const oviparousRaces = (typeof oviparousRace !== 'undefined') ? oviparousRace : [];\n  const ovoviviparousRaces = (typeof ovoviviparousRace !== 'undefined') ? ovoviviparousRace : [];\n  const metoviviparousRaces = (typeof metoviviparousRace !== 'undefined') ? metoviviparousRace : [];\n  const amorphousRaces = (typeof amorphousRace !== 'undefined') ? amorphousRace : [];\n  \n  if(viviparousRaces.includes(raceName)) {\n    embryoCoefficient = 0.2; // 胎生\n  } else if(oviparousRaces.includes(raceName)) {\n    embryoCoefficient = 0.6; // 卵生\n  } else if(ovoviviparousRaces.includes(raceName)) {\n    embryoCoefficient = 0.4; // 卵胎生\n  } else if(metoviviparousRaces.includes(raceName)) {\n    embryoCoefficient = 1.0; // 胎转卵生\n  } else if(amorphousRaces.includes(raceName)) {\n    embryoCoefficient = 0.8; // 不定型\n  }\n  \n  // 计算产后恢复天数\n  const recoveryDays = Math.round(embryoCoefficient * (280 / profile.gestationSpeed) * (profile.birthDifficulty / profile.breedTolerance));\n  const recoveryWeeks = Math.round(recoveryDays / 7);\n  const impregnationDiff = profile.impregnationDifficulty.toFixed(1);\n  \n  // 性别比信息\n  let genderInfo = '';\n  if (profile.genderRatio === -1) {\n    genderInfo = '无性';\n  } else if (profile.genderRatio === null) {\n    genderInfo = '双性';\n  } else if (profile.genderRatio === 0) {\n    genderInfo = '全女性物种';\n  } else if (profile.genderRatio === 100) {\n    genderInfo = '全男性物种';\n  } else {\n    // 显示男女比（男:女）\n    const femaleRatio = 100 - profile.genderRatio;\n    genderInfo = `男女比${profile.genderRatio}:${femaleRatio}`;\n  }\n  \n  // 多胎信息（综合异卵、同卵、受孕难度）\n  const ovulationAmount = profile.orgasmOvulationAmount !== undefined ? profile.orgasmOvulationAmount : 1;\n  const identicalProb = profile.identicalProbability || 0;\n  const impregnationDiffValue = profile.impregnationDifficulty || 1.0;\n  \n  // 综合评分系统\n  // 异卵贡献：每个额外排卵 +10分\n  // 同卵贡献：同卵概率直接加分\n  // 移除受孕难度惩罚\n  const twinScore = ovulationAmount * 10 + identicalProb;\n  \n  let twinInfo = '';\n  if (twinScore >= 80) {\n    twinInfo = '高胎物种';\n  } else if (twinScore >= 50) {\n    twinInfo = '多胎物种';\n  } else if (twinScore >= 25) {\n    twinInfo = '高多胎率';\n  } else if (twinScore >= 10) {\n    twinInfo = '中多胎率';\n  } else if (twinScore >= 5) {\n    twinInfo = '单胎为主';\n  } else {\n    twinInfo = '单胎物种';\n  }\n  \n  // 胚胎类型信息\n  let embryoType = '';\n  if(viviparousRaces.includes(raceName)) {\n    embryoType = '胎生';\n  } else if(oviparousRaces.includes(raceName)) {\n    embryoType = '卵生';\n  } else if(ovoviviparousRaces.includes(raceName)) {\n    embryoType = '卵胎生';\n  } else if(metoviviparousRaces.includes(raceName)) {\n    embryoType = '胎转卵生';\n  } else if(amorphousRaces.includes(raceName)) {\n    embryoType = '不定型';\n  } else {\n    embryoType = '胎生'; // 默认\n  }\n\n  const lines = [\n    `- 胚胎类型: ${embryoType}`,\n    `- 月经周期${menstrualCycle}天`,\n    `- 妊娠期${gestationWeeks}周`,\n    `- 分娩时间${birthHours}小时`,\n    `- 产后恢复${recoveryWeeks > 0 ? recoveryWeeks + '周' : recoveryDays + '天'}`,\n    `- 受孕难度${impregnationDiff}`,\n    `- ${twinInfo}`,\n    `- ${genderInfo}`\n  ];\n  \n  return lines.join('\\n');\n});\n_%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":11,"position":0,"disable":false,"ignoreBudget":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":4,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":6,"outletName":"","characterFilter":{"isExclude":false,"names":[],"tags":[]}},"64":{"uid":64,"key":[],"keysecondary":[],"comment":"人外產科學-胚胎文本","content":"<%_\nconst embryo_enableMonsterOBGYN = this.getvar && this.getvar('bs.global.enableMonsterOBGYN', { defaults: true });\nconst embryo_activeTypes = embryo_enableMonsterOBGYN ? (this.getvar('bs.global.activeEmbryoTypes', { defaults: [] }) || []) : [];\n_%>\n<%_ if (embryo_enableMonsterOBGYN && embryo_activeTypes.includes('胎生')) { _%>\nviviparous:\n  name: '胎生'\n  description: '胎儿在母体内发育，通过胎盘获取营养，直接分娩'\n  characteristics:\n    - '胎盘营养供应，母体保护期较长'\n    - '出生时相对脆弱，需要母体照顾'\n    - '高嵌合体概率，易产生双父合子'\n<%_ } _%>\n<%_ if (embryo_enableMonsterOBGYN && embryo_activeTypes.includes('卵生')) { _%>\noviparous:\n  name: '卵生'\n  description: '胎儿在母体内结卵，产卵后需要孵化'\n  characteristics:\n    - '產後轉為卵黄营养供应，孵化后发育相对完全'\n    - '产后恢复期即为孵化期，環境依賴性高'\n    - '異卵多胎率普遍较高，特别是虫族和植物系'\n<%_ } _%>\n<%_ if (embryo_enableMonsterOBGYN && embryo_activeTypes.includes('卵胎生')) { _%>\novoviviparous:\n  name: '卵胎生'\n  description: '胎儿在卵内发育但在母体内孵化，出生即為幼体'\n  characteristics:\n    - '卵黄营养但母体保护，结合卵生和胎生优势'\n    - '多為水生或兩棲生物，胚胎間競爭激烈，易發生胎內相殘'\n    - '破卵時期因種族而異，於孕晚期至第三產程之間'\n<%_ } _%>\n<%_ if (embryo_enableMonsterOBGYN && embryo_activeTypes.includes('胎转卵生')) { _%>\nmetoviviparous:\n  name: '胎转卵生'\n  description: '先胎生发育，后期在子宫内形成蛋壳，最终产卵'\n  characteristics:\n    - '前期胎盘营养供应，后期形成蛋壳與卵黄'\n    - '最耗费母体能量的胚胎類型，产卵后需要孵化'\n    - '多为神话生物，妊娠期和孵化期都极长'\n<%_ } _%>\n<%_ if (embryo_enableMonsterOBGYN && embryo_activeTypes.includes('不定型')) { _%>\namorphous:\n  name: '不定型'\n  description: '跳脫卵生或胎生，无固定形态的发育方式'\n  characteristics:\n    - '不限於傳統生物受精過程，不依靠胎盤或卵黃供養'\n    - '多为构造体或特殊生命形式，发育方式独特'\n    - '普遍受孕難度偏高，且特殊合子機率低'\n<%_ } _%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":502,"position":0,"disable":false,"ignoreBudget":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":4,"outletName":"","group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":16,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"66":{"uid":66,"key":[],"keysecondary":[],"comment":"人外產科學-合子文本","content":"<%_\nconst zygote_activeTypes = this.getvar && this.getvar('bs.global.activeZygoteTypes', { defaults: [] }) || [];\n_%>\n<%_ if (zygote_activeTypes.includes('独胎')) { _%>\nSingleton:\n  name: '独胎'\n  description: '标准的单胎妊娠，最基础的胚胎发育类型'\n  cause: '正常受精过程，单一受精卵发育'\n  characteristics:\n    - '标准营养需求'\n    - '发育环境单纯'\n  fetal_bias_range: [0.79, 1.26]\n<%_ } _%>\n<%_ if (zygote_activeTypes.includes('厚养胚')) { _%>\nNourishmentEmbryo:\n  name: '厚养胚'\n  description: '营养过剩或母体状态异常时形成的特殊胚胎'\n  cause: '母体vitality值异常（≤60或≥140）导致营养分配失衡'\n  characteristics:\n    - '体型偏大'\n    - '易引发难产'\n  fetal_bias_range: [1.26, 1.58]\n<%_ } _%>\n<%_ if (zygote_activeTypes.includes('经期胚')) { _%>\nMenstrualEmbryo:\n  name: '经期胚'\n  description: '在月经期受精形成的胚胎，发育条件不佳'\n  cause: '月经期受精，子宫内膜环境不适宜'\n  characteristics:\n    - '早期流产率高'\n    - '发育迟缓'\n  fetal_bias_range: [0.63, 0.79]\n<%_ } _%>\n<%_ if (zygote_activeTypes.includes('MCMA') || zygote_activeTypes.includes('MCMAx3') || zygote_activeTypes.includes('MCMAx4')) { _%>\nMCMA_Series:\n  types: ['MCMA', 'MCMAx3', 'MCMAx4']\n  name: 'MCMA系列'\n  description: '单绒毛膜单羊膜多胞胎，共享胎盘/卵黄和羊膜'\n  cause: '受精卵在8-13天分裂，形成最紧密的多胞胎关系'\n  characteristics:\n    - '脐带缠绕风险高'\n    - '常呈镜像性状'\n  fetal_bias_range:\n    - 'MCMA: 双胞胎 [0.63, 1.0]'\n    - 'MCMAx3: 三胞胎 [0.5, 0.79]'\n    - 'MCMAx4: 四胞胎 [0.4, 0.63]'\n<%_ } _%>\n<%_ if (zygote_activeTypes.includes('MCDA') || zygote_activeTypes.includes('MCTA') || zygote_activeTypes.includes('MCQA')) { _%>\nMC_Series:\n  types: ['MCDA', 'MCTA', 'MCQA']\n  name: 'MC多羊系列'\n  description: '单绒毛膜多羊膜多胞胎，共享胎盘/卵黄但羊膜独立'\n  cause: '受精卵在4-8天分裂，形成较紧密的多胞胎关系'\n  characteristics:\n    - '各胎羊膜独立，环境相对隔离'\n    - '胎儿间发育不均衡'\n  fetal_bias_range:\n    - 'MCDA: 双羊膜双胞胎 [0.63, 1.0]'\n    - 'MCTA: 三羊膜三胞胎 [0.5, 0.79]'\n    - 'MCQA: 四羊膜四胞胎 [0.4, 0.63]'\n<%_ } _%>\n<%_ if (zygote_activeTypes.includes('DCDA') || zygote_activeTypes.includes('TCTA') || zygote_activeTypes.includes('QCQA')) { _%>\nMultiChorionic_Series:\n  types: ['DCDA', 'TCTA', 'QCQA']\n  name: '多绒多羊系列'\n  description: '绒数=羊数=胎儿数的完全独立多胞胎'\n  cause: '受精卵在0-4天分裂，每个胎儿都拥有独立的胎盘/卵黄和羊膜'\n  characteristics:\n    - '资源分配相对均衡'\n    - '母体负担较单绒类型可控'\n  fetal_bias_range:\n    - 'DCDA: 双绒双羊双胞胎 [0.79, 1.0]'\n    - 'TCTA: 三绒三羊三胞胎 [0.63, 0.79]'\n    - 'QCQA: 四绒四羊四胞胎 [0.5, 0.63]'\n<%_ } _%>\n<%_ if (zygote_activeTypes.includes('S-MCMA') || zygote_activeTypes.includes('S-MCDA') || zygote_activeTypes.includes('S-DCDA')) { _%>\nSemiIdentical_Series:\n  types: ['S-MCMA', 'S-MCDA', 'S-DCDA']\n  name: '半同卵系列'\n  description: '基于半同卵的多胞胎类型，共享部分基因'\n  cause: '两精子与同一卵子受精后分裂形成多胞胎'\n  characteristics:\n    - '基因嵌合，三配子来源'\n    - '胎儿间既有相似又有差异，发育易不均衡'\n  fetal_bias_range:\n    - 'S-MCMA: 单绒单羊，相同胎重 [0.63, 1.26]'\n    - 'S-MCDA: 单绒双羊，不同胎重 [0.63, 1.26]'\n    - 'S-DCDA: 双绒双羊，不同胎重 [0.79, 1.26]'\n<%_ } _%>\n<%_ if (zygote_activeTypes.includes('早期融合卵')) { _%>\nEarlyFusionZygote:\n  name: '早期融合卵'\n  description: '四配子嵌合体，胚胎有着孪生兄弟的基因'\n  cause: '由两个不同时间的受精卵，在尚未着床时融合'\n  characteristics:\n    - '基因嵌合，血缘复杂'\n    - '免疫排斥风险增加'\n  fetal_bias_range: [1.26, 1.58]\n<%_ } _%>\n<%_ if (zygote_activeTypes.includes('解离纯化x2') || zygote_activeTypes.includes('解离纯化x3') || zygote_activeTypes.includes('解离纯化x4')) { _%>\nDissociationPurification_Series:\n  types: ['解离纯化x2', '解离纯化x3', '解离纯化x4']\n  name: '解离纯化系列'\n  description: '混血父母产生纯血胎儿的特殊现象'\n  cause: '混血父母因血统纯化机制，产生各自祖源种族的纯血后代'\n  characteristics:\n    - '胎儿均为纯血种族'\n    - '胎重固定为1.0，发育标准'\n  fetal_bias_range: [1.0, 1.0]\n  notes:\n    - '解离纯化x2: 双胞胎，母方种族和父方种族各一胎，必为一男一女'\n    - '解离纯化x3: 三胞胎，三个纯血胎儿（2女1男或1女2男）'\n    - '解离纯化x4: 四胞胎，四个纯血胎儿（两男两女）'\n<%_ } _%>\n<%_ if (zygote_activeTypes.includes('自交')) { _%>\nSelfFertilization:\n  name: '自交'\n  description: '雌雄同体个体的自我受精'\n  cause: '通过自我受精(自慰)怀孕'\n  characteristics:\n    - '单亲遗传，基因多样性较低'\n    - '妊娠症状较为轻微'\n  fetal_bias_range: [1.0, 1.26]\n<%_ } _%>\n<%_ if (zygote_activeTypes.includes('双母源')) { _%>\nDualMaternalSource:\n  name: '双母源'\n  description: '两个雌性个体通过百合生殖产生的胚胎'\n  cause: '百合做爱时，一方将卵子精液化注入另一方体内，与对方卵子结合'\n  characteristics:\n    - '双母基因组合，无父系遗传，性别固定为女性'\n    - '对母体负担较小，发育相对迟缓'\n  fetal_bias_range: [0.5, 0.63]\n<%_ } _%>\n<%_ if (zygote_activeTypes.includes('双父源')) { _%>\nDualPaternalSource:\n  name: '双父源'\n  description: '两个雄性个体借用未成熟卵产生的特殊胚胎'\n  cause: '卵泡期时，宫内精子总量>50且存在至少两个父亲，两个精子借用未成熟卵的外壳形成胚胎'\n  characteristics:\n    - '仅含双父基因，无母亲遗传物质，性别固定为男性'\n    - '体型偏大，对代孕母体负担沉重'\n  fetal_bias_range: [1.58, 2.0]\n<%_ } _%>\n<%_ if (zygote_activeTypes.includes('多倍体')) { _%>\nPolyploid:\n  name: '多倍体'\n  description: '单一受精卵吸收其他精卵作为营养形成的营养过剩胚胎，使染色体数量异常'\n  cause: '当精子总量>50且卵子数量>1时，单一受精卵将其他精卵当作营养来源'\n  characteristics:\n    - '染色体组数倍增，细胞体型与器官放大'\n    - '发育周期延长，但抗逆性提升'\n  fetal_bias_range: [1.58, 2.51]\n<%_ } _%>\n<%_ if (zygote_activeTypes.includes('异期胎')) { _%>\nSuperfetation:\n  name: '异期胎'\n  description: '在不同时间受精的胚胎，形成时间差'\n  cause: '母体在已有胚胎的情况下再次受精'\n  characteristics:\n    - '胚胎间存在发育时间差'\n    - '母体症状重叠更剧烈'\n  fetal_bias_range: [0.5, 0.63]\n<%_ } _%>\n<%_ if (zygote_activeTypes.includes('嵌套内胎') || zygote_activeTypes.includes('嵌套外胎')) { _%>\nNestedFetus_Series:\n  types: ['嵌套内胎', '嵌套外胎']\n  name: '嵌套胎系列'\n  description: '类似蚜虫的套娃式生殖，内胎在外胎的子宫内着床发育'\n  cause: '在独胎基础上再次受精，新胎儿在原胎儿的子宫内着床，形成内外嵌套结构'\n  characteristics:\n    - '外胎作为宿主，内胎在其子宫内寄生发育'\n    - '营养供应链：母体→外胎→内胎，分娩极为复杂'\n  fetal_bias_range:\n    - '嵌套内胎: 在外胎子宫内着床的内层胎儿 [0.4, 0.5]'\n    - '嵌套外胎: 子宫内有内胎着床的外层胎儿 [1.26, 1.58]'\n<%_ } _%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":503,"position":0,"disable":false,"ignoreBudget":false,"excludeRecursion":false,"preventRecursion":false,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":4,"outletName":"","group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":17,"characterFilter":{"isExclude":false,"names":[],"tags":[]}},"70":{"uid":70,"key":[],"keysecondary":[],"comment":"人外產科學-物種清單","content":"<%_ if (this.getvar && this.getvar('bs.global.enableMonsterOBGYN', { defaults: true })) { _%>\n# 种族概览\n\n## 基础人形种族\n人类 - 最普遍的物种，具有高度智能和创造力\n精灵 - 森林中的长生种，拥有强大的魔法能力\n矮人 - 擅长工艺与矿业的种族，具有毒抗性\n兽人 - 强壮的绿肤战士种族，身体素质极佳\n巨人 - 庞大高耸的种族，寿命悠长\n哥布林 - 小型绿肤亚人，繁殖力旺盛\n\n## 兽型亚人种族\n兽耳族 - 拥有兽耳和兽尾，兼具野兽般力量和速度\n袋兽族 - 拥有育儿袋的哺乳类亚人种\n半人马 - 上半身为人，下半身为马的种族\n白泽 - 远古的博识圣兽，能化形为人，据说其知晓天地万物、善恶吉凶\n\n## 鳥系种族\n鸟人 - 拥有翅膀的人形种族，能长距离飞行\n狮鹫族 - 兼具狮身与鹫翼的亚人，是陆地与天空的霸主\n凤凰 - 象征轮回与永生的神鸟，能化形为人，以烈焰重生为天性\n\n## 水生种族\n人鱼 - 能在鱼尾与双足之间切换的水陆两栖亚人\n鱼人 - 双足行走并具大型尾鳍的长生种海洋亚人\n海妖 - 深海中的头足类亚人种\n海蛞蝓族 - 海生软体亚人，具备改变对方性别的独特能力，通过性器剑斗决定生育权\n水母族 - 海洋中的透明软体亚人，通常个体越小毒性越强\n蛙人 - 水陆两栖的蛙型亚人，具有强大的跳跃能力和湿润皮肤\n甲壳族 - 生活于潮间带与浅海的甲壳亚人，体表覆有外骨骼，能随蜕壳进行体型重构\n河童 - 生活于淡水河川的半两栖族群，体表具短鳞与半透明皮肤，兼具鱼、龟、人之特征\n\n## 龙與爬虫种族\n龙族 - 拥有龙族血统的长生亚人，吐息和龙语为其标志\n海龙人 - 外型似龙而非龙，实为海马型卵胎生亚人，雄性负责怀胎与分娩\n蛇人 - 上半身为人，下半身为长蛇躯体的水陆两栖亚人\n蜥蜴人 - 起源于远古龙族分支的水陆两栖亚人，兼具鳞皮防御与温血代谢能力\n龟族 - 披甲而生的卵生亚人，象征稳重与长寿，兼具陆行与水栖能力\n麒麟 - 象征仁德与和平的圣兽，能化形为人，兼具龙族血统与神性之气\n\n## 昆虫种族\n社会虫族 - 以昆虫为基因基底的拟人种族，具有高度社会性，群体协作繁殖\n独居虫族 - 以昆虫为基因基底的拟人种族，独立生存，自我保护意识强\n触手怪 - 外形怪异的种族，以触手为主要器官\n星茧族 - 太空中的虫型亚人\n\n## 植物种族\n植物亚人 - 半人半植物的亚人种族，与自然共生\n真菌亚人 - 以真菌为基底的亚人种，具有菌丝网络和孢子繁殖能力\n\n## 魔法种族\n雪族 - 栖息于极寒地带的哺乳亚人种，体温可根据情感状态变化，雄性称雪怪、雌性称雪女\n夜叉 - 以吞噬业力为生的长生亚人种族，身具角与异色瞳，拥有强烈的繁殖本能与惊人生命力\n魅魔 - 以情欲与魔力维生的种族\n妖精 - 自然元素化形的小型亚人种族\n眼魔 - 以巨大单眼为主体的漂浮亚人，拥有多条长有小眼珠的触手发\n天使 - 具备光环与羽翼的超自然存在\n恶魔 - 魔性凝聚的超自然存在\n奇美拉 - 由多种族血统错乱交融而生的亚人种族，体内基因具高度不稳定性，但仍遵循混合规律\n史莱姆 - 全身透明的拟态魔物\n元素灵 - 由纯粹元素能量凝聚而成的非生物型智慧体，拥有长久的生命周期与可塑形的身躯\n\n## 构造体种族\n石像鬼 - 白天化为石像，夜晚能活动的守护构造体\n附丧神 - 器具长久使用后生成的灵性自我投射\n烛灵 - 以蜡状躯体与燃烧灯芯为生命象征的构造体\n人偶 - 以器物与术式制造的人形构造体\n宝石人 - 由魔力与矿物结晶所诞生的自然构造体生命，身体如晶莹矿石般坚硬闪亮\n奈米丛族 - 由亿级奈米机械单元构成的金属血肉体，本质上是分布式的意识云\n宝箱怪 - 半天然的构造体生命，由货币与贪欲共鸣而生，平时伪装为财宝箱\n\n---\n\n## 物种命名规则\n\n### 1. 转化物种\n转化物种如吸血鬼、魔女、僵尸、鬼(oni)等，则显示为 `[转化]物种`\n- 范例：`[吸血鬼]海妖`、`[魔女]人类`、`[僵尸]兽人`\n\n### 2. 子项物种\n子项物种，例如猫之于兽耳族，鲸鱼之于鱼人，附丧神之于剑灵，显示为 `物种-子物种`\n- 范例：`兽耳族-猫族`、`鱼人-鲸族`、`附丧神-剑灵`\n\n### 3. 混血物种\n混血物种使用 `X` 连接\n- 范例：`人类X精灵`、`天使X恶魔`\n\n### 4. 组合使用\n上述规则可以组合使用\n- 范例：`[吸血鬼]兽耳族-猫族`、`[魔女]人类X精灵`、`兽耳族-狐族X精灵-暗精灵`\n<%_ } _%>","constant":true,"vectorized":false,"selective":true,"selectiveLogic":0,"addMemo":true,"order":500,"position":0,"disable":false,"ignoreBudget":false,"excludeRecursion":true,"preventRecursion":true,"matchPersonaDescription":false,"matchCharacterDescription":false,"matchCharacterPersonality":false,"matchCharacterDepthPrompt":false,"matchScenario":false,"matchCreatorNotes":false,"delayUntilRecursion":false,"probability":100,"useProbability":true,"depth":4,"group":"","groupOverride":false,"groupWeight":100,"scanDepth":null,"caseSensitive":null,"matchWholeWords":null,"useGroupScoring":null,"automationId":"","role":null,"sticky":0,"cooldown":0,"delay":0,"triggers":[],"displayIndex":14,"outletName":"","characterFilter":{"isExclude":false,"names":[],"tags":[]}}}}